(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5],{88984:function(e,t){"use strict";t.Z=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},56532:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var i=n(84725),a=n(28186);function o(e,t){if(i.ZP.svgNodeCache[e]&&i.ZP.svgNodeCache[e][t])return i.ZP.svgNodeCache[e][t].domRef}function r(e,t,n,a){if(!i.ZP.svgNodeCache[t])return null;i.ZP.svgNodeCache[t][a]={touched:!0,domRef:n},e.appendChild(n)}function l(e,t){i.ZP.svgNodeCache[e]&&i.ZP.svgNodeCache[e][t]&&(i.ZP.svgNodeCache[e][t].touched=!0)}function s(e,t){i.ZP.svgNodeCache[t]&&Object.keys(i.ZP.svgNodeCache[t]).forEach(n=>{let a=i.ZP.svgNodeCache[t][n];!a.touched&&a.domRef&&(e.removeChild(a.domRef),delete i.ZP.svgNodeCache[t][n])})}var d=function(e){let t=(0,a.ZP)(e),{viewportId:n,renderingEngineId:d}=t,u=`${n}:${d}`,c=function(e){let t=e.querySelector(".viewport-element"),n=t.querySelector(".svg-layer");return n}(e);return Object.keys(i.ZP.svgNodeCache[u]).forEach(e=>{i.ZP.svgNodeCache[u][e].touched=!1}),{svgLayerElement:c,svgNodeCacheForCanvas:i.ZP.svgNodeCache,getSvgNode:o.bind(this,u),appendNode:r.bind(this,c,u),setNodeTouched:l.bind(this,u),clearUntouched:s.bind(this,c,u)}},u=function(e,t){let n=d(e);t(n),n.clearUntouched()}},11130:function(e,t){"use strict";var n,i;(i=n||(n={})).TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",i.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",i.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",i.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",i.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",i.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",i.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",i.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",i.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",i.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",i.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",i.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",i.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",i.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",i.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",i.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",i.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",i.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",i.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",i.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",i.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",i.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",i.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",i.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",i.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",i.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",i.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",i.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",i.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",i.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",i.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",i.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE",t.default=n},20579:function(e,t){"use strict";var n,i;(i=n||(n={})).Labelmap="LABELMAP",i.Contour="CONTOUR",t.Z=n},14358:function(e,t,n){"use strict";var i,a,o,r;n.d(t,{p:function(){return i},y:function(){return a}}),(o=i||(i={}))[o.Primary=1]="Primary",o[o.Secondary=2]="Secondary",o[o.Primary_And_Secondary=3]="Primary_And_Secondary",o[o.Auxiliary=4]="Auxiliary",o[o.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",o[o.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",o[o.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",o[o.Fourth_Button=8]="Fourth_Button",o[o.Fifth_Button=16]="Fifth_Button",(r=a||(a={}))[r.Shift=16]="Shift",r[r.Ctrl=17]="Ctrl",r[r.Alt=18]="Alt",r[r.Meta=91]="Meta",r[r.ShiftCtrl=1617]="ShiftCtrl",r[r.ShiftAlt=1618]="ShiftAlt",r[r.ShiftMeta=1691]="ShiftMeta",r[r.CtrlAlt=1718]="CtrlAlt",r[r.CtrlMeta=1791]="CtrlMeta",r[r.AltMeta=1891]="AltMeta"},43286:function(e,t){"use strict";var n,i;(i=n||(n={})).Active="Active",i.Passive="Passive",i.Enabled="Enabled",i.Disabled="Disabled",t.default=n},37062:function(e,t,n){"use strict";var i,a;n.d(t,{o:function(){return i}}),(a=i||(i={})).UP="UP",a.DOWN="DOWN",a.LEFT="LEFT",a.RIGHT="RIGHT"},52005:function(e,t,n){"use strict";let i;n.r(t),n.d(t,{AngleTool:function(){return r1},AnnotationTool:function(){return nJ},ArrowAnnotateTool:function(){return rQ},BaseTool:function(){return t6.Z},BidirectionalTool:function(){return rK},BrushTool:function(){return nw},CONSTANTS:function(){return c},CircleROITool:function(){return rq},CircleScissorsTool:function(){return lh},CobbAngleTool:function(){return r3},CrosshairsTool:function(){return rL},DragProbeTool:function(){return re},EllipticalROITool:function(){return rG},Enums:function(){return F},LengthTool:function(){return rT},MIPJumpToClickTool:function(){return rC},MagnifyTool:function(){return r7},PaintFillTool:function(){return lC},PanTool:function(){return o1},PlanarFreehandROITool:function(){return ov},PlanarRotateTool:function(){return rc},ProbeTool:function(){return o7},RectangleROIStartEndThresholdTool:function(){return ig},RectangleROIThresholdTool:function(){return id},RectangleROITool:function(){return il},RectangleScissorsTool:function(){return lu},ReferenceCursors:function(){return lt},ReferenceLines:function(){return rk},ReferenceLinesTool:function(){return rk},ScaleOverlayTool:function(){return la},SegmentationDisplayTool:function(){return lE.Z},SphereScissorsTool:function(){return lg},StackScrollMouseWheelTool:function(){return rf},StackScrollTool:function(){return rs},Synchronizer:function(){return ea},SynchronizerManager:function(){return s},ToolGroupManager:function(){return u},TrackballRotateTool:function(){return o3},Types:function(){return V},VolumeRotateMouseWheelTool:function(){return rv},WindowLevelTool:function(){return ra},ZoomTool:function(){return rr},addTool:function(){return j},annotation:function(){return G},cancelActiveManipulations:function(){return J},cursors:function(){return R},destroy:function(){return $.ob},drawing:function(){return f},init:function(){return $.S1},removeTool:function(){return z},segmentation:function(){return B},state:function(){return q.ZP},synchronizers:function(){return h},utilities:function(){return k}});var a,o,r,l,s={};n.r(s),n.d(s,{createSynchronizer:function(){return eo},destroy:function(){return er},destroySynchronizer:function(){return eu},getAllSynchronizers:function(){return ed},getSynchronizer:function(){return es},getSynchronizersForViewport:function(){return el.Z}});var d={};n.r(d),n.d(d,{hideElementCursor:function(){return eX},initElementCursor:function(){return ez},resetElementCursor:function(){return eY},setElementCursor:function(){return eK}});var u={};n.r(u),n.d(u,{createToolGroup:function(){return e3},destroy:function(){return e8.Z},destroyToolGroup:function(){return e4.Z},getAllToolGroups:function(){return e6},getToolGroup:function(){return e9.Z},getToolGroupForViewport:function(){return e7.Z},getToolGroupsWithToolName:function(){return te.Z}});var c={};n.r(c),n.d(c,{COLOR_LUT:function(){return tt.Z}});var h={};n.r(h),n.d(h,{createCameraPositionSynchronizer:function(){return ta},createStackImageSynchronizer:function(){return tS},createVOISynchronizer:function(){return ts},createZoomPanSynchronizer:function(){return tc}});var f={};n.r(f),n.d(f,{draw:function(){return tD.Z},drawArrow:function(){return tW},drawCircle:function(){return tP},drawEllipse:function(){return tA},drawHandles:function(){return tN},drawLine:function(){return tL},drawLinkedTextBox:function(){return tH},drawPolyline:function(){return tx},drawRect:function(){return tG},drawTextBox:function(){return tk}});var g={};n.r(g),n.d(g,{getActiveSegmentationRepresentation:function(){return nc},setActiveSegmentationRepresentation:function(){return nh}});var m={};n.r(m),n.d(m,{getLockedSegments:function(){return nm},isSegmentIndexLocked:function(){return nf},setSegmentIndexLocked:function(){return ng}});var v={};n.r(v),n.d(v,{getActiveSegmentIndex:function(){return np},setActiveSegmentIndex:function(){return nv}});var p={};n.r(p),n.d(p,{addColorLUT:function(){return nC},getColorForSegmentIndex:function(){return n_},setColorForSegmentIndex:function(){return nT},setColorLUT:function(){return nE}});var C={};n.r(C),n.d(C,{createLabelmapVolumeForViewport:function(){return iS},createMergedLabelmapForIndex:function(){return iE},floodFill:function(){return iy},getBrushSizeForToolGroup:function(){return iP},getBrushThresholdForToolGroup:function(){return iN},getDefaultRepresentationConfig:function(){return iw},isValidRepresentationConfig:function(){return iI},rectangleROIThresholdVolumeByRange:function(){return ip},setBrushSizeForToolGroup:function(){return iM},setBrushThresholdForToolGroup:function(){return iA},thresholdSegmentationByRange:function(){return iL},thresholdVolumeByRange:function(){return ny},triggerSegmentationRender:function(){return iD.ih}});var E={};n.r(E),n.d(E,{getTextBoxCoordsCanvas:function(){return ie}});var _={};n.r(_),n.d(_,{findClosestPoint:function(){return tR},liangBarksyClip:function(){return iZ}});var T={};n.r(T),n.d(T,{getCanvasEllipseCorners:function(){return ni},pointInEllipse:function(){return na}});var I={};n.r(I),n.d(I,{distanceToPoint:function(){return n7},distanceToPointSquared:function(){return n9},intersectLine:function(){return ik}});var w={};n.r(w),n.d(w,{distanceToPoint:function(){return n6}});var b={};n.r(b),n.d(b,{addCanvasPointsToArray:function(){return i$},calculateAreaOfPoints:function(){return ij},getClosestIntersectionWithPolyline:function(){return iV},getFirstIntersectionWithPolyline:function(){return iR},getSubPixelSpacingAndXYDirections:function(){return iB},pointCanProjectOnLine:function(){return iq},pointsAreWithinCloseContourProximity:function(){return iF}});var S={};n.r(S),n.d(S,{distanceToPoint:function(){return iz}});var D={};n.r(D),n.d(D,{ellipse:function(){return T},lineSegment:function(){return I},point:function(){return S},polyline:function(){return b},rectangle:function(){return w},vec2:function(){return _}});var O={};n.r(O),n.d(O,{default:function(){return iJ},filterAnnotationsForDisplay:function(){return nq},filterAnnotationsWithinSlice:function(){return n$},getPointInLineOfSightWithCriteria:function(){return iY},getWorldWidthAndHeightFromCorners:function(){return it}});var y={};n.r(y),n.d(y,{filterViewportsWithFrameOfReferenceUID:function(){return nA},filterViewportsWithParallelNormals:function(){return nU},filterViewportsWithToolEnabled:function(){return nZ},getViewportIdsWithToolToRender:function(){return nk}});var M={};n.r(M),n.d(M,{getOrientationStringLPS:function(){return iQ},invertOrientationStringLPS:function(){return i0}});var P={};n.r(P),n.d(P,{Events:function(){return i2},addToolState:function(){return i3},getToolState:function(){return i4},playClip:function(){return i7},stopClip:function(){return i6}});var A={};n.r(A),n.d(A,{extend2DBoundingBoxInViewAxis:function(){return im},getBoundingBoxAroundShape:function(){return t2}});var N={};n.r(N),n.d(N,{default:function(){return oC},interpolateAnnotation:function(){return op}});var L={};n.r(L),n.d(L,{getBoundsIJKFromRectangleAnnotations:function(){return iv}});var x={};n.r(x),n.d(x,{disable:function(){return oN},enable:function(){return oA},getConfiguration:function(){return oL},setConfiguration:function(){return ox}});var Z={};n.r(Z),n.d(Z,{isViewportPreScaled:function(){return ia},jumpToSlice:function(){return tT},jumpToWorld:function(){return oZ}});var U={};n.r(U),n.d(U,{generateImageFromTimeData:function(){return oV},getDataInTime:function(){return ok}});var k={};n.r(k),n.d(k,{boundingBox:function(){return A},calibrateImageSpacing:function(){return tJ},cine:function(){return P},clip:function(){return tp},debounce:function(){return tj},drawing:function(){return E},dynamicVolume:function(){return U},getAnnotationNearPoint:function(){return tF},getAnnotationNearPointOnEnabledElement:function(){return t$},isObject:function(){return tq},jumpToSlice:function(){return tT},math:function(){return D},orientation:function(){return M},planar:function(){return O},planarFreehandROITool:function(){return N},pointInShapeCallback:function(){return t1},pointInSurroundingSphereCallback:function(){return t3},rectangleROITool:function(){return L},roundNumber:function(){return t4},scroll:function(){return t_},segmentation:function(){return C},stackPrefetch:function(){return x},throttle:function(){return tz},touch:function(){return oU},triggerAnnotationRender:function(){return t0.ZP},triggerAnnotationRenderForViewportIds:function(){return tQ.Z},triggerEvent:function(){return ep.Z},viewport:function(){return Z},viewportFilters:function(){return y}});var R={};n.r(R),n.d(R,{CursorNames:function(){return oG},CursorSVG:function(){return eU},ImageMouseCursor:function(){return ey},MouseCursor:function(){return ew},SVGMouseCursor:function(){return e$},elementCursor:function(){return d},registerCursor:function(){return eR},setCursorForElement:function(){return oH}});var V={};n.r(V);var H={};n.r(H),n.d(H,{getFont:function(){return oW},getState:function(){return nz},style:function(){return eG}});var G={};n.r(G),n.d(G,{FrameOfReferenceSpecificAnnotationManager:function(){return oB.Z},config:function(){return H},locking:function(){return nP},selection:function(){return nj},state:function(){return tB},visibility:function(){return nR}});var W={};n.r(W),n.d(W,{color:function(){return p},getGlobalConfig:function(){return oQ.Hi},getGlobalRepresentationConfig:function(){return oQ.gN},getSegmentSpecificConfig:function(){return oQ.bH},getSegmentationRepresentationSpecificConfig:function(){return oQ.gi},getToolGroupSpecificConfig:function(){return oQ.i},setGlobalConfig:function(){return oQ.Qb},setGlobalRepresentationConfig:function(){return oQ.eu},setSegmentSpecificConfig:function(){return oQ.Pv},setSegmentationRepresentationSpecificConfig:function(){return oQ.Wx},setToolGroupSpecificConfig:function(){return oQ.K0},visibility:function(){return oJ}});var B={};n.r(B),n.d(B,{activeSegmentation:function(){return g},addSegmentationRepresentations:function(){return oX},addSegmentations:function(){return oj},config:function(){return W},removeSegmentationsFromToolGroup:function(){return oF.Z},segmentIndex:function(){return v},segmentLocking:function(){return m},state:function(){return nu},triggerSegmentationEvents:function(){return t8}});var F={};n.r(F),n.d(F,{AnnotationStyleStates:function(){return eD},Events:function(){return e_.default},KeyboardBindings:function(){return ec.y},MouseBindings:function(){return ec.p},SegmentationRepresentations:function(){return iT.Z},Swipe:function(){return l_.o},ToolModes:function(){return K.default}});var $=n(54232),q=n(84725);function j(e){let t=e.toolName,n=void 0!==q.SB.tools[t];if(!t)throw Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw Error(`${t} has already been added globally`);q.SB.tools[t]={toolClass:e}}function z(e){let t=e.toolName;if(!t)throw Error(`No tool found for: ${e.name}`);q.SB.tools[t],delete q.SB.tools[t]}var K=n(43286),Y=n(76007),X=n(14507);function J(e){let t=(0,Y.Z)(e,[K.default.Active,K.default.Passive]),n=(0,X.Z)(e,t);for(let{tool:t}of n){let n=t.cancel(e);if(n)return n}}var Q=n(28186),ee=n(6606),et=n(39040);function en(e,t){return e.findIndex(e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId)}function ei(e,t){return e.some(e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId)}var ea=class{constructor(e,t,n,i){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents||!this._targetViewports.length)return;let t=(0,Q.ZP)(e.currentTarget);if(!t)return;let{renderingEngineId:n,viewportId:i}=t;this._sourceViewports.find(e=>e.viewportId===i)&&this.fireEvent({renderingEngineId:n,viewportId:i},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=i||{},this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(ei(this._sourceViewports,e))return;let{renderingEngineId:t,viewportId:n}=e,{element:i}=(0,ee.Pr)(t).getViewport(n);i.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){ei(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach(e=>this.removeSource(e)),this._targetViewports.forEach(e=>this.removeTarget(e))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){let t=en(this._sourceViewports,e);if(-1===t)return;let n=function(e){let t=(0,ee.Pr)(e.renderingEngineId);if(!t)throw Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}removeTarget(e){let t=en(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return ei(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return ei(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(!this.isDisabled()&&!this._ignoreFiredEvents){this._ignoreFiredEvents=!0;try{for(let n=0;n<this._targetViewports.length;n++){let i=this._targetViewports[n],a=e.viewportId===i.viewportId;a||this._eventHandler(this,e,i,t,this._options)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{this._ignoreFiredEvents=!1}}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){let e=function(e,t){let n=[],i=e.concat(t);for(let e=0;e<i.length;e++){let t=i[e];n.some(e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId)||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach(function(e){let t=(0,ee.Pr)(e.renderingEngineId).getViewport(e.viewportId);if(!t)return;let{element:i}=t;i.removeEventListener(et.default.ELEMENT_DISABLED,n),i.addEventListener(et.default.ELEMENT_DISABLED,n)})}},eo=function(e,t,n,i){let a=q.ZP.synchronizers.some(t=>t.id===e);if(a)throw Error(`Synchronizer with id '${e}' already exists.`);let o=new ea(e,t,n,i);return q.ZP.synchronizers.push(o),o},er=function(){for(;q.ZP.synchronizers.length>0;){let e=q.ZP.synchronizers.pop();e.destroy()}},el=n(6645),es=function(e){return q.ZP.synchronizers.find(t=>t.id===e)},ed=function(){return q.ZP.synchronizers},eu=function(e){let t=q.ZP.synchronizers.findIndex(t=>t.id===e);if(t>-1){let e=q.ZP.synchronizers[t];e.destroy(),q.ZP.synchronizers.splice(t,1)}},ec=n(14358),eh=n(83465),ef=n.n(eh),eg=n(29208),em=n.n(eg),ev=n(78530),ep=n(818),eC=n(74880),eE=n(89985),e_=n(11130);let eT=Symbol("DefinedCursors"),eI=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class ew{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){let{fallback:t}=this;return t instanceof ew?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){let t=eb(ew,eT),n=t.get(e);return n instanceof ew?n:eI.has(e)?(n=new ew(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof ew){let n=eb(ew,eT);return n.set(e,t),!0}return!1}}function eb(e,t){let n=e[t];return n instanceof Map||Object.defineProperty(e,t,{value:n=new Map}),n}let eS=eI.values();(a=r||(r={})).Default="",a.Highlighted="Highlighted",a.Selected="Selected",a.Locked="Locked";var eD=r,eO=n(99103);class ey extends ew{constructor(e,t,n,i,a){super(i||ey.getUniqueInstanceName("image-cursor"),a),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){let{url:e,x:t,y:n}=this,i=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(i+=` ${t} ${n}`),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return`${e}-${eO.Z(ey)}`}}let eM={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:`
    <path stroke="{{color}}" d="M8 16L8 0"></path>
    <path stroke="{{color}}" d="M16 8L0 8"></path>
  `},eP={x:127,y:60},eA=`
<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>
`,eN=`
<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>
<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>
`,eL='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',ex='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',eZ='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',eU={Angle:ek(eM,{iconContent:`<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50
    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23
    10l50 50q10 10 10 23z" />`,viewBox:{x:1792,y:1792}}),ArrowAnnotate:ek(eM,{iconContent:`<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />
  </g>`,viewBox:{x:24,y:24}}),Bidirectional:ek(eM,{iconContent:`<g fill="{{color}}" stroke-width="3" stroke="{{color}}">
    <path d="M27.63 3.21L3.12 28.81"></path>
    <path d="M27.63 15.75L15.27 4.43"></path>
    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>
    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>
    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>
    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>
  </g>`,viewBox:{x:48,y:48}}),CobbAngle:ek(eM,{iconContent:`<g stroke="{{color}}" stroke-width="3">
    <path d="M28.59 2.34L3.82 12.32"></path>
    <path d="M28.59 29.66L3.82 19.68"></path>
    <path stroke-dasharray="2" fill-opacity="0" d="M12.37
      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15
      9.33C13.11 9.24 13.02 9 12.88 8.63">
    </path>
  </g>`,viewBox:{x:32,y:32}}),CircleROI:ek(eM,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:ek(eM,{iconContent:`<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16
    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14
    6.3 30.74 10.54 30.74 15.76Z" />`,viewBox:{x:32,y:32}}),FreehandROI:ek(eM,{iconContent:`<g fill="{{color}}" stroke="{{color}}" stroke-width="2">
    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>
    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>
    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>
    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>
    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>
    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>
    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>
    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>
    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>
    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>
    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>
    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>
    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>
    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>
    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>
    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>
    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>
    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>
    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>
    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>
    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>
    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>
    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>
    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>
    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>
    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>
    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>
    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>
    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>
    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>
  </g>`,viewBox:{x:18,y:18}}),FreehandROISculptor:ek(eM,{iconContent:`<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>
    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>
    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>
    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>
    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>
    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>
    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>
    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>
    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>
    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>
    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>
    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>
    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>
    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>
    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>
    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>
    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>
    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>
    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>
    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>
    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>
    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>
    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>
    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>
    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>
    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>
    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>
    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>
    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>
    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>
    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>
    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>
  </g>`,viewBox:{x:18,y:18}}),Length:ek(eM,{iconContent:`<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">
    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />
  </g>`,viewBox:{x:24,y:24}}),Probe:ek(eM,{iconContent:`<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75
    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73
    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5
    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5
    385.5-103 385.5 103 279.5 279.5 103 385.5z" />`,viewBox:{x:1792,y:1792}}),RectangleROI:ek(eM,{iconContent:`<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47
    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0
    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119
    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />`,viewBox:{x:1792,y:1792}}),TextMarker:ek(eM,{iconContent:`<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0
    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29
    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15
    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5
    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0
    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11
    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0
    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58
    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />`,viewBox:{x:1792,y:1792}}),Crosshairs:ek(eM,{iconContent:`<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26
    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45
    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26
    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5
    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32
    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5
    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26
    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26
    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161
    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161
    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />`,viewBox:{x:1792,y:1792}}),Eraser:ek(eM,{iconContent:`<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15
    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38
    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38
    0 69.5 20.5t47.5 54.5z" />`,viewBox:{x:2048,y:1792}}),Magnify:ek(eM,{iconContent:`<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395
    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5
    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17
    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208
    32s176 78.7 176 176-78.7 176-176 176z" />`,viewBox:{x:512,y:512}}),Pan:ek(eM,{iconContent:`<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17
    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355
    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59
    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12
    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144
    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19
    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />`,viewBox:{x:1792,y:1792}}),Rotate:ek(eM,{iconContent:`<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39
    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5
    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0
    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109
    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298
    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14
    39 17 39 59z" />`,viewBox:{x:1792,y:1792}}),StackScroll:ek(eM,{iconContent:`<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547
    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0
    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547
    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547
    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />`,viewBox:{x:24,y:28}}),WindowLevelRegion:ek(eM,{iconContent:`<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119
    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5
    84.5t84.5 203.5z" />`,viewBox:{x:1792,y:1792}}),WindowLevel:ek(eM,{iconContent:`
    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />
    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />`,viewBox:{x:18,y:18}}),Zoom:ek(eM,{iconContent:`
  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395
    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5
    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17
    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208
    32s176 78.7 176 176-78.7 176-176 176z" />
  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216
    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19
    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26
    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />`,viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:ek(eM,{iconContent:`${eL} ${eA}`,viewBox:eP}),SegmentationFreeHandFillInside:ek(eM,{iconContent:`${eL} ${eN}`,viewBox:eP}),SegmentationFreeHandEraseOutside:ek(eM,{iconContent:`${eL} ${eA}`,viewBox:eP}),SegmentationFreeHandFillOutside:ek(eM,{iconContent:`${eL} ${eN}`,viewBox:eP}),SegmentationRectangleEraseInside:ek(eM,{iconContent:`${ex} ${eA}`,viewBox:eP}),RectangleScissor:ek(eM,{iconContent:`${ex} ${eN}`,viewBox:eP}),"RectangleScissor.FILL_INSIDE":ek(eM,{iconContent:`${ex} ${eN}`,viewBox:eP}),"RectangleScissor.FILL_OUTSIDE":ek(eM,{iconContent:`${ex} ${eN}`,viewBox:eP}),"RectangleScissor.ERASE_OUTSIDE":ek(eM,{iconContent:`${ex} ${eA}`,viewBox:eP}),"RectangleScissor.ERASE_INSIDE":ek(eM,{iconContent:`${ex} ${eA}`,viewBox:eP}),CircleScissor:ek(eM,{iconContent:`${eZ} ${eN}`,viewBox:eP}),"CircleScissor.FILL_INSIDE":ek(eM,{iconContent:`${eZ} ${eN}`,viewBox:eP}),"CircleScissor.ERASE_OUTSIDE":ek(eM,{iconContent:`${eZ} ${eA}`,viewBox:eP}),"CircleScissor.FILL_OUTSIDE":ek(eM,{iconContent:`${eZ} ${eN}`,viewBox:eP})};function ek(e,t){return Object.assign(Object.create(e),t)}function eR(e,t,n){eU[e]=ek(eM,{iconContent:t,viewBox:n})}let eV=Object.keys(eU),eH=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){let{annotationUID:n,viewportId:i,toolGroupId:a,toolName:o}=t;return this._getToolStyle(e,n,i,a,o)}_getToolStyle(e,t,n,i,a){if(t){let n=this.getAnnotationToolStyles(t);if(n&&n[e])return n[e]}if(n){let t=this.getViewportToolStyles(n);if(t){if(t[a]&&t[a][e])return t[a][e];if(t.global&&t.global[e])return t.global[e]}}if(i){let t=this.getToolGroupToolStyles(i);if(t){if(t[a]&&t[a][e])return t[a][e];if(t.global&&t.global[e])return t.global[e]}}let o=this.getDefaultToolStyles();return o[a]&&o[a][e]?o[a][e]:o.global&&o.global[e]?o.global[e]:void 0}_initializeConfig(e){let t={};for(let n in e)t[n]=e[n];this.config={default:{global:t}}}};var eG=eH;function eW(e,t,n,i){let a=function(e,t,n){let i=[`${e}`];return t&&i.push(`${i[0]}${t}`),n&&i.push(`${i[i.length-1]}${n}`),i}(e,n,i);for(let e=a.length-1;e>=0;--e){let n=eG.getStyleProperty(a[e],t);if(void 0!==n)return n}}let eB=eD.Highlighted,eF=K.default.Active;class e$ extends ey{constructor(e,t,n,i,a){super(e,t,n,i,a)}static getDefinedCursor(e,t=!1,n){n||(n=eW("color",{},eB,eF));let i=`${t?"pointer":"cursor"}:${e}/${n}`,a=super.getDefinedCursor(i);if(!a){let o=eU[e];o&&(a=function(e,t,n,i,a){let{x:o,y:r}=e.mousePoint;return new e$(URL.createObjectURL(function(e,t,n){let i=(t?function(e,t){let{iconContent:n,iconSize:i,viewBox:a,mousePointerGroupString:o}=e,r=i/Math.max(a.x,a.y,1),l=16+i,s=`
    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"
      width="${l}" height="${l}" viewBox="0 0 ${l} ${l}">
      <g>${o}</g>
      <g transform="translate(16, 16) scale(${r})">${n}</g>
    </svg>`;return eq(s,t)}:function(e,t){let{iconContent:n,iconSize:i,viewBox:a}=e,o=`
    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"
      width="${i}" height="${i}" viewBox="0 0
      ${a.x} ${a.y}">
      ${n}
    </svg>`;return eq(o,t)})(e,n);return new Blob([i],{type:"image/svg+xml"})}(e,n,{color:i})),o,r,t,a)}(o,i,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(i,a))}return a}}function eq(e,t){let n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,(e,t)=>i(t)?n[t]+"":"")}let ej=Symbol("ElementCursorsMap");function ez(e,t){eJ(e)[0]=t,eK(e,t)}function eK(e,t){let n=eJ(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof ew?t:ew.getDefinedCursor("auto")).getStyleProperty()}function eY(e){eK(e,eJ(e)[1])}function eX(e){eK(e,ew.getDefinedCursor("none"))}function eJ(e){let t=eJ[ej];t instanceof WeakMap||Object.defineProperty(eJ,ej,{value:t=new WeakMap});let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}let{Active:eQ,Passive:e0,Enabled:e1,Disabled:e2}=K.default;class e5{constructor(e){this.viewportsInfo=[],this.toolOptions={},this._toolInstances={},this.id=e}getViewportIds(){return this.viewportsInfo.map(({viewportId:e})=>e)}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){let t=this._toolInstances[e];if(!t){console.warn(`'${e}' is not registered with this toolGroup (${this.id}).`);return}return t}addTool(e,t={}){let n=q.ZP.tools[e],i=this.toolOptions[e];if(!(void 0!==e&&""!==e)){console.warn("Tool with configuration did not produce a toolName: ",t);return}if(!n){console.warn(`'${e}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);return}if(i){console.warn(`'${e}' is already registered for ToolGroup ${this.id}.`);return}let{toolClass:a}=n,o={name:e,toolGroupId:this.id,configuration:t},r=new a(o);this._toolInstances[e]=r}addToolInstance(e,t,n={}){let i=q.ZP.tools[e]?.toolClass;if(!i){let n=q.ZP.tools[t].toolClass;class a extends n{}a.toolName=e,i=a,q.ZP.tools[e]={toolClass:a}}this.addTool(i.toolName,n)}addViewport(e,t){let n=(0,ee.Uu)();if(!t&&n.length>1)throw Error("You must specify a renderingEngineId when there are multiple rendering engines.");let i=t||n[0].id;this.viewportsInfo.some(({viewportId:t})=>t===e)||this.viewportsInfo.push({viewportId:e,renderingEngineId:i});let a=this.getActivePrimaryMouseButtonTool(),o=ev.Z.getRuntimeSettings();o.get("useCursors")&&this.setViewportsCursorByToolName(a)}removeViewports(e,t){let n=[];if(this.viewportsInfo.forEach((i,a)=>{let o=!1;i.renderingEngineId===e&&(o=!0,t&&i.viewportId!==t&&(o=!1)),o&&n.push(a)}),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1)}setActiveStrategy(e,t){let n=this._toolInstances[e];if(void 0===n){console.warn(`Tool ${e} not added to toolGroup, can't set tool configuration.`);return}n.setActiveStrategy(t)}setToolMode(e,t,n={}){if(!e){console.warn("setToolMode: toolName must be defined");return}if(t===K.default.Active){this.setToolActive(e,n);return}if(t===K.default.Passive){this.setToolPassive(e);return}if(t===K.default.Enabled){this.setToolEnabled(e);return}if(t===K.default.Disabled){this.setToolDisabled(e);return}console.warn("setToolMode: mode must be defined")}setToolActive(e,t={}){let n=this._toolInstances[e];if(void 0===n){console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);return}if(!n){console.warn(`'${e}' instance ${n} is not registered with this toolGroup, can't set tool mode.`);return}let i=this.toolOptions[e]?this.toolOptions[e].bindings:[],a=t.bindings?t.bindings:[],o=[...i,...a].reduce((e,t)=>{let n=void 0!==t.numTouchPoints,i=void 0!==t.mouseButton;return!e.some(e=>e.mouseButton===t.mouseButton&&e.modifierKey===t.modifierKey)&&(n||i)&&e.push(t),e},[]);this.toolOptions[e]={bindings:o,mode:eQ},this._toolInstances[e].mode=eQ;let r=ev.Z.getRuntimeSettings(),l=r.get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&l)this.setViewportsCursorByToolName(e);else{let e=this.getActivePrimaryMouseButtonTool();if(!e&&l){let e=ew.getDefinedCursor("default");this._setCursorForViewports(e)}}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();let s={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,ep.Z)(eC.Z,e_.default.TOOL_ACTIVATED,s)}setToolPassive(e){let t=this._toolInstances[e];if(void 0===t){console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);return}let n=this.getToolOptions(e),i=Object.assign({bindings:n?n.bindings:[]},n,{mode:e0}),a=this.getDefaultMousePrimary();i.bindings=i.bindings.filter(e=>e.mouseButton!==a||e.modifierKey);let o=e0;0!==i.bindings.length&&(o=eQ,i.mode=o),this.toolOptions[e]=i,t.mode=o,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports()}setToolEnabled(e){let t=this._toolInstances[e];if(void 0===t){console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);return}this.toolOptions[e]={bindings:[],mode:e1},t.mode=e1,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports()}setToolDisabled(e){let t=this._toolInstances[e];if(void 0===t){console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);return}this.toolOptions[e]={bindings:[],mode:e2},t.mode=e2,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports()}getToolOptions(e){let t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find(e=>{let t=this.toolOptions[e];return t.mode===eQ&&this._hasMousePrimaryButtonBinding(t)})}setViewportsCursorByToolName(e,t){let n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,i;return t&&(n=`${e}.${t}`,i=e$.getDefinedCursor(n,!0))?i:(n=`${e}`,i=e$.getDefinedCursor(n,!0))?i:(n=e,i=e$.getDefinedCursor(n,!0))?i:ew.getDefinedCursor("default")}_setCursorForViewports(e){this.viewportsInfo.forEach(({renderingEngineId:t,viewportId:n})=>{let i=(0,Q.O)(n,t);if(!i)return;let{viewport:a}=i;ez(a.element,e)})}setToolConfiguration(e,t,n){let i;return void 0===this._toolInstances[e]?(console.warn(`Tool ${e} not present, can't set tool configuration.`),!1):(i=n?t:eE.Z(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=i,this._renderViewports(),!0)}getDefaultMousePrimary(){return ec.p.Primary}getToolConfiguration(e,t){if(void 0===this._toolInstances[e]){console.warn(`Tool ${e} not present, can't set tool configuration.`);return}let n=em()(this._toolInstances[e].configuration,t);return ef()(n)}_hasMousePrimaryButtonBinding(e){let t=this.getDefaultMousePrimary();return e?.bindings?.some(e=>e.mouseButton===t&&void 0===e.modifierKey)}_renderViewports(){this.viewportsInfo.forEach(({renderingEngineId:e,viewportId:t})=>{(0,ee.Pr)(e).renderViewport(t)})}}var e3=function(e){let t=q.ZP.toolGroups.some(t=>t.id===e);if(t){console.warn(`'${e}' already exists.`);return}let n=new e5(e);return q.ZP.toolGroups.push(n),n},e4=n(38673),e8=n(21465),e9=n(51324),e7=n(3971),e6=function(){return q.ZP.toolGroups},te=n(96502),tt=n(88984);function tn(e,t,n,i){let{camera:a}=i.detail,o=(0,ee.Pr)(n.renderingEngineId);if(!o)throw Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);let r=o.getViewport(n.viewportId);r.setCamera(a),r.render()}let{CAMERA_MODIFIED:ti}=et.default;function ta(e){let t=eo(e,ti,tn);return t}var to=n(1771),tr=n(16502);function tl(e,t,n,i,a){let o=i.detail,{volumeId:r,range:l,invertStateChanged:s,invert:d}=o,u=(0,ee.Pr)(n.renderingEngineId);if(!u)throw Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);let c=u.getViewport(n.viewportId),h={voiRange:l};if(a.syncInvertState&&s&&(h.invert=d),c instanceof to.Z)c.setProperties(h,r);else if(c instanceof tr.Z)c.setProperties(h);else throw Error("Viewport type not supported.");c.render()}function ts(e,t={syncInvertState:!0}){let n=eo(e,et.default.VOI_MODIFIED,tl,t);return n}function td(e,t,n){let i=(0,ee.Pr)(n.renderingEngineId);if(!i)throw Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);let a=e.getOptions(n.viewportId),o=i.getViewport(n.viewportId),r=i.getViewport(t.viewportId);if(a?.syncZoom!==!1){let e=r.getZoom();o.setZoom(e)}if(a?.syncPan!==!1){let e=r.getPan();o.setPan(e)}o.render()}let{CAMERA_MODIFIED:tu}=et.default;function tc(e){let t=eo(e,tu,td);return t}var th=n(77160),tf=n(88315),tg=n(44241),tm=n(65195),tv=n(65717),tp=function(e,t,n){return Math.min(Math.max(t,e),n)},tC=n(99698),tE=n(32045);function t_(e,t){let n=(0,Q.ZP)(e.element);if(!n)throw Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof tr.Z&&0===e.getImageIds().length)throw Error("Scroll::Stack Viewport has no images");let{type:i}=e,{volumeId:a,delta:o}=t;if(e instanceof tr.Z)e.scroll(o,t.debounceLoading,t.loop);else if(e instanceof tm.Z)!function(e,t,n){let{numScrollSteps:i,currentStepIndex:a,sliceRangeInfo:o}=tC.Z(e,t);if(!o)return;let{sliceRange:r,spacingInNormalDirection:l,camera:s}=o,{focalPoint:d,viewPlaneNormal:u,position:c}=s,{newFocalPoint:h,newPosition:f}=tE.Z(d,c,r,u,l,n);e.setCamera({focalPoint:h,position:f}),e.render();let g=a+n;if((g>i||g<0)&&e.getCurrentImageId()){let o={volumeId:t,viewport:e,delta:n,desiredStepIndex:g,currentStepIndex:a,numScrollSteps:i,currentImageId:e.getCurrentImageId()};ep.Z(eC.Z,et.default.VOLUME_SCROLL_OUT_OF_BOUNDS,o)}}(e,a,o);else throw Error(`Not implemented for Viewport Type: ${i}`)}var tT=async function(e,t={}){let{imageIndex:n,debounceLoading:i,volumeId:a}=t,o=(0,Q.ZP)(e);if(!o)throw Error("Element has been disabled");let{viewport:r}=o,{imageIndex:l,numberOfSlices:s}=function(e,t){if(e instanceof tr.Z)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof tm.Z)return tv.Z(e);throw Error("Unsupported viewport type")}(r,i),d=tp(n,0,s-1);t_(r,{delta:d-l,debounceLoading:i,volumeId:a})};async function tI(e,t,n){let i=(0,ee.Pr)(n.renderingEngineId);if(!i)throw Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);let a=i.getViewport(t.viewportId),o=i.getViewport(n.viewportId),r=a.getFrameOfReferenceUID(),l=o.getFrameOfReferenceUID(),s=a.getCurrentImageId(),d=tf.get("imagePlaneModule",s),u=d.imagePositionPatient,c=o.getImageIds();if(function(e,t){let{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),a=th.dot(n,i);return Math.abs(a)>.9}(a,o)){if(r===l){let e=tw(u,c);if(-1!==e.index&&o.getCurrentImageIdIndex()!==e.index){await tT(o.element,{imageIndex:e.index});return}}else{let e=tg.Z.get("spatialRegistrationModule",[n.viewportId,t.viewportId]);if(!e)throw Error(`No registration matrix found for sourceViewport: ${t.viewportId} and targetViewport: ${n.viewportId}, viewports with different frameOfReferenceUIDs must have a registration matrix in the registrationMetadataProvider. Use calculateViewportsRegistrationMatrix to calculate the matrix.`);let i=th.transformMat4(th.create(),u,e),a=tw(i,c);-1!==a.index&&o.getCurrentImageIdIndex()!==a.index&&await tT(o.element,{imageIndex:a.index})}}}function tw(e,t){return t.reduce((t,n,i)=>{let{imagePositionPatient:a}=tf.get("imagePlaneModule",n),o=th.distance(a,e);return o<t.distance?{distance:o,index:i}:t},{distance:1/0,index:-1})}let{STACK_NEW_IMAGE:tb}=et.default;function tS(e){let t=eo(e,tb,tI);return t}var tD=n(56532),tO=function(e,t,n){return`${e}::${t}::${n}`},ty=function(e,t){Object.keys(e).forEach(n=>{let i=t.getAttribute(n),a=e[n];void 0===a||""===a?t.removeAttribute(n):i!==a&&t.setAttribute(n,a)})},tM=function(e,t){Object.keys(e).forEach(n=>{let i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)})},tP=function(e,t,n,i,a,o={},r=""){let{color:l,fill:s,width:d,lineWidth:u,lineDash:c}=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0},o),h=tO(t,"circle",n),f=e.getSvgNode(h),g={cx:`${i[0]}`,cy:`${i[1]}`,r:`${a}`,stroke:l,fill:s,"stroke-width":u||d,"stroke-dasharray":c};if(f)ty(g,f),e.setNodeTouched(h);else{let t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==r&&t.setAttribute("data-id",r),tM(g,t),e.appendNode(t,h)}},tA=function(e,t,n,i,a,o={},r=""){let{color:l,width:s,lineWidth:d,lineDash:u}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},o),c=tO(t,"ellipse",n),h=e.getSvgNode(c),f=Math.abs(i[0]-a[0]),g=Math.abs(i[1]-a[1]),m=Math.min(i[0],a[0]),v=Math.min(i[1],a[1]),p=[m+f/2,v+g/2],C={cx:`${p[0]}`,cy:`${p[1]}`,rx:`${f/2}`,ry:`${g/2}`,stroke:l,fill:"transparent","stroke-width":d||s,"stroke-dasharray":u};if(h)ty(C,h),e.setNodeTouched(c);else{let t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==r&&t.setAttribute("data-id",r),tM(C,t),e.appendNode(t,c)}},tN=function(e,t,n,i,a={}){let{color:o,handleRadius:r,width:l,lineWidth:s,fill:d,type:u,opacity:c}=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},a),h=s||l;for(let a=0;a<i.length;a++){let l;let s=i[a],f=tO(t,"handle",`hg-${n}-index-${a}`);if("circle"===u)l={cx:`${s[0]}`,cy:`${s[1]}`,r:r,stroke:o,fill:d,"stroke-width":h,opacity:c};else if("rect"===u){let e=parseFloat(r),t=1.5*e,n=s[0]-.5*t,i=s[1]-.5*t;l={x:`${n}`,y:`${i}`,width:`${t}`,height:`${t}`,stroke:o,fill:d,"stroke-width":h,rx:`${.1*t}`,opacity:c}}else throw Error(`Unsupported handle type: ${u}`);let g=e.getSvgNode(f);if(g)ty(l,g),e.setNodeTouched(f);else{let t=document.createElementNS("http://www.w3.org/2000/svg",u);tM(l,t),e.appendNode(t,f)}}};function tL(e,t,n,i,a,o={},r=""){if(isNaN(i[0])||isNaN(i[1])||isNaN(a[0])||isNaN(a[1]))return;let{color:l,width:s,lineWidth:d,lineDash:u,shadow:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},o),h=tO(t,"line",n),f=e.getSvgNode(h),g=c?`filter:url(#shadow-${e.svgLayerElement.id});`:"",m={x1:`${i[0]}`,y1:`${i[1]}`,x2:`${a[0]}`,y2:`${a[1]}`,stroke:l,style:g,"stroke-width":d||s,"stroke-dasharray":u};if(f)ty(m,f),e.setNodeTouched(h);else{let t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==r&&t.setAttribute("data-id",r),tM(m,t),e.appendNode(t,h)}}function tx(e,t,n,i,a){if(i.length<2)return;let{color:o,width:r,lineWidth:l,lineDash:s}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},a),d=tO(t,"polyline",n),u=e.getSvgNode(d),c="";for(let e of i)c+=`${e[0]}, ${e[1]} `;if(a.connectLastToFirst){let e=i[0];c+=`${e[0]}, ${e[1]}`}let h={points:c,stroke:o,fill:"none","stroke-width":l||r,"stroke-dasharray":s};if(u)ty(h,u),e.setNodeTouched(d);else{let t=document.createElementNS("http://www.w3.org/2000/svg","polyline");tM(h,t),e.appendNode(t,d)}}function tZ(e){let t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function tU(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||((n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("class","background"),e.insertBefore(n,e.firstChild));let i=e.getBBox(),a={x:`${i.x}`,y:`${i.y}`,width:`${i.width}`,height:`${i.height}`,fill:t};return ty(a,n),i}var tk=function(e,t,n,i,a,o={}){let r=Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},o),l=function(e,t,n,i=[""],a,o){let r;let{padding:l,color:s,fontFamily:d,fontSize:u,background:c}=o,[h,f]=[a[0]+l,a[1]+l],g=tO(t,"text",n),m=e.getSvgNode(g);if(m){let t=m.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){let t=n[e],a=i[e]||"";t.textContent=a}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){let a=i[e+n.length],o=tZ(a);t.appendChild(o)}m.appendChild(t),e.appendNode(m,g)}let a={transform:`translate(${h} ${f})`};ty({fill:s,"font-size":u,"font-family":d},t),ty(a,m),r=tU(m,c),e.setNodeTouched(g)}else{let t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("transform",`translate(${h} ${f})`);let n=function(e,t){let{color:n,fontFamily:i,fontSize:a}=t,o=document.createElementNS("http://www.w3.org/2000/svg","text"),r=`filter:url(#shadow-${e.svgLayerElement.id});`,l=`user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);${r}`;return o.setAttribute("x","0"),o.setAttribute("y","0"),o.setAttribute("fill",n),o.setAttribute("font-family",i),o.setAttribute("font-size",a),o.setAttribute("style",l),o}(e,o);for(let e=0;e<i.length;e++){let t=i[e],a=tZ(t);n.appendChild(a)}t.appendChild(n),e.appendNode(t,g),r=tU(t,c)}return Object.assign({},r,{x:h,y:f,height:r.height+l,width:r.width+l})}(e,t,n,i,a,r);return l};function tR(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach(function(e){let a=function(e,t){let[n,i]=e,[a,o]=t;return Math.sqrt(Math.pow(n-a,2)+Math.pow(i-o,2))}(t,e);a<i&&(i=a,n=[...e])}),n}var tV=function(e,t,n,i,a,o,r={}){let l=i.length>0?tR(i,a):a,s=function(e){let{x:t,y:n,height:i,width:a}=e,o=a/2,r=i/2;return[[t+o,n],[t,n+r],[t+o,n+i],[t+a,n+r]]}(o),d=tR(s,l),u=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},r);tL(e,t,`link-${n}`,l,d,u)},tH=function(e,t,n,i,a,o,r,l={}){let s=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},l),d=tk(e,t,n,i,a,s);return tV(e,t,n,o,a,d,s),d};function tG(e,t,n,i,a,o={},r=""){let{color:l,width:s,lineWidth:d,lineDash:u}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},o),c=tO(t,"rect",n),h=e.getSvgNode(c),f=[Math.min(i[0],a[0]),Math.min(i[1],a[1])],g=Math.abs(i[0]-a[0]),m=Math.abs(i[1]-a[1]),v={x:`${f[0]}`,y:`${f[1]}`,width:`${g}`,height:`${m}`,stroke:l,fill:"transparent","stroke-width":d||s,"stroke-dasharray":u};if(h)ty(v,h),e.setNodeTouched(c);else{let t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==r&&t.setAttribute("data-id",r),tM(v,t),e.appendNode(t,c)}}function tW(e,t,n,i,a,o={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(a[0])||isNaN(a[1]))return;let{color:r,width:l,lineWidth:s,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},o);tL(e,t,n,i,a,{color:r,width:l,lineWidth:s,lineDash:d});let u=Math.atan2(a[1]-i[1],a[0]-i[0]),c={start:[a[0]-10*Math.cos(u-Math.PI/7),a[1]-10*Math.sin(u-Math.PI/7)],end:a},h={start:[a[0]-10*Math.cos(u+Math.PI/7),a[1]-10*Math.sin(u+Math.PI/7)],end:a};tL(e,t,"2",c.start,c.end,{color:r,width:l,lineWidth:s}),tL(e,t,"3",h.start,h.end,{color:r,width:l,lineWidth:s})}var tB=n(53323);function tF(e,t,n=5){let i=(0,Q.ZP)(e);if(!i)throw Error("getAnnotationNearPoint: enabledElement not found");return t$(i,t,n)}function t$(e,t,n){let{renderingEngineId:i,viewportId:a}=e,o=e7.Z(a,i);if(!o)return null;let{_toolInstances:r}=o;for(let i in r){let a=function(e,t,n,i){let{viewport:a}=t,o=(0,tB.getAnnotations)(e.constructor.toolName,a?.element),r=a?.getCurrentImageId?.();if(o?.length){let{element:a}=t.viewport;for(let t of o){let o=t.metadata?.referencedImageId;if((!r||!o||r===o)&&e.isPointNearTool&&(e.isPointNearTool(a,t,n,i,"")||e.getHandleNearImagePoint(a,t,n,i)))return t}}return null}(r[i],e,t,n);if(a)return a}return null}var tq=function(e){let t=typeof e;return null!==e&&("object"===t||"function"===t)},tj=function(e,t,n){let i,a,o,r,l,s;let d=0,u=!1,c=!1,h=!0,f=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw TypeError("Expected a function");function g(t){let n=i,o=a;return i=a=void 0,d=t,r=e.apply(o,n)}function m(e,t){return f?window.requestAnimationFrame(e):setTimeout(e,t)}function v(e){let n=e-s,i=e-d;return void 0===s||n>=t||n<0||c&&i>=o}function p(){let e=Date.now();if(v(e))return C(e);l=m(p,function(e){let n=e-s,i=e-d,a=t-n;return c?Math.min(a,o-i):a}(e))}function C(e){return(l=void 0,h&&i)?g(e):(i=a=void 0,r)}function E(...e){let n=Date.now(),o=v(n);if(i=e,a=this,s=n,o){if(void 0===l){var h;return d=h=s,l=m(p,t),u?g(h):r}if(c)return l=m(p,t),g(s)}return void 0===l&&(l=m(p,t)),r}return t=Number(t)||0,tq(n)&&(u=!!n.leading,o=(c="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):o,h="trailing"in n?!!n.trailing:h),E.cancel=function(){void 0!==l&&function(e){if(f)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),d=0,i=s=a=l=void 0},E.flush=function(){return void 0===l?r:C(Date.now())},E.pending=function(){return void 0!==l},E},tz=function(e,t,n){let i=!0,a=!0;if("function"!=typeof e)throw TypeError("Expected a function");return tq(n)&&(i="leading"in n?!!n.leading:i,a="trailing"in n?!!n.trailing:a),tj(e,t,{leading:i,trailing:a,maxWait:t})},tK=n(57971),tY=n(45149);let{calibratedPixelSpacingMetadataProvider:tX}=tK;function tJ(e,t,n){"number"==typeof n&&(n={type:tY.Z.USER,scale:n}),tX.add(e,n);let i=t.getStackViewports();i.forEach(t=>{let n=t.getImageIds();n.includes(e)&&t.calibrateSpacing(e)})}var tQ=n(76056),t0=n(94268);function t1(e,t,n,i){let a,o,r,l,s,d,u;u=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();let c=e.getDimensions();i?[[a,o],[r,l],[s,d]]=i:(a=0,o=c[0],r=0,l=c[1],s=0,d=c[2]);let h=th.fromValues(a,r,s),f=e.getDirection(),g=f.slice(0,3),m=f.slice(3,6),v=f.slice(6,9),p=e.getSpacing(),[C,E,_]=p,T=e.indexToWorld(h),I=th.fromValues(g[0]*C,g[1]*C,g[2]*C),w=th.fromValues(m[0]*E,m[1]*E,m[2]*E),b=th.fromValues(v[0]*_,v[1]*_,v[2]*_),S=c[0],D=c[0]*c[1];for(let e=s;e<=d;e++)for(let i=r;i<=l;i++)for(let l=a;l<=o;l++){let o=[l,i,e],d=l-a,c=i-r,h=e-s,f=[T[0]+d*I[0]+c*w[0]+h*b[0],T[1]+d*I[1]+c*w[1]+h*b[1],T[2]+d*I[2]+c*w[2]+h*b[2]];if(t(f,o)){let t=e*D+i*S+l,a=u[t];n({value:a,index:t,pointIJK:o,pointLPS:f})}}}var t2=function(e,t){let n=1/0,i=0,a=1/0,o=0,r=1/0,l=0;if(e.forEach(e=>{n=Math.min(e[0],n),i=Math.max(e[0],i),a=Math.min(e[1],a),o=Math.max(e[1],o),r=Math.min(e[2],r),l=Math.max(e[2],l)}),n=Math.floor(n),i=Math.floor(i),a=Math.floor(a),o=Math.floor(o),r=Math.floor(r),l=Math.floor(l),t){let[e,s,d]=t;n=Math.max(0,n),i=Math.min(e-1,i),a=Math.max(0,a),o=Math.min(s-1,o),r=Math.max(0,r),l=Math.min(d-1,l)}return[[n,i],[a,o],[r,l]]};let{transformWorldToIndex:t5}=tK;function t3(e,t,n,i){let{boundsIJK:a,centerWorld:o,radiusWorld:r}=function(e,t,n){let[i,a]=e,o=th.fromValues((i[0]+a[0])/2,(i[1]+a[1])/2,(i[2]+a[2])/2),r=th.distance(i,a)/2;if(!n){let e=t5(t,o),n=t.getSpacing(),i=Math.ceil(r/Math.min(...n));return{boundsIJK:[[e[0]-i,e[0]+i],[e[1]-i,e[1]+i],[e[2]-i,e[2]+i]],centerWorld:o,radiusWorld:r}}return{boundsIJK:function(e,t,n,i,a){let[o,r]=n,l=e.getDimensions(),s=t.getCamera(),d=th.fromValues(s.viewUp[0],s.viewUp[1],s.viewUp[2]),u=th.fromValues(s.viewPlaneNormal[0],s.viewPlaneNormal[1],s.viewPlaneNormal[2]),c=th.create();th.cross(c,d,u);let h=th.create(),f=th.create();th.scaleAndAdd(h,r,u,a),th.scaleAndAdd(f,o,u,-a),th.scaleAndAdd(h,h,c,-a),th.scaleAndAdd(f,f,c,a);let g=[t5(e,h),t5(e,f)],m=t2(g,l);return m}(t,n,e,0,r),centerWorld:o,radiusWorld:r}}(t,e,i),l={center:o,radius:r};t1(e,e=>(function(e,t){let{center:n,radius:i}=e;return(t[0]-n[0])**2+(t[1]-n[1])**2+(t[2]-n[2])**2<=i**2})(l,e),n,a)}var t4=function(e,t=2){if(null==e||""===e)return"NaN";if((e=Number(e))<1e-4)return`${e}`;let n=e>=100?t-2:e>=10?t-1:e>=1?t:e>=.1?t+1:e>=.01?t+2:e>=.001?t+3:t+4;return e.toFixed(n)},t8=n(49936),t9=n(84870),t7=n(82864),t6=n(3573);function ne(e,t){!function(e,t,n=!0){let{viewport:i}=e,{volume:a,segmentsLocked:o,segmentIndex:r,segmentationId:l,points:s}=t,{imageData:d,dimensions:u}=a,c=a.getScalarData(),h=[];t3(d,[s[0],s[1]],({index:e,value:t})=>{o.includes(t)||(c[e]=r,h.push(e))},i);let f=u[0]*u[1],g=Math.floor(h[0]/f),m=Math.floor(h[h.length-1]/f),v=Array.from({length:m-g+1},(e,t)=>t+g);(0,t8.triggerSegmentationDataModified)(l,v)}(e,t,!0)}function nt(e,t){let n=Object.assign({},t,{segmentIndex:0});ne(e,n)}var nn=n(636);function ni(e){let[t,n,i,a]=e,o=[i[0],n[1]],r=[a[0],t[1]];return[o,r]}function na(e,t){let{center:n,xRadius:i,yRadius:a,zRadius:o}=e,[r,l,s]=t,[d,u,c]=n,h=0;return 0!==i&&(h+=(r-d)*(r-d)/(i*i)),0!==a&&(h+=(l-u)*(l-u)/(a*a)),0!==o&&(h+=(s-c)*(s-c)/(o*o)),h<=1}let{transformWorldToIndex:no}=tK;function nr(e,t,n=!1){let{volume:i,imageVolume:a,points:o,segmentsLocked:r,segmentIndex:l,segmentationId:s,strategySpecificConfiguration:d}=t,{imageData:u,dimensions:c}=i,h=i.getScalarData(),{viewport:f}=e,g=th.fromValues(0,0,0);o.forEach(e=>{th.add(g,g,e)}),th.scale(g,g,1/o.length);let m=o.map(e=>f.worldToCanvas(e)),[v,p]=ni(m),C=f.canvasToWorld(v),E=f.canvasToWorld(p),_=[no(u,C),no(u,E)],T=t2(_,c),I={center:g,xRadius:Math.abs(C[0]-E[0])/2,yRadius:Math.abs(C[1]-E[1])/2,zRadius:Math.abs(C[2]-E[2])/2},w=new Set;t1(u,(e,t)=>na(I,e),n?({value:e,index:t,pointIJK:n})=>{!r.includes(e)&&function(e,t,n){let{THRESHOLD_INSIDE_CIRCLE:i}=n,a=t.getScalarData()[e],{threshold:o}=i;return o[0]<=a&&a<=o[1]}(t,a,d)&&(h[t]=l,w.add(n[2]))}:({value:e,index:t,pointIJK:n})=>{r.includes(e)||(h[t]=l,w.add(n[2]))},T);let b=Array.from(w);(0,t8.triggerSegmentationDataModified)(s,b)}function nl(e,t){nr(e,t,!1)}function ns(e,t){let{volume:n,imageVolume:i}=t;if(!nn.Z(n.dimensions,i.dimensions)||!nn.Z(n.direction,i.direction))throw Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");nr(e,t,!0)}function nd(e,t){let n={...t,segmentIndex:0};nl(e,n)}var nu=n(63008);function nc(e){let t=(0,nu.getDefaultSegmentationStateManager)(),n=t.getSegmentationRepresentations(e);if(!n)return;let i=n.find(e=>e.active);return i}function nh(e,t){let n=(0,nu.getDefaultSegmentationStateManager)();n.setActiveSegmentationRepresentation(e,t),(0,t8.triggerSegmentationRepresentationModified)(e,t)}function nf(e,t){let n=(0,nu.getSegmentation)(e);if(!n)throw Error(`No segmentation state found for ${e}`);let{segmentsLocked:i}=n;return i.has(t)}function ng(e,t,n=!0){let i=(0,nu.getSegmentation)(e);if(!i)throw Error(`No segmentation state found for ${e}`);let{segmentsLocked:a}=i;n?a.add(t):a.delete(t),(0,t8.triggerSegmentationModified)(e)}function nm(e){let t=(0,nu.getSegmentation)(e);if(!t)throw Error(`No segmentation state found for ${e}`);let{segmentsLocked:n}=t;return Array.from(n)}function nv(e,t){let n=(0,nu.getSegmentation)(e);n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,(0,t8.triggerSegmentationModified)(e))}function np(e){let t=(0,nu.getSegmentation)(e);if(t)return t.activeSegmentIndex}function nC(e,t){if(!e)throw Error("addColorLUT: colorLUT is required");nn.Z(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),nu.addColorLUT(e,t)}function nE(e,t,n){let i=nu.getSegmentationRepresentationByUID(e,t);if(!i)throw Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!nu.getColorLUT(n))throw Error(`setColorLUT: could not find colorLUT with index ${n}`);i.colorLUTIndex=n,(0,t8.triggerSegmentationRepresentationModified)(e,t)}function n_(e,t,n){let i=nu.getSegmentationRepresentationByUID(e,t);if(!i)throw Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);let{colorLUTIndex:a}=i,o=nu.getColorLUT(a);return o[n]}function nT(e,t,n,i){let a=n_(e,t,n);for(let e=0;e<i.length;e++)a[e]=i[e];(0,t8.triggerSegmentationRepresentationModified)(e,t)}class nI extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:nl,THRESHOLD_INSIDE_CIRCLE:ns,ERASE_INSIDE_CIRCLE:nd,FILL_INSIDE_SPHERE:ne,ERASE_INSIDE_SPHERE:nt},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}}){super(e,t),this.onSetToolPassive=()=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=()=>{this.disableCursor()},this.preMouseDownCallback=e=>{let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{viewport:a,renderingEngine:o}=i;if(a instanceof tr.Z)throw Error("Not implemented yet");let r=this.toolGroupId,l=nc(r);if(!l)throw Error("No active segmentation detected, create one before using the brush tool");let{segmentationId:s,type:d}=l,u=nm(s),{representationData:c}=nu.getSegmentation(s),{volumeId:h}=c[d],f=t7.ZP.getVolume(h),g=a.getActors()[0].uid,m=t7.ZP.getVolume(g),v=[a.id];return this._editData={segmentation:f,imageVolume:m,segmentsLocked:u},this._activateDraw(n),eX(n),e.preventDefault(),(0,tQ.Z)(o,v),!0},this.mouseMoveCallback=e=>{this.mode===K.default.Active&&this.updateCursor(e)},this._dragCallback=e=>{let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{renderingEngine:a}=i,{imageVolume:o,segmentation:r,segmentsLocked:l}=this._editData;this.updateCursor(e);let{segmentIndex:s,segmentationId:d,segmentationRepresentationUID:u,brushCursor:c,viewportIdsToRender:h}=this._hoverData,{data:f}=c,{viewPlaneNormal:g,viewUp:m}=c.metadata;(0,tQ.Z)(a,h);let v={points:f.handles.points,volume:r,imageVolume:o,segmentIndex:s,segmentsLocked:l,viewPlaneNormal:g,toolGroupId:this.toolGroupId,segmentationId:d,segmentationRepresentationUID:u,viewUp:m,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(i,v)},this._endCallback=e=>{let t=e.detail,{element:n}=t,{imageVolume:i,segmentation:a,segmentsLocked:o}=this._editData,{segmentIndex:r,segmentationId:l,segmentationRepresentationUID:s,brushCursor:d}=this._hoverData,{data:u}=d,{viewPlaneNormal:c,viewUp:h}=d.metadata;this._deactivateDraw(n),eY(n);let f=(0,Q.ZP)(n),{viewport:g}=f;if(this._editData=null,this.updateCursor(e),g instanceof tr.Z)throw Error("Not implemented yet");let m={points:u.handles.points,volume:a,imageVolume:i,segmentIndex:r,segmentsLocked:o,viewPlaneNormal:c,toolGroupId:this.toolGroupId,segmentationId:l,segmentationRepresentationUID:s,viewUp:h,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration};this.applyActiveStrategy(f,m)},this._activateDraw=e=>{e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0}updateCursor(e){let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,Q.ZP)(n),{renderingEngine:r,viewport:l}=o,s=l.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.toolGroupId,h=nc(c);if(!h){console.warn("No active segmentation detected, create one before using the brush tool");return}let{segmentationRepresentationUID:f,segmentationId:g}=h,m=np(g),v=n_(c,f,m),p=[l.id],C={metadata:{viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:v},data:{}};this._hoverData={brushCursor:C,centerCanvas:a,segmentIndex:m,segmentationId:g,segmentationRepresentationUID:f,segmentColor:v,viewportIdsToRender:p},this._calculateCursor(n,a),(0,tQ.Z)(r,p)}_calculateCursor(e,t){let n=(0,Q.ZP)(e),{viewport:i}=n,{canvasToWorld:a}=i,{brushSize:o}=this.configuration,r=[t[0],t[1]+o],l=[t[0],t[1]-o],s=[t[0]-o,t[1]],d=[t[0]+o,t[1]],{brushCursor:u}=this._hoverData,{data:c}=u;void 0===c.handles&&(c.handles={}),c.handles.points=[a(r),a(l),a(s),a(d)],c.invalidated=!1}invalidateBrushCursor(){if(void 0!==this._hoverData){let{data:e}=this._hoverData.brushCursor;e.invalidated=!0}}renderAnnotation(e,t){if(!this._hoverData)return;let{viewport:n}=e,i=this._hoverData.viewportIdsToRender;if(!i.includes(n.id))return;let a=this._hoverData.brushCursor;if(!0===a.data.invalidated){let{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}let o=a.metadata,r=o.brushCursorUID,l=a.data,{points:s}=l.handles,d=s.map(e=>n.worldToCanvas(e)),u=d[0],c=d[1],h=[Math.floor((u[0]+c[0])/2),Math.floor((u[1]+c[1])/2)],f=Math.abs(u[1]-Math.floor((u[1]+c[1])/2)),g=`rgb(${o.segmentColor.slice(0,3)})`;if(!n.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");return}tP(t,r,"0",h,f,{color:g})}}nI.toolName="Brush";var nw=nI;function nb(e){let t=(0,e9.Z)(e);if(void 0===t)return;let n=t._toolInstances;if(!Object.keys(n).length)return;let i=Object.values(n).filter(e=>e instanceof nw);return i}let nS=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function nD(e,t,n,i){let a=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let o=0;o<2;o++)i[0]=i[0]+(2*e-1)*n[0]/2,i[1]=i[1]+(2*t-1)*n[1]/2,i[2]=i[2]+(2*o-1)*n[2]/2,a.push(i);let o=a.map(t=>t9.Z(e,t)),r=t2(o,t);return r}function nO(e,t){let{spacing:n,imageData:i}=e,a=e.getScalarData(),o=[],r=0;for(let e=0;e<t.length;e++){let{imageData:i,spacing:l,dimensions:s}=t[e].volume,d=t[e].volume.getScalarData().length;d===a.length&&nS(l,n)&&(r=e);let u=i.getPointData().getScalars().getData(),c=t[e].lower,h=t[e].upper;o.push({imageData:i,referenceValues:u,lower:c,upper:h,spacing:l,dimensions:s,volumeSize:d})}return{volumeInfoList:o,baseVolumeIdx:r}}var ny=function(e,t,n){let i,a,o;let{imageData:r}=e,l=e.getScalarData(),{overwrite:s,boundsIJK:d}=n,u=n?.overlapType||0;if(s)for(let e=0;e<l.length;e++)l[e]=0;let{baseVolumeIdx:c,volumeInfoList:h}=nO(e,t),f=(e,t,n)=>{let{imageData:r,dimensions:l,lower:s,upper:d}=e,c=nD(r,l,t,n);a=0,i=0,o={lower:s,upper:d};let h=!1;return t1(r,()=>!0,({value:e})=>{a+=1,e>=o.lower&&e<=o.upper&&(i+=1)},c),0===u?h=i>0:1==u&&(h=i===a),h},g=(e,t)=>{let{imageData:n,referenceValues:i,lower:a,upper:o}=e,r=n.computeOffsetIndex(t),l=i[r];return!(l<=a)&&!(l>=o)};return t1(r,()=>!0,({index:e,pointIJK:t,pointLPS:n})=>{let i=h.length>0;for(let e=0;e<h.length&&(i=h[e].volumeSize===l.length?g(h[e],t):f(h[e],h[c].spacing,n));e++);i&&(l[e]=1)},d),(0,t8.triggerSegmentationDataModified)(e.volumeId),e},nM=n(52611),nP=n(68207);function nA(e,t){let n=e.length,i=[];for(let a=0;a<n;a++){let n=e[a];n.getFrameOfReferenceUID()===t&&i.push(n)}return i}let{Active:nN,Passive:nL,Enabled:nx}=K.default;function nZ(e,t){let n=e.length,i=[];for(let a=0;a<n;a++){let n=e[a],o=e7.Z(n.id,n.renderingEngineId);if(!o)continue;let r=function(e,t){let{toolOptions:n}=e,i=n[t];if(!i)return!1;let a=i.mode;return a===nN||a===nL||a===nx}(o,t);r&&i.push(n)}return i}var nU=function(e,t,n=.999){return e.filter(e=>{let i=e.getCamera(),a=Math.abs(th.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n;return a})};function nk(e,t,n=!0){let i=(0,Q.ZP)(e),{renderingEngine:a,FrameOfReferenceUID:o}=i,r=a.getViewports();r=nZ(r=nA(r,o),t);let l=a.getViewport(i.viewportId);n&&(r=nU(r,l.getCamera()));let s=r.map(e=>e.id);return s}var nR=n(60993),nV=n(31437),nH=n(68287),nG=n(24049),nW=n(18745);let{EPSILON:nB}=nW,nF=1-nB;function n$(e,t,n){let{viewPlaneNormal:i}=t,a=e.filter(e=>{let t=e.metadata.viewPlaneNormal;if(!t){let{referencedImageId:n}=e.metadata,{imageOrientationPatient:i}=tf.get("imagePlaneModule",n),a=th.fromValues(i[0],i[1],i[2]),o=th.fromValues(i[3],i[4],i[5]);t=th.create(),th.cross(t,a,o),e.metadata.viewPlaneNormal=t}let n=Math.abs(th.dot(i,t))>nF;return t&&n});if(!a.length)return[];let o=n/2,{focalPoint:r}=t,l=[];for(let e of a){let t=e.data,n=t.handles.points[0];if(!e.isVisible)continue;let a=th.create();th.sub(a,r,n);let s=th.dot(a,i);Math.abs(s)<o&&l.push(e)}return l}function nq(e,t){if(e instanceof tr.Z){let n=e.getCurrentImageId(),i=n.indexOf(":"),a=n.substring(i+1);return t.filter(e=>{if(!e.isVisible)return!1;let t=e.metadata.referencedImageId;if(void 0===t)return!1;let n=t.indexOf(":"),i=t.substring(n+1);return i===a})}if(e instanceof tm.Z){let n=e.getCamera(),{spacingInNormalDirection:i}=nG.Z(e,n);return n$(t,n,i)}throw Error(`Viewport Type ${e.type} not supported`)}var nj=n(43348),nz=function(e){if(e){if(e.data&&e.highlighted)return eD.Highlighted;if((0,nj.isAnnotationSelected)(e.annotationUID))return eD.Selected;if((0,nP.isAnnotationLocked)(e))return eD.Locked}return eD.Default};class nK extends t6.Z{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{let{element:t,imageId:n}=e.detail,i=nH.Z(n),a=(0,tB.getAnnotationManager)(),o=a.getFramesOfReference();o.forEach(e=>{let n=a.getAnnotations(e),o=n[this.getToolName()];o&&o.length&&(o.forEach(e=>{let t=nH.Z(e.metadata.referencedImageId);t===i&&(e.invalidated=!0,e.data.cachedStats={})}),(0,t0.ZP)(t))})}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;let n=(0,Q.ZP)(e),{viewport:i}=n;return nq(i,t)}getReferencedImageId(e,t,n,i){let a;let o=this.getTargetId(e);if(e instanceof tr.Z)a=o.split("imageId:")[1];else{let e=o.split("volumeId:")[1],i=t7.ZP.getVolume(e);a=nM.Z(i,t,n)}return a}getStyle(e,t,n){return eW(e,t,nz(n),this.mode)}}nK.toolName="AnnotationDisplayTool";var nY=nK;class nX extends nY{constructor(){super(...arguments),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;let{element:n,currentPoints:i}=e.detail,a=i.canvas,o=!1;for(let e of t){if((0,nP.isAnnotationLocked)(e)||!(0,nR.isAnnotationVisible)(e.annotationUID))continue;let{data:t}=e,i=t.handles?t.handles.activeHandleIndex:void 0,r=this._imagePointNearToolOrHandle(n,e,a,6),l=r&&!e.highlighted,s=!r&&e.highlighted;l||s?(e.highlighted=!e.highlighted,o=!0):t.handles&&t.handles.activeHandleIndex!==i&&(o=!0)}return o}}getHandleNearImagePoint(e,t,n,i){let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,{points:l,textBox:s}=r.handles,{worldBoundingBox:d}=s;if(d){let e={topLeft:o.worldToCanvas(d.topLeft),topRight:o.worldToCanvas(d.topRight),bottomLeft:o.worldToCanvas(d.bottomLeft),bottomRight:o.worldToCanvas(d.bottomRight)};if(n[0]>=e.topLeft[0]&&n[0]<=e.bottomRight[0]&&n[1]>=e.topLeft[1]&&n[1]<=e.bottomRight[1])return r.handles.activeHandleIndex=null,s}for(let e=0;e<l.length;e++){let t=l[e],a=o.worldToCanvas(t),s=nV.TE(n,a)<i;if(!0===s)return r.handles.activeHandleIndex=e,t}r.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof to.Z){let e=t.split("volumeId:")[1],n=t7.ZP.getVolume(e);return n.scaling?.PT!==void 0}if(e instanceof tr.Z){let e=n&&tf.get("scalingModule",n);return"number"==typeof e?.suvbw}throw Error("Viewport is not a valid type")}_imagePointNearToolOrHandle(e,t,n,i){let a=this.getHandleNearImagePoint(e,t,n,i);if(a)return!0;let o=this.isPointNearTool(e,t,n,i,"mouse");if(o)return!0}}nX.toolName="AnnotationTool";var nJ=nX,nQ=n(91765),n0=n(4134);let{CalibrationTypes:n1}=n0,n2=(e,t)=>{let{calibration:n,hasPixelSpacing:i}=t,a=i?"mm":"px";return n&&n.type?n.type===n1.UNCALIBRATED?"px":n.SequenceOfUltrasoundRegions?"US Region":`${a} ${n.type}`:a},n5=(e,t)=>{let{calibration:n,hasPixelSpacing:i}=t,a=(i?"mm":"px")+"\xb2";return n&&n.type?n.SequenceOfUltrasoundRegions?"US Region":`${a} ${n.type}`:a},n3=e=>e.calibration?.scale||1,n4=e=>e.calibration?.aspect||1;function n8(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function n9(e,t,n){let i=n8(e,t);if(0===i)return n8(n,e);let a=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/i;if(a<0)return n8(n,e);if(a>1)return n8(n,t);let o=[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])];return n8(n,o)}function n7(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(n9(e,t,n))}function n6(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");let[n,i,a,o]=e,r=655535,l={top:[[n,i],[n+a,i]],right:[[n+a,i],[n+a,i+o]],bottom:[[n+a,i+o],[n,i+o]],left:[[n,i+o],[n,i]]};return Object.keys(l).forEach(e=>{let[n,i]=l[e],a=n7(n,i,t);a<r&&(r=a)}),r}function ie(e){let t=function(e){let t=[e[0],e[1]].sort(function(e,t){return e[0]<t[0]?-1:1}),n=[e[0],e[1]].sort(function(e,t){return e[1]<t[1]?-1:1}),i=t[t.length-1],a=n[0],o=n[n.length-1];return{top:a,bottom:o,right:i}}(e),n=(t.top[1]+t.bottom[1])/2,i=[t.right[0],n];return i}function it(e,t,n,i){let a=th.create();th.cross(a,t,e);let o=th.fromValues(...n),r=th.fromValues(...i),l=th.create();th.subtract(l,o,r);let s=th.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};let d=th.dot(l,a)/(s*th.length(a));return{worldWidth:Math.sqrt(1-d*d)*s,worldHeight:d*s}}function ii(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";let n=tf.get("petSeriesModule",e);return n?.units||"unitless"}(t,n):""}function ia(e,t){if(e instanceof to.Z){let e=t.split("volumeId:")[1],n=t7.ZP.getVolume(e);return!!n?.scaling&&Object.keys(n.scaling).length>0}if(e instanceof tr.Z){let{preScale:t}=e.getImageData()||{};return!!t?.scaled}throw Error("Viewport is not a valid type")}let{transformWorldToIndex:io}=tK;class ir extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{label:"",handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,s=o.worldToCanvas(l[0]),d=o.worldToCanvas(l[3]),u=this._getRectangleImageCoordinates([s,d]),c=[n[0],n[1]],{left:h,top:f,width:g,height:m}=u,v=n6([h,f,g,m],c);return v<=i},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),eX(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i;let a=e.detail,{element:o}=a,{data:r}=t;t.highlighted=!0;let l=!1;n.worldPosition?l=!0:i=r.handles.points.findIndex(e=>e===n);let s=nk(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o),eX(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,{points:a}=l.handles;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let e,a,r,s,d,u,c,h;let{currentPoints:f}=t,g=(0,Q.ZP)(n),{worldToCanvas:m,canvasToWorld:v}=g.viewport,p=f.world,{points:C}=l.handles;switch(C[o]=[...p],o){case 0:case 3:e=m(C[0]),a=[(s=m(C[3]))[0],e[1]],r=[e[0],s[1]],u=v(a),c=v(r),C[1]=u,C[2]=c;break;case 1:case 2:a=m(C[1]),e=[(r=m(C[2]))[0],a[1]],s=[a[0],r[1]],d=v(e),h=v(s),C[0]=d,C[3]=h}i.invalidated=!0}this.editData.hasMoved=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d;let u=o[a],{annotationUID:c,data:h}=u,{points:f,activeHandleIndex:g}=h.handles,m=f.map(e=>i.worldToCanvas(e));s.annotationUID=c;let v=this.getStyle("lineWidth",s,u),p=this.getStyle("lineDash",s,u),C=this.getStyle("color",s,u),{viewPlaneNormal:E,viewUp:_}=i.getCamera(),T={isPreScaled:ia(i,r),isSuvScaled:this.isSuvScaled(i,r,u.metadata.referencedImageId)};if(h.cachedStats[r]&&void 0!==h.cachedStats[r].areaUnit){if(u.invalidated&&(this._throttledCalculateCachedStats(u,E,_,l,e,T),i instanceof tm.Z)){let{referencedImageId:e}=u.metadata;for(let t in h.cachedStats)if(t.startsWith("imageId")){let n=l.getStackViewports(),i=n.find(t=>{let n=nH.Z(e),i=t.hasImageURI(n),a=nH.Z(t.getCurrentImageId());return i&&a!==n});i&&delete h.cachedStats[t]}}}else h.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(u,E,_,l,e,T);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(c))continue;(0,nP.isAnnotationLocked)(u)||this.editData||null===g||(d=[m[g]]),d&&tN(t,c,"0",d,{color:C});let I=`${c}-rect`;tG(t,c,"0",m[0],m[3],{color:C,lineDash:p,lineWidth:v},I),n=!0;let w=this._getTextLines(h,r);if(!w||0===w.length)continue;if(!h.handles.textBox.hasMoved){let e=ie(m);h.handles.textBox.worldPosition=i.canvasToWorld(e)}let b=i.worldToCanvas(h.handles.textBox.worldPosition),S=tH(t,c,"1",w,b,m,{},this.getLinkedTextBoxStyle(s,u)),{x:D,y:O,width:y,height:M}=S;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,O]),topRight:i.canvasToWorld([D+y,O]),bottomLeft:i.canvasToWorld([D,O+M]),bottomRight:i.canvasToWorld([D+y,O+M])}}return n},this._getRectangleImageCoordinates=e=>{let[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._getTextLines=(e,t)=>{let n=e.cachedStats[t],{area:i,mean:a,max:o,stdDev:r,areaUnit:l,modalityUnit:s}=n;if(void 0===a)return;let d=[];return d.push(`Area: ${t4(i)} ${l}`),d.push(`Mean: ${t4(a)} ${s}`),d.push(`Max: ${t4(o)} ${s}`),d.push(`Std Dev: ${t4(r)} ${s}`),d},this._calculateCachedStats=(e,t,n,i,a,o)=>{let{data:r}=e,{viewportId:l,renderingEngineId:s}=a,d=r.handles.points[0],u=r.handles.points[3],{cachedStats:c}=r,h=Object.keys(c);for(let a=0;a<h.length;a++){let r=h[a],l=this.getTargetIdImage(r,i);if(!l)continue;let{dimensions:s,imageData:f,metadata:g}=l,m="getScalarData"in l?l.getScalarData():l.scalarData,v=io(f,d);v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]);let p=io(f,u);if(p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]),this._isInsideVolume(v,p,s)){this.isHandleOutsideImage=!1;let i=Math.min(v[0],p[0]),a=Math.max(v[0],p[0]),h=Math.min(v[1],p[1]),f=Math.max(v[1],p[1]),C=Math.min(v[2],p[2]),E=Math.max(v[2],p[2]),{worldWidth:_,worldHeight:T}=it(t,n,d,u),I=n3(l),w=Math.abs(_*T)/(I*I),b=0,S=0,D=0,O=-1/0,y=s[0],M=s[0]*s[1];for(let e=C;e<=E;e++)for(let t=h;t<=f;t++)for(let n=i;n<=a;n++){let i=m[e*M+t*y+n];i>O&&(O=i),b++,S+=i}S/=b;for(let e=C;e<=E;e++)for(let t=h;t<=f;t++)for(let n=i;n<=a;n++){let i=m[e*M+t*y+n],a=i-S;D+=a*a}D/=b,D=Math.sqrt(D);let P=ii(g.Modality,e.metadata.referencedImageId,o);c[r]={Modality:g.Modality,area:w,mean:S,stdDev:D,max:O,areaUnit:n5(null,l),modalityUnit:P}}else this.isHandleOutsideImage=!0,c[r]={Modality:g.Modality}}e.invalidated=!1;let f=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,f,{annotation:e,viewportId:l,renderingEngineId:s}),c},this._isInsideVolume=(e,t,n)=>nQ.Z(e,n)&&nQ.Z(t,n),this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}}ir.toolName="RectangleROI";var il=ir;class is extends il{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{let t,n;let i=e.detail,{currentPoints:a,element:o}=i,r=a.world,l=(0,Q.ZP)(o),{viewport:s,renderingEngine:d}=l;this.isDrawing=!0;let u=s.getCamera(),{viewPlaneNormal:c,viewUp:h}=u,f=this.getTargetId(s);if(s instanceof tr.Z)t=f.split("imageId:")[1];else{n=f.split("volumeId:")[1];let e=t7.ZP.getVolume(n);t=nM.Z(e,r,c)}let g=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...c],enabledElement:l,viewUp:[...h],FrameOfReferenceUID:g,referencedImageId:t,toolName:this.getToolName(),volumeId:n},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...r],[...r],[...r],[...r]],activeHandleIndex:null},segmentationId:null}};(0,tB.addAnnotation)(m,o);let v=nk(o,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),eX(o),e.preventDefault(),(0,tQ.Z)(d,v),m},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i,renderingEngineId:a}=e,{element:o}=i,r=(0,tB.getAnnotations)(this.getToolName(),o);if(!r?.length||(r=this.filterInteractableAnnotationsForElement(o,r),!r?.length))return n;let l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){let o;let s=r[e],{annotationUID:d,data:u}=s,{points:c,activeHandleIndex:h}=u.handles,f=c.map(e=>i.worldToCanvas(e));l.annotationUID=d;let g=this.getStyle("lineWidth",l,s),m=this.getStyle("lineDash",l,s),v=this.getStyle("color",l,s);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}let p=e_.default.ANNOTATION_MODIFIED,C={annotation:s,viewportId:i.id,renderingEngineId:a};(0,ep.Z)(eC.Z,p,C),(0,nR.isAnnotationVisible)(d)&&((0,nP.isAnnotationLocked)(s)||this.editData||null===h||(o=[f[h]]),o&&tN(t,d,"0",o,{color:v}),tG(t,d,"0",f[0],f[3],{color:v,lineDash:m,lineWidth:g}),n=!0)}return n}}}is.toolName="RectangleROIThreshold";var id=is,iu=n(15074);let{transformWorldToIndex:ic}=tK;class ih extends il{constructor(e={},t={configuration:{numSlicesToPropagate:10}}){super(e,t),this.addNewAnnotation=e=>{let t,n,i;let a=e.detail,{currentPoints:o,element:r}=a,l=o.world,s=(0,Q.ZP)(r),{viewport:d,renderingEngine:u}=s;this.isDrawing=!0;let c=d.getCamera(),{viewPlaneNormal:h,viewUp:f}=c;if(d instanceof tr.Z)throw Error("Stack Viewport Not implemented");{let e=this.getTargetId(d);i=e.split("volumeId:")[1],n=t7.ZP.getVolume(i),t=nM.Z(n,l,h)}if(!t)throw Error("This tool does not work on non-acquisition planes");let g=d.getCurrentImageIdIndex(),m=iu.Z(n,h),v=this._getEndSliceIndex(n,l,m,h),p=d.getFrameOfReferenceUID(),C={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...h],enabledElement:s,viewUp:[...f],FrameOfReferenceUID:p,referencedImageId:t,toolName:this.getToolName(),volumeId:i,spacingInNormal:m},data:{label:"",startSlice:g,endSlice:v,cachedStats:{projectionPoints:[],projectionPointsImageIds:[t]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...l],[...l],[...l],[...l]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(C,n),(0,tB.addAnnotation)(C,r);let E=nk(r,this.getToolName());return this.editData={annotation:C,viewportIdsToRender:E,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(r),eX(r),e.preventDefault(),(0,tQ.Z)(u,E),C},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,a=(0,tB.getAnnotations)(this.getToolName(),i.element);if(!a?.length)return n;let o=i.getCurrentImageIdIndex(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let l=0;l<a.length;l++){let s;let d=a[l],{annotationUID:u,data:c}=d,{startSlice:h,endSlice:f}=c,{points:g,activeHandleIndex:m}=c.handles,v=g.map(e=>i.worldToCanvas(e));r.annotationUID=u;let p=this.getStyle("lineWidth",r,d),C=this.getStyle("lineDash",r,d),E=this.getStyle("color",r,d);if(o<Math.min(h,f)||o>Math.max(h,f))continue;d.invalidated&&this._throttledCalculateCachedStats(d,e);let _=!1;if((o===h||o===f)&&(_=!0),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(u))continue;(0,nP.isAnnotationLocked)(d)||this.editData||null===m||!_||(s=[v[m]]),s&&tN(t,u,"0",s,{color:E});let T=C;_||(T=2),tG(t,u,"0",v[0],v[3],{color:E,lineDash:T,lineWidth:p}),n=!0}return n},this._throttledCalculateCachedStats=tz(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){let{data:n,metadata:i}=e,{viewPlaneNormal:a,spacingInNormal:o}=i,{imageData:r}=t,{startSlice:l,endSlice:s}=n,{points:d}=n.handles,u=ic(r,d[0]);if(u[2]!==l)throw Error("Start slice does not match");let c=th.fromValues(u[0],u[1],s),h=th.create();r.indexToWorldVec3(u,h);let f=th.create();r.indexToWorldVec3(c,f);let g=th.distance(h,f),m=[];for(let e=0;e<g;e+=o)m.push(d.map(t=>{let n=th.create();return th.scaleAndAdd(n,t,a,e),Array.from(n)}));n.cachedStats.projectionPoints=m;let v=[];for(let e of m){let n=nM.Z(t,e[0],a);v.push(n)}n.cachedStats.projectionPointsImageIds=v}_calculateCachedStatsTool(e,t){let n=e.data,{viewportId:i,renderingEngineId:a,viewport:o}=t,{cachedStats:r}=n,l=this.getTargetId(o),s=t7.ZP.getVolume(l.split("volumeId:")[1]);this._computeProjectionPoints(e,s),e.invalidated=!1;let d=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,d,{annotation:e,viewportId:i,renderingEngineId:a}),r}_getEndSliceIndex(e,t,n,i){let a;let o=this.configuration.numSlicesToPropagate,r=th.create();th.scaleAndAdd(r,t,i,o*n);let l=n/2,{imageIds:s}=e;for(let e=0;e<s.length;e++){let t=s[e],{imagePositionPatient:n}=tf.get("imagePlaneModule",t),o=th.create();th.sub(o,r,n);let d=th.dot(o,i);Math.abs(d)<l&&(a=e)}return a}}ih.toolName="RectangleROIStartEndThreshold";var ig=ih,im=function(e,t){let n=e.findIndex(([e,t])=>e===t);if(-1===n)throw Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e},iv=function(e,t,n={}){let i=[];if(e.forEach(e=>{let{data:a}=e,{points:o}=a.handles,{imageData:r,dimensions:l}=t,s=o;if(a.cachedStats?.projectionPoints){let{projectionPoints:e}=a.cachedStats;s=[].concat(...e)}let d=s.map(e=>t9.Z(r,e)),u=t2(d,l);n.numSlicesToProject&&!a.cachedStats?.projectionPoints&&(u=im(u,n.numSlicesToProject)),i.push(u)}),1===i.length)return i[0];let a=i.reduce((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0});return a},ip=function(e,t,n,i){let a;let o=e.map(e=>tB.getAnnotation(e));!function(e){let t=[id.toolName,ig.toolName];for(let n of e){let e=n.metadata.toolName;if(!t.includes(e))throw Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(o);for(let e=0;e<n.length;e++){let r=n[e].volume.getScalarData().length;(r===t.getScalarData().length||0===e)&&(a=iv(o,n[e].volume,i))}let r=ny(t,n,{...i,boundsIJK:a});return r},iC=n(75520),iE=function(e,t=1,n="mergedLabelmap"){e.forEach(({direction:t,dimensions:n,origin:i,spacing:a})=>{if(!nn.Z(n,e[0].dimensions)||!nn.Z(t,e[0].direction)||!nn.Z(a,e[0].spacing)||!nn.Z(i,e[0].origin))throw Error("labelmaps must have the same size and shape")});let i=e[0],a=i.getScalarData().constructor,o=new a(i.getScalarData().length);e.forEach(e=>{let n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(o[e]=t)});let r={scalarData:o,metadata:i.metadata,spacing:i.spacing,origin:i.origin,direction:i.direction,dimensions:i.dimensions},l=iC.createLocalVolume(r,n,!0);return l},i_=n(14859),iT=n(20579);function iI(e,t){if(e===iT.Z.Labelmap)return(0,i_.R)(t);throw Error(`Unknown representation type: ${e}`)}function iw(e){let{type:t}=e;if(t===iT.Z.Labelmap)return(0,i_.Z)();throw Error(`Unknown representation type: ${t}`)}var ib=n(57024);async function iS(e){let{viewportId:t,renderingEngineId:n,options:i}=e,{segmentationId:a}=e,o=(0,Q.O)(t,n);if(!o)throw Error("element disabled");let{viewport:r}=o;if(!(r instanceof tm.Z))throw Error("Segmentation only supports VolumeViewport");let{uid:l}=r.getDefaultActor();if(void 0===a&&(a=`${l}-based-segmentation-${i?.volumeId??ib.Z().slice(0,8)}`),i){let e=(0,eh._cloneDeep)(i);await iC.createLocalVolume(e,a)}else{let{uid:e}=r.getDefaultActor();await iC.createAndCacheDerivedVolume(e,{volumeId:a})}return a}var iD=n(30946);function iO(e,t){return e===t}var iy=function(e,t,n={}){let i=n.onFlood,a=n.onBoundary,o=n.equals||iO,r=n.diagonals||!1,l=f(t),s=function(){let e=function(e){let t=[];for(let n=0;n<Math.pow(3,e);n+=1){let i=function(e,t,n){let i=Array(n+1),a=i.join("0");return(a+e).slice(-n)}(n.toString(3),0,e);t.push(i.split("").map(function(e){return parseInt(e,10)-1}))}return t}(t.length);return e.filter(function(e){let t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||r)})}(),d=[],u=[],c={},h={};for(d.push({currentArgs:t});d.length>0;)!function(e){let t=e.currentArgs,n=e.previousArgs;if(!0!==c[t])c[t]=!0,function(e){let t=g(f,[e]);return g(o,[t,l])}(t)?(u.push(t),i&&i(...t),function(e){for(let t=0;t<s.length;t+=1){let n=s[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];d.push({currentArgs:i,previousArgs:e})}}(t)):(h[n]=n,a&&a(...n))}(d.pop());return{flooded:u,boundaries:function(){let e=[];for(let t in h)void 0!==h[t]&&e.unshift(h[t]);return e}()};function f(t){return e(...t)}function g(e,t){try{return e(...t)}catch(e){return}}};function iM(e,t){let n=(0,e9.Z)(e);if(void 0===n)return;let i=nb(e);i.forEach(e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()});let a=n.getViewportsInfo(),o=Object.keys(a).map(e=>a[e]);if(!o.length)return;let{renderingEngineId:r}=o[0],l=n.getViewportIds(),s=(0,ee.Pr)(r);(0,tQ.Z)(s,l)}function iP(e){let t=(0,e9.Z)(e);if(void 0===t)return;let n=t._toolInstances;if(!Object.keys(n).length)return;let i=nb(e),a=i[0];if(a)return a.configuration.brushSize}function iA(e,t){let n=(0,e9.Z)(e);if(void 0===n)return;let i=nb(e);i.forEach(e=>{e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t});let a=n.getViewportsInfo();if(!a.length)return;let{renderingEngineId:o}=a[0],r=n.getViewportIds(),l=(0,ee.Pr)(o);(0,tQ.Z)(l,r)}function iN(e){let t=(0,e9.Z)(e);if(void 0===t)return;let n=t._toolInstances;if(!Object.keys(n).length)return;let i=nb(e),a=i[0];if(a)return a.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold}var iL=function(e,t,n,i){let a=e.getScalarData(),{baseVolumeIdx:o,volumeInfoList:r}=nO(e,n);return r.forEach(e=>{let{volumeSize:n}=e;n===a.length?function(e,t,n){let{referenceValues:i,lower:a,upper:o}=n;for(let n=0;n<e.length;n++)if(e[n]===t){let r=i[n];e[n]=r>=a&&r<=o?t:0}}(a,t,e):function(e,t,n,i,a,o){let r,l,s;let{imageData:d,lower:u,upper:c,dimensions:h}=n;for(let n=0;n<e.length;n++)if(e[n]===t){let f=nD(d,h,i[a].spacing,i[a].imageData.getPoint(n)),g=({value:e})=>{r+=1,e>=s.lower&&e<=s.upper&&(l+=1)};r=0,l=0,s={lower:u,upper:c};let m=!1;t1(d,()=>!0,g,f),m=0===o?l>0:l===r,e[n]=m?t:0}return{total:r,range:s,overlaps:l}}(a,t,e,r,o,i)}),(0,t8.triggerSegmentationDataModified)(e.volumeId),e};function ix(e,t,n){let[i,a]=n;if(1e-6>Math.abs(t))return e<0;let o=e/t;if(t>0){if(o>a)return 0;o>i&&(n[0]=o)}else{if(o<i)return 0;o<a&&(n[1]=o)}return 1}function iZ(e,t,n,i,a){let[o,r]=e,[l,s]=t,d=l-o,u=s-r;if(void 0===i||void 0===a?(i=e,a=t):(i[0]=e[0],i[1]=e[1],a[0]=t[0],a[1]=t[1]),1e-6>Math.abs(d)&&1e-6>Math.abs(u)&&o>=n[0]&&o<=n[2]&&r>=n[1]&&r<=n[3])return 1;let c=[0,1];if(ix(n[0]-o,d,c)&&ix(o-n[2],-d,c)&&ix(n[1]-r,u,c)&&ix(r-n[3],-u,c)){let[e,t]=c;return t<1&&(a[0]=o+t*d,a[1]=r+t*u),e>0&&(i[0]+=e*d,i[1]+=e*u),1}return 0}function iU(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function ik(e,t,n,i){let a;let[o,r]=e,[l,s]=t,[d,u]=n,[c,h]=i,f=s-r,g=o-l,m=l*r-o*s,v=f*d+g*u+m,p=f*c+g*h+m;if(0!==v&&0!==p&&iU(v)===iU(p))return;let C=h-u,E=d-c,_=c*u-d*h,T=C*o+E*r+_,I=C*l+E*s+_;if(0!==T&&0!==I&&iU(T)===iU(I))return;let w=f*E-C*g;a=g*_-E*m;let b=a/w;a=C*m-f*_;let S=a/w;return[b,S]}function iR(e,t,n,i=!0){let a,o;i?(o=e.length-1,a=0):(o=0,a=1);for(let i=a;i<e.length;i++){let a=e[o],r=e[i];if(iH(t,n,a,r))return[o,i];o=i}}function iV(e,t,n,i=!0){let a,o;i?(o=e.length-1,a=0):(o=0,a=1);let r=[];for(let i=a;i<e.length;i++){let a=e[o],l=e[i];iH(t,n,a,l)&&r.push([o,i]),o=i}if(0===r.length)return;let l=[];r.forEach(n=>{let i=[e[n[0]],e[n[1]]],a=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];l.push(nV.TE(a,t))});let s=Math.min(...l),d=l.indexOf(s);return{segment:r[d],distance:s}}function iH(e,t,n,i){let a=!1,o=[iG(e,t,n),iG(e,t,i),iG(n,i,e),iG(n,i,t)];return o[0]!==o[1]&&o[2]!==o[3]||(0===o[0]&&iW(e,n,t)?a=!0:0===o[1]&&iW(e,i,t)?a=!0:0===o[2]&&iW(n,e,i)?a=!0:0===o[3]&&iW(n,t,i)&&(a=!0),a)}function iG(e,t,n){let i=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===i?0:i>0?1:2}function iW(e,t,n){return!!(t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1]))}var iB=(e,t)=>{let n,i,a;if(e instanceof tr.Z){let t=e.getImageData();i=t.direction.slice(0,3),a=t.direction.slice(3,6),n=t.spacing}else{let t,o;let r=e.getImageData(),{direction:l,spacing:s}=r,{viewPlaneNormal:d,viewUp:u}=e.getCamera(),c=l.slice(0,3),h=l.slice(3,6),f=l.slice(6,9),g=th.create();th.cross(g,u,d);let m=Math.abs(th.dot(g,c)),v=Math.abs(th.dot(g,h)),p=Math.abs(th.dot(g,f));if(.001>Math.abs(1-m))t=s[0],i=c;else if(.001>Math.abs(1-v))t=s[1],i=h;else if(.001>Math.abs(1-p))t=s[2],i=f;else throw Error("No support yet for oblique plane planar contours");let C=Math.abs(th.dot(u,c)),E=Math.abs(th.dot(u,h)),_=Math.abs(th.dot(u,f));if(.001>Math.abs(1-C))o=s[0],a=c;else if(.001>Math.abs(1-E))o=s[1],a=h;else if(.001>Math.abs(1-_))o=s[2],a=f;else throw Error("No support yet for oblique plane planar contours");n=[t,o]}let o=[n[0]/t,n[1]/t];return{spacing:o,xDir:i,yDir:a}},iF=(e,t,n)=>nV.TK(e,t)<n,i$=(e,t,n,i)=>{let{xDir:a,yDir:o,spacing:r}=i,l=(0,Q.ZP)(e),{viewport:s}=l,d=s.canvasToWorld(t[t.length-1]),u=s.canvasToWorld(n),c=th.create();th.subtract(c,u,d);let h=Math.abs(th.dot(c,a)),f=Math.abs(th.dot(c,o)),g=Math.max(Math.floor(h/r[0]),Math.floor(f/r[0]));if(g>1){let e=t[t.length-1],i=nV.TK(e,n),a=nV.Ue();nV.$X(a,n,e),nV.t8(a,a[0]/i,a[1]/i);let o=i/g;for(let n=1;n<=g;n++)t.push([e[0]+o*a[0]*n,e[1]+o*a[1]*n])}else t.push(n);return g},iq=(e,t,n,i)=>{let a=[e[0]-t[0],e[1]-t[1]],o=[n[0]-t[0],n[1]-t[1]],r=a[0]*o[0]+a[1]*o[1];if(r<0)return!1;let l=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(0===l)return!1;let s=r/l,d=[o[0]/l,o[1]/l],u=[d[0]*s,d[1]*s],c=[t[0]+u[0],t[1]+u[1]],h=nV.TE(e,c);return!(h>i||nV.TE(t,c)>nV.TE(t,n))};function ij(e){let t=e.length,n=0,i=t-1;for(let a=0;a<t;a++)n+=(e[i][0]+e[a][0])*(e[i][1]-e[a][1]),i=a;return Math.abs(n/2)}function iz(e,t){if(e?.length!==2||t?.length!==2)throw Error("points should have 2 elements of [x, y]");let[n,i]=e,[a,o]=t;return Math.sqrt(Math.pow(n-a,2)+Math.pow(i-o,2))}var iK=n(32067);function iY(e,t,n,i,a=.25){let o;let r=e.getCamera(),{position:l}=r,{spacingInNormalDirection:s}=nG.Z(e,r,n),d=s*a,u=e.getBounds(),c=u[0],h=u[1],f=[0,0,0],g=[0,0,0];iK.ZP.subtract(t,l,f);for(let t=c;t<=h;t+=d){g=[t,0,0];let n=(t-l[0])/f[0];if(g[1]=n*f[1]+l[1],g[2]=n*f[2]+l[2],iX(g,u)){let t=e.getIntensityFromWorld(g),n=i(t,g);n&&(o=n)}}return o}let iX=function(e,t){let[n,i,a,o,r,l]=t;return e[0]>n&&e[0]<i&&e[1]>a&&e[1]<o&&e[2]>r&&e[2]<l};var iJ={filterAnnotationsWithinSlice:n$,getWorldWidthAndHeightFromCorners:it,filterAnnotationsForDisplay:nq,getPointInLineOfSightWithCriteria:iY};function iQ(e){let t="",n=e[0]<0?"R":"L",i=e[1]<0?"A":"P",a=e[2]<0?"F":"H",o=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];for(let e=0;e<3;e++)if(o[0]>1e-4&&o[0]>o[1]&&o[0]>o[2])t+=n,o[0]=0;else if(o[1]>1e-4&&o[1]>o[0]&&o[1]>o[2])t+=i,o[1]=0;else if(o[2]>1e-4&&o[2]>o[0]&&o[2]>o[1])t+=a,o[2]=0;else if(o[0]>1e-4&&o[1]>1e-4&&o[0]===o[1])t+=n+i,o[0]=0,o[1]=0;else if(o[0]>1e-4&&o[2]>1e-4&&o[0]===o[2])t+=n+a,o[0]=0,o[2]=0;else if(o[1]>1e-4&&o[2]>1e-4&&o[1]===o[2])t+=i+a,o[1]=0,o[2]=0;else break;return t}function i0(e){let t=e.replace("H","f");return(t=(t=(t=(t=(t=t.replace("F","h")).replace("R","l")).replace("L","r")).replace("A","p")).replace("P","a")).toUpperCase()}var i1=n(49685);(o=l||(l={})).CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",o.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED";var i2=l;let i5={};function i3(e,t){let n=(0,Q.ZP)(e),{viewportId:i}=n;i5[i]=t}function i4(e){let t=(0,Q.ZP)(e),{viewportId:n}=t;return i5[n]}let{triggerEvent:i8}=tK,i9=new Map;function i7(e,t){let n,i;if(void 0===e)throw Error("playClip: element must not be undefined");let a=(0,Q.ZP)(e);if(!a)throw Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=t.dynamicCineEnabled??!0;let{viewport:o}=a,r=an(o),l=function(e,t){if(e instanceof tr.Z)return function(e){let t=e.getImageIds();return{get numScrollSteps(){return t.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},scroll(t){t_(e,{delta:t,debounceLoading:!0})}}}(e);if(e instanceof tm.Z){let n=an(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?{get numScrollSteps(){return n.numTimePoints},get currentStepIndex(){return n.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(e){n.timePointIndex+=e}}:function(e,t){let{volumeId:n}=t,i={viewPlaneNormal:th.create(),scrollInfo:null},a=()=>{let t=e.getCamera(),a=!i.scrollInfo||!th.equals(t.viewPlaneNormal,i.viewPlaneNormal);if(a){let a=tC.Z(e,n);i.viewPlaneNormal=t.viewPlaneNormal,i.scrollInfo=a}return i.scrollInfo};return{get numScrollSteps(){return a().numScrollSteps},get currentStepIndex(){return a().currentStepIndex},get frameTimeVectorEnabled(){let n=e.getCamera(),i=t.direction.slice(6,9).map(e=>-e),a=th.dot(i,n.viewPlaneNormal);return i1.fS(a,1)},scroll(t){a().currentStepIndex+=t,t_(e,{delta:t})}}}(e,n)}throw Error("Unknown viewport type")}(o,t),s=i4(e),d=t.dynamicCineEnabled&&r?.isDynamicVolume();if(d&&at(e),s?ae(e,d):i3(e,s={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0}),s.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(s.framesPerSecond=Number(t.framesPerSecond),s.reverse=s.framesPerSecond<0,s.ignoreFrameTimeVector=!0),!0!==s.ignoreFrameTimeVector&&s.frameTimeVector&&s.frameTimeVector.length===l.numScrollSteps&&l.frameTimeVectorEnabled){let{timeouts:e,isTimeVarying:t}=function(e,t){let n,i,a;let o=0,r=e.length,l=[],s=!1;for(("number"!=typeof t||t<=0)&&(t=1),n=1;n<r;n++)l.push(a=Number(e[n])/t|0),1===n?i=a:a!==i&&(s=!0),o+=a;return l.length>0&&(a=s?o/l.length|0:l[0],l.push(a)),{timeouts:l,isTimeVarying:s}}(s.frameTimeVector,s.speed);n=e,i=t}let u=()=>{let{numScrollSteps:e,currentStepIndex:t}=l,n=t+(s.reverse?-1:1);n>=e?n=0:n<0&&(n=e-1);let i=n-t;i&&l.scroll(i)};d&&i9.set(r.volumeId,e),n&&n.length>0&&i?(s.usingFrameTimeVector=!0,s.intervalId=window.setTimeout(function e(){s.intervalId=window.setTimeout(e,n[l.currentStepIndex]),u()},0)):(s.usingFrameTimeVector=!1,s.intervalId=window.setInterval(u,1e3/Math.abs(s.framesPerSecond))),i8(e,i2.CLIP_STARTED,{element:e})}function i6(e){ae(e,!0)}function ae(e,t){let n=(0,Q.ZP)(e);if(!n)return;let{viewport:i}=n,a=i4(i.element);a&&function(e){let t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(a),t&&i instanceof to.Z&&at(e)}function at(e){let{viewport:t}=(0,Q.ZP)(e),n=an(t);if(n?.isDynamicVolume()){let t=i9.get(n.volumeId);i9.delete(n.volumeId),t&&t!==e&&i6(t)}}function an(e){let t=e.getActors().map(e=>t7.ZP.getVolume(e.uid)).filter(e=>!!e),n=t.find(e=>e.isDynamicVolume());return n??t[0]}var ai=n(27265);function aa(e,t){for(var n=Array(t),i=0;i<t;++i)n[i]=e(i/(t-1));return n}function ao(e){return e.length}function ar(){return function(e){if(!(a=e.length))return[];for(var t=-1,n=function(e,t){let n;if(void 0===t)for(let t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let i=-1;for(let a of e)null!=(a=t(a,++i,e))&&(n>a||void 0===n&&a>=a)&&(n=a)}return n}(e,ao),i=Array(n);++t<n;)for(var a,o=-1,r=i[t]=Array(a);++o<a;)r[o]=e[o][t];return i}(arguments)}function al(e,t,n,i){let a=n-t+1,o=Math.floor(a/(Math.floor(i/100*a)??1))??1;if(isNaN(a)||!a||!o||a/o<2)return e;let r=Math.max(0,t),l=Math.min(e.length-1,n),s=e.slice(0,r),d=e.slice(l+1,e.length),u=function(e,t){let n=[],[i,a]=t,o=a-i+1,r=Math.floor(o/e),l=0,s=Math.round((o-1)/(r-1)*0)+i;for(;s<=a;)n.push(s),s=Math.round((o-1)/(r-1)*++l)+i;return n}(o,[r,l]),c=function(e,t){if(!t||0===t.length||t.length===e.length)return e;let n=t[t.length-1]-t[0]+1,i=(0,ai.Z)(t.map(t=>e[t][0])),a=(0,ai.Z)(t.map(t=>e[t][1]));if(e[0]?.length!==3)return ar(aa(i,n),aa(a,n));{let o=(0,ai.Z)(t.map(t=>e[t][2]));return ar(aa(i,n),aa(a,n),aa(o,n))}}(e,u);return[...s,...c,...d]}function as(e){return e?.interpolation?.interpolateOnAdd===!0||e?.interpolation?.interpolateOnEdit===!0}function ad(e,t,n,i){let[,a,o]=e,[,r,l]=t,s=o.length,d=l.length,u=e[0],c=t[0];if(!o[u]||!l[c]||!o[a]||!l[r])return[void 0,void 0];for(;u!==a&&c!==r;){if(n(l[c],o[u]))return[u,c];u=(u+s+i)%s,c=(c+d+i)%d}return[void 0,void 0]}function au(e,t,n){let{interpolation:i}=e;if(i){let{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:a,interpolateOnAdd:o=!1,interpolateOnEdit:r=!1}=i,l=n?a:e,s=n?r:o;if(s){let[e,i]=n?function(e,t){var n,i,a,o;let[r,l]=function(e,t){for(let n=0;n<e.length;n++)for(let i=0;i<t.length;i++)if(0===iz(e[n],t[i]))return[n,i]}(e,t)||[],s=(e,t)=>!1==.001>iz(e,t),[d,u]=ad([(r+(n=e.length)+1)%n,r,e],[(l+(i=t.length)+1)%i,l,t],s,1),[c]=ad([(d+(a=e.length)+-1)%a,d,e],[(u+(o=t.length)+-1)%o,u,t],s,-1);return[d,c]}(t,n):[0,t.length-1];return t[e]&&t[i]?al(t,e,i,l):t}}return t}function ac(e,t){let n=e[0],i=e[e.length-1],a=nV.Ue();nV.t8(a,i[0]-n[0],i[1]-n[1]),nV.Fv(a,a);let o=nV.Ue(),r=nV.Ue();nV.t8(o,-a[1],a[0]),nV.t8(r,a[1],-a[0]);let l=[(n[0]+i[0])/2,(n[1]+i[1])/2],s={dist:0,index:null};for(let t=0;t<e.length;t++){let n=e[t],i=nV.TK(n,l);i>s.dist&&(s.dist=i,s.index=t)}let d=[e[s.index],l],u=d.map(t.canvasToWorld);return u}let{addCanvasPointsToArray:ah,pointsAreWithinCloseContourProximity:af,getFirstIntersectionWithPolyline:ag,getSubPixelSpacingAndXYDirections:am}=b;function av(e,t,n){this.isDrawing=!0;let i=e.detail,{currentPoints:a,element:o}=i,r=a.canvas,l=(0,Q.ZP)(o),{viewport:s}=l,{spacing:d,xDir:u,yDir:c}=am(s,this.configuration.subPixelResolution);this.drawData={canvasPoints:[r],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:c,movingTextBox:!1},q.ZP.isInteractingWithTool=!0,o.addEventListener(e_.default.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(e_.default.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(e_.default.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(e_.default.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(e_.default.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(e_.default.TOUCH_TAP,this.mouseUpDrawCallback),eX(o)}function ap(e){q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(e_.default.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(e_.default.TOUCH_TAP,this.mouseUpDrawCallback),eY(e)}function aC(e){let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{renderingEngine:l,viewport:s}=r,{annotation:d,viewportIdsToRender:u,xDir:c,yDir:h,spacing:f,movingTextBox:g}=this.commonData,{polylineIndex:m,canvasPoints:v}=this.drawData,p=v[v.length-1],C=s.canvasToWorld(p),E=th.create();th.subtract(E,a,C);let _=Math.abs(th.dot(E,c)),T=Math.abs(th.dot(E,h));if(!(_<=f[0])||!(T<=f[1])){if(g){this.isDrawing=!1;let{deltaPoints:e}=t,n=e.world,{textBox:i}=d.data.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else{let t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{let e=ah(i,v,o,this.commonData);this.drawData.polylineIndex=m+e}}(0,tQ.Z)(l,u)}}function aE(e){let{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],a=n[n.length-1],o=e.detail,{element:r}=o;t&&!af(i,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(r):this.completeDrawClosedContour(r)}function a_(e){this.removeCrossedLinesOnCompleteDraw();let{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;let{annotation:n,viewportIdsToRender:i}=this.commonData,a=(0,Q.ZP)(e),{viewport:o,renderingEngine:r}=a;ah(e,t,t[0],this.commonData),t.pop();let l=as(this.configuration)?au(this.configuration,t):t,s=l.map(e=>o.canvasToWorld(e));n.data.polyline=s,n.data.isOpenContour=!1;let{textBox:d}=n.data.handles;return d.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,tQ.Z)(r,i),this.deactivateDraw(e),!0}function aT(){let{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],i=e.slice(0,-1).slice(1),a=ag(i,n[0],n[1],!1);if(a){let t=a[1];this.drawData.canvasPoints=e.splice(0,t)}}function aI(e){let{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;let{annotation:n,viewportIdsToRender:i}=this.commonData,a=(0,Q.ZP)(e),{viewport:o,renderingEngine:r}=a,l=as(this.configuration)?au(this.configuration,t):t,s=l.map(e=>o.canvasToWorld(e));n.data.polyline=s,n.data.isOpenContour=!0;let{textBox:d}=n.data.handles;return n.data.handles.points=[s[0],s[s.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=ac(t,o)),d.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,tQ.Z)(r,i),this.deactivateDraw(e),!0}function aw(e){let t=e.detail,{currentPoints:n,lastPoints:i}=t,a=n.canvas,o=i.canvas,{canvasPoints:r}=this.drawData,l=r.slice(0,-1),s=ag(l,a,o,!1);if(void 0===s)return;let d=s[0];return d}function ab(e,t){let n=e.detail,{element:i}=n,{canvasPoints:a}=this.drawData,{annotation:o,viewportIdsToRender:r}=this.commonData;ah(i,a,a[t],this.commonData),a.pop();for(let e=0;e<t;e++)a.shift();this.completeDrawClosedContour(i)&&this.activateClosedContourEdit(e,o,r)}function aS(e){let{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],a=n[n.length-1];t&&!af(i,a,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function aD(e,t){let{subPixelResolution:n}=this.configuration;if(t.length<Math.max(3*n,3)){let{annotation:t,viewportIdsToRender:n}=this.commonData,i=(0,Q.ZP)(e),{renderingEngine:a}=i;return(0,tB.removeAnnotation)(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,tQ.Z)(a,n),this.deactivateDraw(e),!0}return!1}var aO=function(e){e.activateDraw=av.bind(e),e.deactivateDraw=ap.bind(e),e.applyCreateOnCross=ab.bind(e),e.findCrossingIndexDuringCreate=aw.bind(e),e.completeDrawOpenContour=aI.bind(e),e.removeCrossedLinesOnCompleteDraw=aT.bind(e),e.mouseDragDrawCallback=aC.bind(e),e.mouseUpDrawCallback=aE.bind(e),e.completeDrawClosedContour=a_.bind(e),e.cancelDrawing=aS.bind(e),e.haltDrawing=aD.bind(e)};let{addCanvasPointsToArray:ay,getFirstIntersectionWithPolyline:aM}=b;function aP(e,t){let n=e.detail,{element:i,currentPoints:a,lastPoints:o}=n,r=a.canvas,l=o.canvas,{editCanvasPoints:s,prevCanvasPoints:d}=this.editData,u=aM(d,r,l,t);if(u)this.editData.startCrossingIndex=u[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2){if(s.length>this.configuration.checkCanvasEditFallbackProximity){let e=s[0],t=[];for(let n=0;n<d.length;n++){let i=d[n],a=nV.TE(i,e);t.push({distance:a,index:n})}t.sort((e,t)=>e.distance-t.distance);let n=[t[0],t[1]],i=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=i}else{let e=nV.Ue();nV.$X(e,s[1],s[0]),nV.Fv(e,e);let n=[s[0][0]-6*e[0],s[0][1]-6*e[1]],a=aM(d,n,s[0],t);if(a){let e=[n];ay(i,e,s[0],this.commonData),s.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=s.length-1,this.editData.startCrossingIndex=a[0]}}}}function aA(e){let{editCanvasPoints:t,prevCanvasPoints:n}=this.editData,i=0;for(let a=0;a<t.length-1;a++){let o=[t[a],t[a+1]],r=!!aM(n,o[0],o[1],e);if(i++,r)break}t.splice(0,i),this.editData.editIndex=t.length-1}function aN(e,t){let n=e.detail,{currentPoints:i,lastPoints:a}=n,o=i.canvas,r=a.canvas,{prevCanvasPoints:l}=this.editData,s=aM(l,o,r,t);return!!s}function aL(e){let{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let i=n.length-1;i>0;i--){let a=[n[i],n[i-1]],o=!!aM(t,a[0],a[1],e);if(n.pop(),o)break}}function ax(){let{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;let i=e[e.length-1],a=[];for(let e=0;e<t.length;e++){let n=t[e],o=nV.TE(n,i);a.push({distance:o,index:e})}a.sort((e,t)=>e.distance-t.distance);let o=e.slice(0,-1);for(let n=0;n<a.length;n++){let{index:i}=a[n],r=t[i],l=e[e.length-1],s=aM(o,r,l,!1);if(!s)return i}return -1}function aZ(e){let t=e.detail,{currentPoints:n,lastPoints:i}=t,a=n.canvas,o=i.canvas,{editCanvasPoints:r}=this.editData,l=r.slice(0,-2),s=aM(l,a,o,!1);if(!s)return;let d=s[0],u=r.length-d;for(let e=0;e<u;e++)r.pop()}var aU=function(e){e.checkForFirstCrossing=aP.bind(e),e.removePointsUpUntilFirstCrossing=aA.bind(e),e.checkForSecondCrossing=aN.bind(e),e.findSnapIndex=ax.bind(e),e.removePointsAfterSecondCrossing=aL.bind(e),e.checkAndRemoveCrossesOnEditLine=aZ.bind(e)};let{getSubPixelSpacingAndXYDirections:ak,addCanvasPointsToArray:aR,calculateAreaOfPoints:aV}=b;function aH(e,t,n){this.isEditingClosed=!0;let i=e.detail,{currentPoints:a,element:o}=i,r=a.canvas,l=(0,Q.ZP)(o),{viewport:s}=l,d=t.data.polyline.map(s.worldToCanvas),{spacing:u,xDir:c,yDir:h}=ak(s,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:u,xDir:c,yDir:h,movingTextBox:!1},q.ZP.isInteractingWithTool=!0,o.addEventListener(e_.default.MOUSE_UP,this.mouseUpClosedContourEditCallback),o.addEventListener(e_.default.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),o.addEventListener(e_.default.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),o.addEventListener(e_.default.TOUCH_END,this.mouseUpClosedContourEditCallback),o.addEventListener(e_.default.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),o.addEventListener(e_.default.TOUCH_TAP,this.mouseUpClosedContourEditCallback),eX(o)}function aG(e){q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(e_.default.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(e_.default.TOUCH_TAP,this.mouseUpClosedContourEditCallback),eY(e)}function aW(e){let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{renderingEngine:l,viewport:s}=r,{viewportIdsToRender:d,xDir:u,yDir:c,spacing:h}=this.commonData,{editIndex:f,editCanvasPoints:g,startCrossingIndex:m}=this.editData,v=g[g.length-1],p=s.canvasToWorld(v),C=th.create();th.subtract(C,a,p);let E=Math.abs(th.dot(C,u)),_=Math.abs(th.dot(C,c));if(E<=h[0]&&_<=h[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);let T=aR(i,g,o,this.commonData);if(this.editData.editIndex=f+T,void 0===m&&g.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1===this.editData.snapIndex){this.finishEditAndStartNewEdit(e);return}this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==m&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),(0,tQ.Z)(l,d)}function aB(e){let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{viewport:a,renderingEngine:o}=i,{annotation:r,viewportIdsToRender:l}=this.commonData,{fusedCanvasPoints:s,editCanvasPoints:d}=this.editData,u=s.map(e=>a.canvasToWorld(e));r.data.polyline=u,r.data.isOpenContour=!1,this.triggerAnnotationModified(r,i);let c=d.pop();this.editData={prevCanvasPoints:s,editCanvasPoints:[c],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},(0,tQ.Z)(o,l)}function aF(e){let t,n;let{prevCanvasPoints:i,editCanvasPoints:a,startCrossingIndex:o,snapIndex:r}=this.editData;if(void 0===o||void 0===r)return;let l=e.detail,{element:s}=l,d=[...a];aR(s,d,i[r],this.commonData),d.length>a.length&&d.pop(),o>r?(t=r,n=o):(t=o,n=r);let u=nV.TE(i[t],d[0]),c=nV.TE(i[t],d[d.length-1]),h=nV.TE(i[n],d[0]),f=nV.TE(i[n],d[d.length-1]),g=[];for(let e=0;e<t;e++){let t=i[e];g.push([t[0],t[1]])}let m=u+f,v=c+h;if(m<v)for(let e=0;e<d.length;e++){let t=d[e];g.push([t[0],t[1]])}else for(let e=d.length-1;e>=0;e--){let t=d[e];g.push([t[0],t[1]])}for(let e=n;e<i.length;e++){let t=i[e];g.push([t[0],t[1]])}let p=[];for(let e=t;e<n;e++){let t=i[e];p.push([t[0],t[1]])}if((m=h+c)<(v=f+u))for(let e=0;e<d.length;e++){let t=d[e];p.push([t[0],t[1]])}else for(let e=d.length-1;e>=0;e--){let t=d[e];p.push([t[0],t[1]])}let C=aV(g),E=aV(p),_=C>E?g:p;return _}function a$(e){let t=e.detail,{element:n}=t;this.completeClosedContourEdit(n)}function aq(e){let t=(0,Q.ZP)(e),{viewport:n,renderingEngine:i}=t,{annotation:a,viewportIdsToRender:o}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:l}=this.editData;if(r){let e=as(this.configuration)?au(this.configuration,r,l):r,i=e.map(e=>n.canvasToWorld(e));a.data.polyline=i,a.data.isOpenContour=!1,a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,(0,tQ.Z)(i,o),this.deactivateClosedContourEdit(e)}function aj(e){this.completeClosedContourEdit(e)}var az=function(e){e.activateClosedContourEdit=aH.bind(e),e.deactivateClosedContourEdit=aG.bind(e),e.mouseDragClosedContourEditCallback=aW.bind(e),e.mouseUpClosedContourEditCallback=a$.bind(e),e.finishEditAndStartNewEdit=aB.bind(e),e.fuseEditPointsWithClosedContour=aF.bind(e),e.cancelClosedContourEdit=aj.bind(e),e.completeClosedContourEdit=aq.bind(e)};let{addCanvasPointsToArray:aK,getSubPixelSpacingAndXYDirections:aY}=b;function aX(e,t,n){this.isEditingOpen=!0;let i=e.detail,{currentPoints:a,element:o}=i,r=a.canvas,l=(0,Q.ZP)(o),{viewport:s}=l,d=t.data.polyline.map(s.worldToCanvas),{spacing:u,xDir:c,yDir:h}=aY(s,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[r],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:u,xDir:c,yDir:h,movingTextBox:!1},q.ZP.isInteractingWithTool=!0,o.addEventListener(e_.default.MOUSE_UP,this.mouseUpOpenContourEditCallback),o.addEventListener(e_.default.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),o.addEventListener(e_.default.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),o.addEventListener(e_.default.TOUCH_END,this.mouseUpOpenContourEditCallback),o.addEventListener(e_.default.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),o.addEventListener(e_.default.TOUCH_TAP,this.mouseUpOpenContourEditCallback),eX(o)}function aJ(e){q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(e_.default.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(e_.default.TOUCH_TAP,this.mouseUpOpenContourEditCallback),eY(e)}function aQ(e){let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{renderingEngine:l,viewport:s}=r,{viewportIdsToRender:d,xDir:u,yDir:c,spacing:h}=this.commonData,{editIndex:f,editCanvasPoints:g,startCrossingIndex:m}=this.editData,v=g[g.length-1],p=s.canvasToWorld(v),C=th.create();th.subtract(C,a,p);let E=Math.abs(th.dot(C,u)),_=Math.abs(th.dot(C,c));if(E<=h[0]&&_<=h[1])return;void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);let T=aK(i,g,o,this.commonData);this.editData.editIndex=f+T,void 0===m&&g.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==m&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),(0,tQ.Z)(l,d)}function a0(e){let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{viewport:a}=i,{annotation:o,viewportIdsToRender:r}=this.commonData,l=this.fuseEditPointsForOpenContourEndEdit(),s=l.map(e=>a.canvasToWorld(e));o.data.polyline=s,o.data.isOpenContour=!0,o.data.handles.points=[s[0],s[s.length-1]],o.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(o,i),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(e,o,r,null)}function a1(e){let t=e.detail,{currentPoints:n,lastPoints:i}=t,a=n.canvas,o=i.canvas,{snapIndex:r,prevCanvasPoints:l,startCrossingIndex:s}=this.editData;if(void 0===s||void 0===r)return!1;if(-1===r)return!0;if(0!==r&&r!==l.length-1)return!1;let d=l[r],u=nV.Ue(),c=nV.Ue();nV.t8(u,a[0]-o[0],a[1]-o[1]),nV.t8(c,a[0]-d[0],a[1]-d[1]);let h=nV.AK(u,c),f=Math.sqrt(u[0]*u[0]+u[1]*u[1]),g=Math.sqrt(c[0]*c[0]+c[1]*c[1]);return Math.acos(h/(f*g))<Math.PI/2}function a2(){let{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i}=this.editData,a=[];if(0===e)for(let e=t.length-1;e>=i;e--){let n=t[e];a.push([n[0],n[1]])}else for(let e=0;e<i;e++){let n=t[e];a.push([n[0],n[1]])}let o=nV.TE(t[i],n[0]),r=nV.TE(t[i],n[n.length-1]);if(o<r)for(let e=0;e<n.length;e++){let t=n[e];a.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){let t=n[e];a.push([t[0],t[1]])}return a}function a5(e){let t,n;let{prevCanvasPoints:i,editCanvasPoints:a,startCrossingIndex:o,snapIndex:r}=this.editData;if(void 0===o||void 0===r)return;let l=e.detail,{element:s}=l,d=[...a];aK(s,d,i[r],this.commonData),d.length>a.length&&d.pop(),o>r?(t=r,n=o):(t=o,n=r);let u=nV.TE(i[t],d[0]),c=nV.TE(i[t],d[d.length-1]),h=nV.TE(i[n],d[0]),f=nV.TE(i[n],d[d.length-1]),g=[];for(let e=0;e<t;e++){let t=i[e];g.push([t[0],t[1]])}if(u+f<c+h)for(let e=0;e<d.length;e++){let t=d[e];g.push([t[0],t[1]])}else for(let e=d.length-1;e>=0;e--){let t=d[e];g.push([t[0],t[1]])}for(let e=n;e<i.length;e++){let t=i[e];g.push([t[0],t[1]])}return g}function a3(e){let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{viewport:a,renderingEngine:o}=i,{annotation:r,viewportIdsToRender:l}=this.commonData,{fusedCanvasPoints:s,editCanvasPoints:d}=this.editData,u=s.map(e=>a.canvasToWorld(e));r.data.polyline=u,r.data.isOpenContour=!0,r.data.handles.points=[u[0],u[u.length-1]],this.triggerAnnotationModified(r,i);let c=d.pop();this.editData={prevCanvasPoints:s,editCanvasPoints:[c],startCrossingIndex:void 0,editIndex:0},(0,tQ.Z)(o,l)}function a4(e){let t=e.detail,{element:n}=t;this.completeOpenContourEdit(n)}function a8(e){let t=(0,Q.ZP)(e),{viewport:n,renderingEngine:i}=t,{annotation:a,viewportIdsToRender:o}=this.commonData,{fusedCanvasPoints:r,prevCanvasPoints:l}=this.editData;if(r){let e=as(this.configuration)?au(this.configuration,r,l):r,i=e.map(e=>n.canvasToWorld(e));a.data.polyline=i,a.data.isOpenContour=!0,a.data.handles.points=[i[0],i[i.length-1]],a.data.isOpenUShapeContour&&(a.data.openUShapeContourVectorToPeak=ac(r,n)),a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,(0,tQ.Z)(i,o),this.deactivateOpenContourEdit(e)}function a9(e){this.completeOpenContourEdit(e)}var a7=function(e){e.activateOpenContourEdit=aX.bind(e),e.deactivateOpenContourEdit=aJ.bind(e),e.mouseDragOpenContourEditCallback=aQ.bind(e),e.mouseUpOpenContourEditCallback=a4.bind(e),e.fuseEditPointsWithOpenContour=a5.bind(e),e.finishEditOpenOnSecondCrossing=a3.bind(e),e.checkIfShouldOverwriteAnEnd=a1.bind(e),e.fuseEditPointsForOpenContourEndEdit=a2.bind(e),e.openContourEditOverwriteEnd=a0.bind(e),e.cancelOpenContourEdit=a9.bind(e),e.completeOpenContourEdit=a8.bind(e)};let{getSubPixelSpacingAndXYDirections:a6}=b;function oe(e,t,n,i){this.isDrawing=!0;let a=e.detail,{element:o}=a,r=(0,Q.ZP)(o),{viewport:l}=r,{spacing:s,xDir:d,yDir:u}=a6(l,this.configuration.subPixelResolution),c=t.data.polyline.map(l.worldToCanvas),h=t.data.handles.activeHandleIndex;0===h&&c.reverse();let f=!1;i.worldPosition&&(f=!0),this.drawData={canvasPoints:c,polylineIndex:c.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:s,xDir:d,yDir:u,movingTextBox:f},q.ZP.isInteractingWithTool=!0,o.addEventListener(e_.default.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(e_.default.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(e_.default.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(e_.default.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(e_.default.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(e_.default.TOUCH_TAP,this.mouseUpDrawCallback),eX(o)}var ot=function(e){e.activateOpenContourEndEdit=oe.bind(e)};let{pointsAreWithinCloseContourProximity:on}=b;function oi(e,t){let n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},i=this.getStyle("lineWidth",n,t),a=this.getStyle("lineDash",n,t),o=this.getStyle("color",n,t),r=t.data.isOpenContour;return{color:void 0===o?void 0:o,width:void 0===i?void 0:i,lineDash:void 0===a?void 0:a,connectLastToFirst:!r}}function oa(e,t,n){if(e?.viewport?.getImageData())n.data.isOpenContour?n.data.isOpenUShapeContour?(n.data.openUShapeContourVectorToPeak||(n.data.openUShapeContourVectorToPeak=function(e,t){let{viewport:n}=e,i=t.data.polyline.map(n.worldToCanvas);return ac(i,n)}(e,n)),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n)}function oo(e,t,n){let{viewport:i}=e,a=this._getRenderingOptions(e,n),o=n.data.polyline.map(e=>i.worldToCanvas(e));tx(t,n.annotationUID,"1",o,a)}function or(e,t,n){let{viewport:i}=e,a=this._getRenderingOptions(e,n),o=n.data.polyline.map(e=>i.worldToCanvas(e));tx(t,n.annotationUID,"1",o,a);let r=n.data.handles.activeHandleIndex;if(this.configuration.alwaysRenderOpenContourHandles?.enabled===!0){let e=this.configuration.alwaysRenderOpenContourHandles.radius,i=[o[0],o[o.length-1]];0===r?i.shift():1===r&&i.pop(),tN(t,n.annotationUID,"0",i,{color:a.color,handleRadius:e})}if(null!==r){let e=0===r?0:o.length-1,i=o[e];tN(t,n.annotationUID,"1",[i],{color:a.color})}}function ol(e,t,n){let{viewport:i}=e,{polyline:a,openUShapeContourVectorToPeak:o}=n.data;if(this.renderOpenContour(e,t,n),!o)return;let r=i.worldToCanvas(a[0]),l=i.worldToCanvas(a[a.length-1]),s=[i.worldToCanvas(o[0]),i.worldToCanvas(o[1])],d=this._getRenderingOptions(e,n);tx(t,n.annotationUID,"first-to-last",[r,l],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),tx(t,n.annotationUID,"midpoint-to-open-contour",[s[0],s[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}function os(e,t,n){let i=this._getRenderingOptions(e,n),{allowOpenContours:a}=this.configuration,{canvasPoints:o}=this.drawData;if(i.connectLastToFirst=!1,tx(t,n.annotationUID,"1",o,i),a){let e=o[0],a=o[o.length-1];on(e,a,this.configuration.closeContourProximity)?tx(t,n.annotationUID,"2",[a,e],i):tN(t,n.annotationUID,"0",[e],{color:i.color,handleRadius:2})}}function od(e,t,n){let{fusedCanvasPoints:i}=this.editData;if(void 0===i){this.renderClosedContour(e,t,n);return}let a=this._getRenderingOptions(e,n);tx(t,n.annotationUID,"preview-1",i,a)}function ou(e,t,n){let{fusedCanvasPoints:i}=this.editData;if(void 0===i){this.renderOpenContour(e,t,n);return}let a=this._getRenderingOptions(e,n);tx(t,n.annotationUID,"preview-1",i,a)}var oc=function(e){e.renderContour=oa.bind(e),e.renderClosedContour=oo.bind(e),e.renderOpenContour=or.bind(e),e.renderOpenUShapedContour=ol.bind(e),e.renderContourBeingDrawn=os.bind(e),e.renderClosedContourBeingEdited=od.bind(e),e.renderOpenContourBeingEdited=ou.bind(e),e._getRenderingOptions=oi.bind(e)};let{pointCanProjectOnLine:oh}=b,{EPSILON:of}=nW,og=1-of;class om extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o,s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=nk(i,this.getToolName()),f=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:f,referencedImageId:c,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...a]],label:"",cachedStats:{}}};return(0,tB.addAnnotation)(g,i),this.activateDraw(e,g,h),e.preventDefault(),(0,tQ.Z)(l,h),g},this.handleSelectedCallback=(e,t,n)=>{let i=e.detail,{element:a}=i,o=nk(a,this.getToolName());this.activateOpenContourEndEdit(e,t,o,n)},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n,a=nk(i,this.getToolName());t.data.isOpenContour?this.activateOpenContourEdit(e,t,a):this.activateClosedContourEdit(e,t,a)},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,r=t.data.polyline,l=o.worldToCanvas(r[0]);for(let e=1;e<r.length;e++){let t=l,a=o.worldToCanvas(r[e]),s=oh(n,t,a,i);if(!0===s)return!0;l=a}if(t.data.isOpenContour)return!1;let s=o.worldToCanvas(r[0]),d=o.worldToCanvas(r[r.length-1]),u=oh(n,s,d,i);return!0===u},this.cancel=e=>{let t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)},this.triggerAnnotationModified=(e,t)=>{let{viewportId:n,renderingEngineId:i}=t,a=e_.default.ANNOTATION_MODIFIED;(0,ep.Z)(eC.Z,a,{annotation:e,viewportId:n,renderingEngineId:i})},this.triggerAnnotationCompleted=e=>{let t=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,t,{annotation:e})},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i,renderingEngine:a}=e,{element:o}=i,r=this.getTargetId(i),l=(0,tB.getAnnotations)(this.getToolName(),o);if(!l?.length||(l=this.filterInteractableAnnotationsForElement(o,l),!l?.length))return n;let s=this.isDrawing,d=this.isEditingOpen,u=this.isEditingClosed;if(s||d||u){let i=this.commonData.annotation.annotationUID;l.forEach(n=>{if(n.annotationUID===i){if(s)this.renderContourBeingDrawn(e,t,n);else if(u)this.renderClosedContourBeingEdited(e,t,n);else if(d)this.renderOpenContourBeingEdited(e,t,n);else throw Error(`Unknown ${this.getToolName()} annotation rendering state`)}else this.renderContour(e,t,n)}),n=!0}else l.forEach(n=>{this.renderContour(e,t,n)});if(this.configuration.calculateStats)return l.forEach(n=>{let o=this.commonData?.annotation.annotationUID;if(n.annotationUID===o&&!this.commonData?.movingTextBox)return;let l={isPreScaled:ia(i,r),isSuvScaled:this.isSuvScaled(i,r,n.metadata.referencedImageId)};if(!this.commonData?.movingTextBox){let{data:t}=n;t.cachedStats[r]&&void 0!==t.cachedStats[r].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,i,a,e,l):(t.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,i,a,e,l))}this._renderStats(n,i,e,t)}),n},this._calculateCachedStats=(e,t,n,i,a)=>{let o=e.data,{cachedStats:r,polyline:l}=o,s=Object.keys(r);for(let i=0;i<s.length;i++){let o=s[i],d=this.getTargetIdImage(o,n);if(!d)continue;let{imageData:u,metadata:c}=d,h=l.map(e=>t.worldToCanvas(e)),f=n3(d),g=ij(h)/f/f,m=t9.Z(u,l[0]);m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]);let v=m[0],p=m[0],C=m[1],E=m[1],_=m[2],T=m[2];for(let e=1;e<l.length;e++){let t=t9.Z(u,l[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),v=Math.min(v,t[0]),p=Math.max(p,t[0]),C=Math.min(C,t[1]),E=Math.max(E,t[1]),_=Math.min(_,t[2]),T=Math.max(T,t[2])}let I=.01*(p-v),w=.01*(E-C),b=.01*(T-_);v=Math.floor(v-I),p=Math.ceil(p+I),C=Math.floor(C-w),E=Math.ceil(E+w),_=Math.floor(_-b),T=Math.ceil(T+b);let S=[[v,p],[C,E],[_,T]],D=u.indexToWorld([p,E,T]),O=t.worldToCanvas(D),y=0,M=0,P=0,A=-1/0,N=({value:e})=>{e>A&&(A=e),M+=e,P+=e**2,y+=1},L=0,x=[],Z=0;t1(u,(e,n)=>{let i=!0,a=t.worldToCanvas(e);return a[1]!=L&&(Z=0,L=a[1],(x=function(e,t,n,i=!0){let a=[],o=function(e,t,n,i=!0){let a,o;let r=[];i?(o=e.length-1,a=0):(o=0,a=1);for(let i=a;i<e.length;i++){let a=e[o],l=e[i];iH(t,n,a,l)&&r.push([o,i]),o=i}return r}(e,t,n,i);for(let i=0;i<o.length;i++){let r=e[o[i][0]],l=e[o[i][1]],s=function(e,t,n,i){let a=(i[1]-n[1])*(t[0]-e[0])-(i[0]-n[0])*(t[1]-e[1]);if(0==a)return;let o=e[1]-n[1],r=e[0]-n[0],l=(i[0]-n[0])*o-(i[1]-n[1])*r,s=(t[0]-e[0])*o-(t[1]-e[1])*r;o=l/a,r=s/a;let d=e[0]+o*(t[0]-e[0]),u=e[1]+o*(t[1]-e[1]);return[d,u]}(t,n,r,l);a.push(s)}return a}(h,a,[O[0],a[1]])).sort(function(e){return function(t,n){return t[e]===n[e]?0:t[e]<n[e]?-1:1}}(0))),x.length&&a[0]>x[0][0]&&(x.shift(),Z++),Z%2==0&&(i=!1),i},N,S);let U=M/y,k=P/y-U**2;k=Math.sqrt(k);let R=ii(c.Modality,e.metadata.referencedImageId,a);r[o]={Modality:c.Modality,area:g,mean:U,max:A,stdDev:k,areaUnit:n5(null,d),modalityUnit:R}}return this.triggerAnnotationModified(e,i),e.invalidated=!1,r},this._renderStats=(e,t,n,i)=>{let a=e.data,o=this.getTargetId(t),r=this._getTextLines(a,o);if(!r||0===r.length)return;let l=a.polyline.map(e=>t.worldToCanvas(e));if(!a.handles.textBox.hasMoved){let e=ie(l);a.handles.textBox.worldPosition=t.canvasToWorld(e)}let s=t.worldToCanvas(a.handles.textBox.worldPosition),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},u=tH(i,e.annotationUID??"","1",r,s,l,{},this.getLinkedTextBoxStyle(d,e)),{x:c,y:h,width:f,height:g}=u;a.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([c,h]),topRight:t.canvasToWorld([c+f,h]),bottomLeft:t.canvasToWorld([c,h+g]),bottomRight:t.canvasToWorld([c+f,h+g])}},this._getTextLines=(e,t)=>{let n=e.cachedStats[t],{area:i,mean:a,stdDev:o,max:r,isEmptyArea:l,areaUnit:s,modalityUnit:d}=n,u=[];if(i){let e=l?"Area: Oblique not supported":`Area: ${t4(i)} ${s}`;u.push(e)}return a&&u.push(`Mean: ${t4(a)} ${d}`),r&&u.push(`Max: ${t4(r)} ${d}`),o&&u.push(`Std Dev: ${t4(o)} ${d}`),u},aO(this),aU(this),az(this),a7(this),ot(this),oc(this),this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){let n;if(!t||!t.length)return;let i=(0,Q.ZP)(e),{viewport:a}=i;if(a instanceof tr.Z)n=nq(a,t);else if(a instanceof tm.Z){let e=a.getCamera(),{spacingInNormalDirection:i}=nG.Z(a,e);n=this.filterAnnotationsWithinSlice(t,e,i)}else throw Error(`Viewport Type ${a.type} not supported`);return n}filterAnnotationsWithinSlice(e,t,n){let{viewPlaneNormal:i}=t,a=e.filter(e=>{let t=e.metadata.viewPlaneNormal,n=Math.abs(th.dot(i,t))>og;return t&&n});if(!a.length)return[];let o=n/2,{focalPoint:r}=t,l=[];for(let e of a){let t=e.data,n=t.polyline[0];if(!e.isVisible)continue;let a=th.create();th.sub(a,r,n);let s=th.dot(a,i);Math.abs(s)<o&&l.push(e)}return l}}om.toolName="PlanarFreehandROI";var ov=om;function op(e,t,n){if(function(e,t,n){if(!t?.data?.polyline||n<=0||!e.viewport)return!0;let{renderingEngineId:i,viewportId:a,FrameOfReferenceUID:o}=e,r=e7.Z(a,i);if(t.metadata.FrameOfReferenceUID!==o||!r)return!0;let l=r.getToolInstance(t.metadata.toolName);return!(l instanceof ov)||l.isDrawing||l.isEditingOpen||l.isEditingClosed}(e,t,n))return!1;let{viewport:i}=e,a=t.data.polyline.map(i.worldToCanvas),o=al(a,0,a.length,n);return o!==a&&(t.data.polyline=o.map(i.canvasToWorld),!0)}var oC={interpolateAnnotation:op},oE=n(62416),o_=n(14688),oT=n(76342),oI=n(64060);let ow={};function ob(e){let t=(0,Q.ZP)(e),{viewportId:n}=t;return ow[n]}let oS=oE.Z.Prefetch,oD={maxImagesToPrefetch:1/0,preserveExistingPool:!1};function oO(e){let t=(0,Q.ZP)(e);if(!t)throw Error("stackPrefetch: element must be a valid Cornerstone enabled element");let{viewport:n}=t;if(!(n instanceof tr.Z))throw Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function oy(e){var t,n;let i,a,o,r;let l=ob(e);if(!l)return;let s=l||{},d=oO(e);if(!d||!d.imageIds||0===d.imageIds.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}if(s.indicesToRequest&&s.indicesToRequest.length||(s.enabled=!1),!1===s.enabled)return;l.indicesToRequest.sort((e,t)=>e-t);let u=s.indicesToRequest.slice();if(u.forEach(function(e){let t=d.imageIds[e];if(!t)return;let n=t7.ZP.getImageLoadObject(t);n&&function(e){let t=s.indicesToRequest.indexOf(e);t>-1&&s.indicesToRequest.splice(t,1)}(e)}),!s.indicesToRequest.length)return;oD.preserveExistingPool||o_.Z.clearRequestStack(oS);let c=(t=s.indicesToRequest,n=d.currentImageIdIndex,o=0,r=t.length-1,t.forEach((e,t)=>{e<n?o=Math.max(t,o):e>n&&(r=Math.min(t,r))}),{low:o,high:r}),h=c.low,f=c.high,g=[];for(;h>=0||f<s.indicesToRequest.length;){let e=d.currentImageIdIndex,t=e-s.indicesToRequest[h]>oD.maxImagesToPrefetch,n=s.indicesToRequest[f]-e>oD.maxImagesToPrefetch,o=!t&&h>=0,r=!n&&f<s.indicesToRequest.length;if(!r&&!o)break;o&&(a=s.indicesToRequest[h--],i=d.imageIds[a],g.push(i)),r&&(a=s.indicesToRequest[f++],i=d.imageIds[a],g.push(i))}let m=(e,t)=>oT.loadAndCacheImage(e,t),{useNorm16Texture:v}=(0,oI.P_)().rendering;g.forEach(e=>{o_.Z.addRequest(m.bind(null,e,{targetBuffer:{type:v?void 0:"Float32Array"},preScale:{enabled:!0},requestType:oS}),oS,{imageId:e},0)})}function oM(e){return function(t){let n;let i=t.detail;try{n=oO(e)}catch(e){return}if(!n||!n.imageIds||0===n.imageIds.length)return;let a=n,o=a.imageIds.indexOf(i.imageId);if(o<0)return;let r=ob(e);r&&r.data&&r.data.length&&r.indicesToRequest.push(o)}}function oP(e){clearTimeout(i),i=setTimeout(function(){let t=e.target;try{oy(t)}catch(e){return}},10)}function oA(e){let t=oO(e);if(!t||!t.imageIds||0===t.imageIds.length){console.warn("CornerstoneTools.stackPrefetch: No images in stack.");return}let n={indicesToRequest:function(e,t){e=Math.round(e)||0,t=Math.round(t)||0;let n=[],i=t-e+1;if(i<=0)return n;for(;i--;)n[i]=t--;return n}(0,t.imageIds.length-1),enabled:!0,direction:1},i=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(i,1),function(e,t){let n=(0,Q.ZP)(e),{viewportId:i}=n;ow[i]=t}(e,n),oy(e),e.removeEventListener(et.default.STACK_NEW_IMAGE,oP),e.addEventListener(et.default.STACK_NEW_IMAGE,oP);let a=oM(e);eC.Z.removeEventListener(et.default.IMAGE_CACHE_IMAGE_REMOVED,a),eC.Z.addEventListener(et.default.IMAGE_CACHE_IMAGE_REMOVED,a)}function oN(e){clearTimeout(i),e.removeEventListener(et.default.STACK_NEW_IMAGE,oP);let t=oM(e);eC.Z.removeEventListener(et.default.IMAGE_CACHE_IMAGE_REMOVED,t);let n=ob(e);n&&n.data.length&&(n.enabled=!1,o_.Z.clearRequestStack(oS))}function oL(){return oD}function ox(e){oD=e}function oZ(e,t){if(!(e instanceof tm.Z))return;let{focalPoint:n}=e.getCamera(),i=[0,0,0];return th.sub(i,t,n),function(e,t){let n=e.getCamera(),i=n.viewPlaneNormal,a=th.dot(t,i),o=th.fromValues(i[0],i[1],i[2]);if(th.scale(o,o,a),Math.abs(o[0])>.001||Math.abs(o[1])>.001||Math.abs(o[2])>.001){let t=[0,0,0],i=[0,0,0];th.add(t,n.focalPoint,o),th.add(i,n.position,o),e.setCamera({focalPoint:t,position:i}),e.render()}}(e,i),!0}var oU=n(40833),ok=function(e,t){let n;let i=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw Error("No ROI provided");if(t.maskVolumeId&&t.imageCoordinate)throw Error("Please provide only one ROI");if(t.maskVolumeId){let n=t7.ZP.getVolume(t.maskVolumeId),a=n.getScalarData().map((e,t)=>t).filter(e=>0!==n.getScalarData()[e]),o=function(e,t,n){let i=n.getScalarDataArrays(),a=[];for(let n=0;n<t.length;n++){let o=[];e.forEach(e=>{let a=i[e];o.push(a[t[n]])}),a.push(o)}return a}(i,a,e);return o}if(t.imageCoordinate){let n=function(e,t,n){let{dimensions:i,imageData:a}=n,o=a.worldToIndex(t);if(o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o[2]=Math.floor(o[2]),!nQ.Z(o,i))throw Error("outside bounds");let r=i[0],l=i[0]*i[1],s=n.getScalarDataArrays(),d=[];return e.forEach(e=>{let t=o[2]*l+o[1]*r+o[0];d.push(s[e][t])}),d}(i,t.imageCoordinate,e);return n}return n},oR=n(25778),oV=function(e,t,n){let i=n||[...Array(e.numTimePoints).keys()],a=i.length;if(i.length<=1)throw Error("Please provide two or more time points");let o=e.getScalarDataArrays(),r=o[0].length,l=new Float32Array(r);if(t===oR.Z.SUM){for(let e=0;e<a;e++){let t=o[i[e]];for(let e=0;e<r;e++)l[e]+=t[e]}return l}if(t===oR.Z.SUBTRACT){if(i.length>2)throw Error("Please provide only 2 time points for subtraction.");for(let e=0;e<r;e++)l[e]+=o[i[0]][e]-o[i[1]][e];return l}if(t===oR.Z.AVERAGE){for(let e=0;e<a;e++){let t=o[i[e]];for(let e=0;e<r;e++)l[e]+=t[e]}for(let e=0;e<r;e++)l[e]=l[e]/a;return l}},oH=function(e,t){let n=e$.getDefinedCursor(t,!0);n||(n=ew.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=ew.getDefinedCursor(t)),eK(e,n)};let oG=[...eV,...eS];var oW=function(e,t,n){let i=eW("textBoxFontSize",e,t,n),a=eW("textBoxFontFamily",e,t,n);return`${i}px ${a}`},oB=n(87885),oF=n(15340),o$=function(e){if(!e.representation.data)throw Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");let t=e.representation.data;if(!t.volumeId)throw Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");let n=t7.ZP.getVolume(t.volumeId);if(!n)throw Error(`volumeId of ${t.volumeId} not found in cache, you should load and cache volume before adding segmentation`)},oq=function(e){if(!e||!e.length)throw Error("The segmentationInputArray is undefined or empty array");e.forEach(e=>{if(void 0===e.segmentationId)throw Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===iT.Z.Labelmap&&o$(e)})},oj=function(e){oq(e),e.map(e=>{let t=ef()(e);(0,nu.addSegmentation)(t)})},oz=n(32884),oK=n(23165);async function oY(e,t,n){let i;if(t.type===iT.Z.Labelmap)i=await oz.Z.addSegmentationRepresentation(e,t,n);else if(t.type===iT.Z.Contour)i=await oK.Z.addSegmentationRepresentation(e,t,n);else throw Error(`The representation type ${t.type} is not supported`);return i}var oX=async function(e,t,n){let i=(0,e9.Z)(e);if(!i)throw Error(`No tool group found for toolGroupId: ${e}`);let a=t.map(t=>oY(e,t,n)),o=await Promise.all(a);return o},oJ=n(70359),oQ=n(46990);class o0 extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){let{element:t,deltaPoints:n}=e.detail,i=(0,Q.ZP)(t),a=n.world,o=i.viewport.getCamera(),{focalPoint:r,position:l}=o,s=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],d=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];i.viewport.setCamera({focalPoint:d,position:s}),i.viewport.render()}}o0.toolName="Pan";var o1=o0,o2=n(85975);class o5 extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this.rotateCamera=(e,t,n,i)=>{let a=e.getVtkActiveCamera(),o=a.getViewUp(),r=a.getFocalPoint(),l=a.getPosition(),s=[0,0,0],d=[0,0,0],u=[0,0,0],c=o2.identity(new Float32Array(16));o2.translate(c,c,t),o2.rotate(c,c,i,n),o2.translate(c,c,[-t[0],-t[1],-t[2]]),th.transformMat4(s,l,c),th.transformMat4(d,r,c),o2.identity(c),o2.rotate(c,c,i,n),th.transformMat4(u,o,c),e.setCamera({position:s,viewUp:u,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){let{element:t,currentPoints:n,lastPoints:i}=e.detail,a=n.canvas,o=i.canvas,{rotateIncrementDegrees:r}=this.configuration,l=(0,Q.ZP)(t),{viewport:s}=l,d=s.getCamera(),u=t.clientWidth,c=t.clientHeight,h=[a[0]/u,a[1]/c],f=[o[0]/u,o[1]/c],g=s.canvasToWorld([.5*u,.5*c]),m=(1+Math.abs(.5))**2,v=[f[0],0,0],p=[h[0],0,0],C=v[0]**2,E=p[0]**2,_=[v[0],0,C>m?0:Math.sqrt(m-C)];iK.ZP.normalize(_);let T=[p[0],0,E>m?0:Math.sqrt(m-E)];iK.ZP.normalize(T);let I=iK.ZP.dot(_,T);if(Math.abs(I)>1e-4){let e=-2*Math.acos(iK.ZP.clampValue(I,-1,1))*Math.sign(h[0]-f[0])*r,t=d.viewUp,n=d.viewPlaneNormal,i=[0,0,0],a=[0,0,0];iK.ZP.cross(t,n,i),iK.ZP.normalize(i),iK.ZP.cross(n,i,a),iK.ZP.normalize(a),iK.ZP.normalize(t),this.rotateCamera(s,g,a,e);let o=(f[1]-h[1])*r;this.rotateCamera(s,g,i,o),s.render()}}}o5.toolName="TrackballRotate";var o3=o5,o4=n(53609);let{transformWorldToIndex:o8}=tK;class o9 extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,newAnnotation:!0,viewportIdsToRender:g},this._activateModify(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o}=this.editData,r=(0,Q.ZP)(n),{renderingEngine:l}=r,{viewportId:s}=r;if(this.eventDispatchDetail={viewportId:s,renderingEngineId:l.id},this._deactivateModify(n),eY(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(l,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:o,viewportIdsToRender:r}=this.editData,{data:l}=o;l.handles.points[0]=[...a],o.invalidated=!0;let s=(0,Q.ZP)(i),{renderingEngine:d}=s;(0,tQ.Z)(d,r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d=o[a],u=d.annotationUID,c=d.data,h=c.handles.points[0],f=i.worldToCanvas(h);s.annotationUID=u;let g=this.getStyle("color",s,d),m={isPreScaled:ia(i,r),isSuvScaled:this.isSuvScaled(i,r,d.metadata.referencedImageId)};if(c.cachedStats[r]){if(d.invalidated&&(this._calculateCachedStats(d,l,e,m),i instanceof tm.Z)){let{referencedImageId:e}=d.metadata;for(let t in c.cachedStats)if(t.startsWith("imageId")){let n=l.getStackViewports(),i=n.find(t=>{let n=nH.Z(e),i=t.hasImageURI(n),a=nH.Z(t.getCurrentImageId());return i&&a!==n});i&&delete c.cachedStats[t]}}}else c.cachedStats[r]={Modality:null,index:null,value:null},this._calculateCachedStats(d,l,e,m);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}tN(t,u,"0",[f],{color:g}),n=!0;let v=this._getTextLines(c,r);if(v){let e=[f[0]+6,f[1]-6];tk(t,u,"0",v,[e[0],e[1]],this.getLinkedTextBoxStyle(s,d))}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,i){let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,l=r.handles.points[0],s=o.worldToCanvas(l),d=nV.TE(n,s)<i;if(!0===d)return l}handleSelectedCallback(e,t){let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),eX(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()}_getTextLines(e,t){let n=e.cachedStats[t],{index:i,value:a,modalityUnit:o}=n;if(void 0===a)return;let r=[];return r.push(`(${i[0]}, ${i[1]}, ${i[2]})`),r.push(`${a.toFixed(2)} ${o}`),r}_calculateCachedStats(e,t,n,i){let a=e.data,{viewportId:o,renderingEngineId:r}=n,l=a.handles.points[0],{cachedStats:s}=a,d=Object.keys(s);for(let n=0;n<d.length;n++){let a=d[n],u=this.getTargetIdImage(a,t);if(!u)continue;let{dimensions:c,imageData:h,metadata:f}=u,g="getScalarData"in u?u.getScalarData():u.scalarData,m=f.Modality,v=o8(h,l);if(v[0]=Math.round(v[0]),v[1]=Math.round(v[1]),v[2]=Math.round(v[2]),nQ.Z(v,c)){this.isHandleOutsideImage=!1;let t=c[0],n=c[0]*c[1],o=g[v[2]*n+v[1]*t+v[0]];if(a.startsWith("imageId:")){let e=a.split("imageId:")[1],t=nH.Z(e),n=o4.Z(t,r),i=n[0];v[2]=i.getCurrentImageIdIndex()}let l=ii(m,e.metadata.referencedImageId,i);s[a]={index:v,value:o,Modality:m,modalityUnit:l}}else this.isHandleOutsideImage=!0,s[a]={index:v,Modality:m};e.invalidated=!1;let p=e_.default.ANNOTATION_MODIFIED,C={annotation:e,viewportId:o,renderingEngineId:r};(0,ep.Z)(eC.Z,p,C)}return s}}o9.toolName="Probe";var o7=o9;class o6 extends o7{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.postMouseDownCallback=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:c},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}},f=nk(i,this.getToolName());return this.editData={annotation:h,newAnnotation:!0,viewportIdsToRender:f},this._activateModify(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,f),h},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e;if(!this.editData)return n;let a=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!a?.length)return n;let o=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s=this.editData.annotation,d=s.annotationUID,u=s.data,c=u.handles.points[0],h=i.worldToCanvas(c);l.annotationUID=d;let f=this.getStyle("color",l,s),g={isPreScaled:ia(i,o),isSuvScaled:this.isSuvScaled(i,o,s.metadata.referencedImageId)};if(u.cachedStats[o]?s.invalidated&&this._calculateCachedStats(s,r,e,g):(u.cachedStats[o]={Modality:null,index:null,value:null},this._calculateCachedStats(s,r,e,g)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;tN(t,d,"0",[h],{color:f}),n=!0;let m=this._getTextLines(u,o);if(m){let e=[h[0]+6,h[1]-6];tk(t,d,"0",m,[e[0],e[1]],this.getLinkedTextBoxStyle(l,s))}return n}}}o6.toolName="DragProbe";var re=o6,rt=n(42519),rn=n(58953);class ri extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{let n,i;let a=Math.floor(t[2]/2),o=t[0]*t[1];e instanceof Float32Array?(n=4,i=Float32Array):e instanceof Uint8Array?(n=1,i=Uint8Array):e instanceof Uint16Array?(n=2,i=Uint16Array):e instanceof Int16Array&&(n=2,i=Int16Array);let r=e.buffer,l=a*o*n,s=new i(r,l,o),{max:d,min:u}=this._getMinMax(s,o);return d-u}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){let t,n,i,a,o,r;let{element:l,deltaPoints:s}=e.detail,d=(0,Q.ZP)(l),{renderingEngine:u,viewport:c}=d,h=!1;if(c instanceof tm.Z){let e=this.getTargetId(c);t=e.split("volumeId:")[1],r=rt.Z(t,u.id);let o=c.getProperties();({lower:n,upper:i}=o.voiRange);let l=t7.ZP.getVolume(t);a=l.metadata.Modality,h=l.scaling&&Object.keys(l.scaling).length>0}else if(c instanceof tr.Z){let e=c.getProperties();a=c.modality,{lower:n,upper:i}=e.voiRange;let{preScale:t}=c.getImageData();h=t.scaled&&t.scalingParameters?.suvbw!==void 0}else throw Error("Viewport is not a valid type");if(o="PT"===a?this.getPTScaledNewRange({deltaPointsCanvas:s.canvas,lower:n,upper:i,clientHeight:l.clientHeight,isPreScaled:h,viewport:c,volumeId:t}):this.getNewRange({viewport:c,deltaPointsCanvas:s.canvas,volumeId:t,lower:n,upper:i}),c instanceof tr.Z){c.setProperties({voiRange:o}),c.render();return}if(c instanceof tm.Z){c.setProperties({voiRange:o}),r.forEach(e=>{e.render()});return}}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:a,volumeId:o,isPreScaled:r}){let l=4;l=r?5/i:this._getMultiplierFromDynamicRange(a,o)||4;let s=e[1],d=s*l;return n-=d,{lower:t,upper:n=r?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:i,upper:a}){let o=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*o,l=t[1]*o,{windowWidth:s,windowCenter:d}=rn.toWindowLevel(i,a);return s+=r,d+=l,s=Math.max(s,1),rn.toLowHighRange(s,d)}_getMultiplierFromDynamicRange(e,t){let n;if(t){let e=t7.ZP.getVolume(t),{dimensions:i}=e,a=e.getScalarData(),o=this._getImageDynamicRangeFromMiddleSlice(a,i),r=e?.metadata?.BitsStored;n=Math.min(o,r?2**r:1/0)}else n=this._getImageDynamicRangeFromViewport(e);let i=n/1024,a=4;return i>1&&(a=Math.round(i)),a}_getImageDynamicRangeFromViewport(e){let t,n;let{imageData:i}=e.getImageData(),a=i.getDimensions();if(t=i.getScalarData?i.getScalarData():i.getPointData().getScalars(),1!==a[2])return this._getImageDynamicRangeFromMiddleSlice(t,a);if(t.getRange)n=t.getRange();else{let{min:e,max:i}=this._getMinMax(t,t.length);n=[e,i]}return n[1]-n[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let a=0;a<t;a++){let t=e[a];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}ri.toolName="WindowLevel";var ra=ri;class ro extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{element:n,currentPoints:i}=t,a=i.world,o=(0,Q.ZP)(n),r=o.viewport.getCamera(),{focalPoint:l}=r;this.initialMousePosWorld=a;let s=th.fromValues(l[0]-a[0],l[1]-a[1],l[2]-a[2]);return s=th.normalize(th.create(),s),this.dirVec=s,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{let{element:a,deltaPoints:o}=e.detail,r=i?e.detail.deltaDistance.canvas:o.canvas[1],l=[a.clientWidth,a.clientHeight],{parallelScale:s,focalPoint:d,position:u}=n,c=1.5/l[1],h=r*c*(this.configuration.invert?-1:1),f=(1-h)*s,g=d,m=u;if(!this.configuration.zoomToCenter){let e=th.distance(d,this.initialMousePosWorld),t=5/l[1],n=r*t*(this.configuration.invert?-1:1);f=(1-n)*s,m=th.scaleAndAdd(th.create(),u,this.dirVec,-e*n),g=th.scaleAndAdd(th.create(),d,this.dirVec,-e*n)}let v=t.getImageData(),p=[1,1,1];v&&(p=v.spacing);let{minZoomScale:C,maxZoomScale:E}=this.configuration,_=a.clientHeight*p[1]*.5,T=_/f,I=f,w=!1;v&&(T<C?(I=_/C,w=!0):T>=E&&(I=_/E,w=!0)),t.setCamera({parallelScale:I,focalPoint:w?d:g,position:w?u:m})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{let{element:a,deltaPoints:o}=e.detail,r=i?e.detail.deltaDistance.canvas:o.canvas[1],{position:l,focalPoint:s,viewPlaneNormal:d}=n,u=iK.ZP.distance2BetweenPoints(l,s),c=Math.sqrt(u)/(a.clientWidth,a.clientHeight),h=[-d[0],-d[1],-d[2]],f=this.configuration.invert?r/c:r*c,g=f*h[0];l[0]+=g,s[0]+=g,g=f*h[1],l[1]+=g,s[1]+=g,g=f*h[2],l[2]+=g,s[2]+=g,t.setCamera({position:l,focalPoint:s})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){let t=e.detail.currentPointsList;if(t.length>1){let{element:t,currentPoints:n}=e.detail,i=(0,Q.ZP)(t),{viewport:a}=i,o=a.getCamera(),r=n.world,{focalPoint:l}=o;this.initialMousePosWorld=r;let s=th.fromValues(l[0]-r[0],l[1]-r[1],l[2]-r[2]);s=th.normalize(th.create(),s),this.dirVec=s,o.parallelProjection?this._dragParallelProjection(e,a,o,!0):this._dragPerspectiveProjection(e,a,o,!0),a.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){let{element:t}=e.detail,n=(0,Q.ZP)(t),{viewport:i}=n,a=i.getCamera();a.parallelProjection?this._dragParallelProjection(e,i,a):this._dragPerspectiveProjection(e,i,a),i.render()}_panCallback(e){let{element:t,deltaPoints:n}=e.detail,i=(0,Q.ZP)(t),a=n.world,o=i.viewport.getCamera(),{focalPoint:r,position:l}=o,s=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],d=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];i.viewport.setCamera({focalPoint:d,position:s}),i.viewport.render()}}ro.toolName="Zoom";var rr=ro;class rl extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){let t;let{deltaPoints:n,viewportId:i,renderingEngineId:a}=e.detail,{viewport:o}=(0,Q.O)(i,a),r=this.getTargetId(o),{debounceIfNotLoaded:l,invert:s,loop:d}=this.configuration,u=n.canvas[1];o instanceof tm.Z&&(t=r.split("volumeId:")[1]);let c=this._getPixelPerImage(o),h=u+this.deltaY;if(c){if(Math.abs(h)>=c){let e=Math.round(h/c);t_(o,{delta:s?-e:e,volumeId:t,debounceLoading:l,loop:d}),this.deltaY=h%c}else this.deltaY=h}}_getPixelPerImage(e){let{element:t}=e,n=this._getNumberOfSlices(e);return Math.max(2,t.offsetHeight/Math.max(n,8))}_getNumberOfSlices(e){if(e instanceof tm.Z){let{numberOfSlices:t}=tv.Z(e);return t}if(e instanceof tr.Z)return e.getImageIds().length}}rl.toolName="StackScroll";var rs=rl;function rd(e,t){let[n,i]=e,[a,o]=t,r=th.sub(th.create(),i,n),l=th.sub(th.create(),a,o),s=th.dot(r,l),d=th.length(r),u=th.length(l);return 180*Math.acos(s/(d*u))/Math.PI}class ru extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){let{element:t,currentPoints:n,startPoints:i}=e.detail,a=n.world,o=i.world,r=(0,Q.ZP)(t),{viewport:l}=r,s=l.getCamera(),d=t.clientWidth,u=t.clientHeight,c=l.canvasToWorld([.5*d,.5*u]),h=rd([o,c],[c,a]),{viewPlaneNormal:f,viewUp:g}=s,m=th.sub(th.create(),c,o),v=th.sub(th.create(),c,a),p=th.cross(th.create(),m,v);if(th.dot(f,p)>0&&(h=-h),!Number.isNaN(h)){if(l instanceof to.Z){let e=h*Math.PI/180,t=o2.identity(new Float32Array(16));o2.rotate(t,t,e,f);let n=th.transformMat4(th.create(),g,t);l.setCamera({viewUp:n})}else{let{rotation:e}=l.getProperties();l.setProperties({rotation:e+h})}l.render()}}}ru.toolName="PlanarRotate";var rc=ru;class rh extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t)}mouseWheelCallback(e){let{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:a}=this.configuration,{viewport:o}=(0,Q.ZP)(n),r=this.getTargetId(o),l=r.split("volumeId:")[1];t_(o,{delta:i*(a?-1:1),debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:l})}}rh.toolName="StackScrollMouseWheel";var rf=rh;let rg={Z:[0,0,1]};class rm extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:rg.Z,rotateIncrementDegrees:.5}}){super(e,t)}mouseWheelCallback(e){let{element:t,wheel:n}=e.detail,i=(0,Q.ZP)(t),{viewport:a}=i,{direction:o,rotateIncrementDegrees:r}=this.configuration,l=a.getCamera(),{viewUp:s,position:d,focalPoint:u}=l,{direction:c}=n,[h,f,g]=u,[m,v,p]=o,C=c*r,E=[0,0,0],_=[0,0,0],T=[0,0,0],I=o2.identity(new Float32Array(16));o2.translate(I,I,[h,f,g]),o2.rotate(I,I,C,[m,v,p]),o2.translate(I,I,[-h,-f,-g]),th.transformMat4(E,d,I),th.transformMat4(_,u,I),o2.identity(I),o2.rotate(I,I,C,[m,v,p]),th.transformMat4(T,s,I),a.setCamera({position:E,viewUp:T,focalPoint:_}),a.render()}}rm.toolName="VolumeRotateMouseWheel";var rv=rm;class rp extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){let{element:t,currentPoints:n}=e.detail,i=(0,Q.ZP)(t),{viewport:a,renderingEngine:o}=i,r=this.getTargetId(a);if(!r.startsWith("volumeId"))throw Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");let l=r.split("volumeId:")[1],s=-1/0,d=iY(a,n.world,l,(e,t)=>{if(e>s)return s=e,t});if(!d||!d.length)return;let{targetViewportIds:u,toolGroupId:c}=this.configuration,h=o.getViewports().filter(e=>{if(u?.indexOf(e.id)>=0)return!0;let t=(0,e7.Z)(e.id,o.id);return!!c&&c===t?.id});h.forEach(e=>{e instanceof tm.Z?oZ(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")})}}rp.toolName="MIPJumpToClickTool";var rC=rp;let{transformWorldToIndex:rE}=tK;class r_ extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;eX(i),this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,[l,s]=r.handles.points,d=o.worldToCanvas(l),u=o.worldToCanvas(s),c={start:{x:d[0],y:d[1]},end:{x:u[0],y:u[1]}},h=n7([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return h<=i},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),eX(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d;let u=o[a],{annotationUID:c,data:h}=u,{points:f,activeHandleIndex:g}=h.handles;s.annotationUID=c;let m=this.getStyle("lineWidth",s,u),v=this.getStyle("lineDash",s,u),p=this.getStyle("color",s,u),C=this.getStyle("shadow",s,u),E=f.map(e=>i.worldToCanvas(e));if(h.cachedStats[r]&&void 0!==h.cachedStats[r].unit?u.invalidated&&this._throttledCalculateCachedStats(u,l,e):(h.cachedStats[r]={length:null,unit:null},this._calculateCachedStats(u,l,e)),!(0,nR.isAnnotationVisible)(c))continue;(0,nP.isAnnotationLocked)(u)||this.editData||null===g||(d=[E[g]]),d&&tN(t,c,"0",E,{color:p,lineDash:v,lineWidth:m});let _=`${c}-line`;if(tL(t,c,"1",E[0],E[1],{color:p,width:m,lineDash:v,shadow:C},_),n=!0,!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}let T=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){let e=ie(E);h.handles.textBox.worldPosition=i.canvasToWorld(e)}let I=i.worldToCanvas(h.handles.textBox.worldPosition),w=tH(t,c,"1",T,I,E,{},this.getLinkedTextBoxStyle(s,u)),{x:b,y:S,width:D,height:O}=w;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,S]),topRight:i.canvasToWorld([b+D,S]),bottomLeft:i.canvasToWorld([b,S+O]),bottomRight:i.canvasToWorld([b+D,S+O])}}return n},this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){let i;let a=e.detail,{element:o}=a,{data:r}=t;t.highlighted=!0;let l=!1;n.worldPosition?l=!0:i=r.handles.points.findIndex(e=>e===n);let s=nk(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o),eX(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()}_getTextLines(e,t){let n=e.cachedStats[t],{length:i,unit:a}=n;if(null==i||isNaN(i))return;let o=[`${t4(i)} ${a}`];return o}_calculateLength(e,t){let n=e[0]-t[0],i=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+i*i+a*a)}_calculateCachedStats(e,t,n){let i=e.data,{viewportId:a,renderingEngineId:o}=n,r=i.handles.points[0],l=i.handles.points[1],{cachedStats:s}=i,d=Object.keys(s);for(let e=0;e<d.length;e++){let n=d[e],i=this.getTargetIdImage(n,t);if(!i)continue;let{imageData:a,dimensions:o}=i,u=n3(i),c=this._calculateLength(r,l)/u,h=rE(a,r),f=rE(a,l);this._isInsideVolume(h,f,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,s[n]={length:c,unit:n2(null,i)}}e.invalidated=!1;let u=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,u,{annotation:e,viewportId:a,renderingEngineId:o}),s}_isInsideVolume(e,t,n){return nQ.Z(e,n)&&nQ.Z(t,n)}}r_.toolName="Length";var rT=r_,rI=n(5189),rw=n(35703),rb=n(9677),rS=n(58339);let{RENDERING_DEFAULTS:rD}=nW;function rO(){return"rgb(0, 200, 0)"}function ry(){return!0}function rM(){return!0}function rP(){return!0}let rA={DRAG:1,ROTATE:2,SLAB:3};class rN extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:rw.Z.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{let n=(0,Q.O)(t,e),{FrameOfReferenceUID:i,viewport:a}=n,{element:o}=a,{position:r,focalPoint:l,viewPlaneNormal:s}=a.getCamera(),d=this._getAnnotations(n);(d=this.filterInteractableAnnotationsForElement(o,d)).length&&(0,tB.removeAnnotation)(d[0].annotationUID);let u={highlighted:!1,metadata:{cameraPosition:[...r],cameraFocalPoint:[...l],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,tB.addAnnotation)(u,o),{normal:s,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}},this._getViewportsInfo=()=>{let e=(0,e9.Z)(this.toolGroupId).viewportsInfo;return e},this.computeToolCenter=e=>{if(!e.length||1===e.length)throw Error("For crosshairs to operate, at least two viewports must be given.");let[t,n,i]=e,{normal:a,point:o}=this.initializeViewport(t),{normal:r,point:l}=this.initializeViewport(n),s=[0,0,0],d=th.create();i?{normal:s,point:d}=this.initializeViewport(i):(th.add(d,o,l),th.scale(d,d,.5),th.cross(s,a,r));let u=rb.planeEquation(a,o),c=rb.planeEquation(r,l),h=rb.planeEquation(s,d);this.toolCenter=rb.threePlaneIntersection(u,c,h);let{renderingEngine:f}=(0,Q.O)(e[0].viewportId,e[0].renderingEngineId);(0,tQ.Z)(f,e.map(({viewportId:e})=>e))},this.addNewAnnotation=e=>{let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.world,o=(0,Q.ZP)(n),{viewport:r}=o;this._jump(o,a);let l=this._getAnnotations(o),s=this.filterInteractableAnnotationsForElement(r.element,l),{data:d}=s[0],{rotationPoints:u}=d.handles,c=[];for(let e=0;e<u.length-1;++e){let t=u[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(c.push(t.id),e++)}return d.activeViewportIds=[...c],d.handles.activeOperation=rA.DRAG,e.preventDefault(),eX(n),this._activateModify(n),s[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),eX(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{let i=e.detail,{element:a}=i;t.highlighted=!0,this._activateModify(a),eX(a),e.preventDefault()},this.onCameraModified=e=>{let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{renderingEngine:a}=i,o=i.viewport,r=this._getAnnotations(i),l=this.filterInteractableAnnotationsForElement(n,r),s=l[0];if(!s)return;let d=o.getCamera(),u=s.metadata.cameraPosition,c=[0,0,0];iK.ZP.subtract(d.position,u,c);let h=s.metadata.cameraFocalPoint,f=[0,0,0];iK.ZP.subtract(d.focalPoint,h,f),s.metadata.cameraPosition=[...d.position],s.metadata.cameraFocalPoint=[...d.focalPoint];let g=this._getReferenceLineControllable(o.id),m=this._getReferenceLineDraggableRotatable(o.id);if(!nn.Z(d.position,u,.001)&&g&&m){let e=!1,t=nn.Z(c,f,.001);t||(e=!0);let n=.01>Math.abs(iK.ZP.dot(c,d.viewPlaneNormal));e||n||(this.toolCenter[0]+=c[0],this.toolCenter[1]+=c[1],this.toolCenter[2]+=c[2])}if(this.configuration.autoPan?.enabled){let e=(0,e7.Z)(o.id,a.id),t=e.getViewportIds().filter(e=>e!==o.id);t.forEach(e=>{this._autoPanViewportIfNecessary(e,a)})}let v=nk(n,this.getToolName(),!1);(0,tQ.Z)(a,v)},this.mouseMoveCallback=(e,t)=>{let{element:n,currentPoints:i}=e.detail,a=i.canvas,o=!1;for(let e=0;e<t.length;e++){let i=t[e];if((0,nP.isAnnotationLocked)(i))continue;let{data:r,highlighted:l}=i;if(!r.handles)continue;let s=r.handles.activeOperation,d=r.activeViewportIds&&r.activeViewportIds.length>0?[...r.activeViewportIds]:[];r.activeViewportIds=[],r.handles.activeOperation=null;let u=this.getHandleNearImagePoint(n,i,a,6),c=!1;c=!!u||this._pointNearTool(n,i,a,6);let h=c&&!l,f=!c&&l;h||f?(i.highlighted=!l,o=!0):r.handles.activeOperation===s&&this._areViewportIdArraysEqual(r.activeViewportIds,d)||(o=!0)}return o},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];let n=(0,Q.ZP)(e),{viewportId:i}=n,a=t.filter(e=>e.data.viewportId===i);return a},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i,renderingEngine:a}=e,{element:o}=i,r=this._getAnnotations(e),l=i.getCamera(),s=this.filterInteractableAnnotationsForElement(o,r),d=s[0];if(!r?.length||!d?.data)return n;let u=d.annotationUID,{clientWidth:c,clientHeight:h}=i.canvas,f=Math.sqrt(c*c+h*h),g=Math.min(c,h),m=d.data,v=i.worldToCanvas(this.toolCenter),p=this._filterAnnotationsByUniqueViewportOrientations(e,r),C=[],E=[0,0,c,h];p.forEach(e=>{let{data:t}=e;t.handles.toolCenter=this.toolCenter;let n=a.getViewport(t.viewportId),o=n.getCamera(),r=this._getReferenceLineControllable(n.id),s=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:u,clientHeight:c}=n.canvas,h=n.canvasToWorld([.5*u,.5*c]),m=[0,0,0];iK.ZP.cross(l.viewPlaneNormal,o.viewPlaneNormal,m),iK.ZP.normalize(m),iK.ZP.multiplyScalar(m,Math.sqrt(u*u+c*c));let _=[0,0,0];iK.ZP.add(h,m,_);let T=[0,0,0];iK.ZP.subtract(h,m,T);let I=i.worldToCanvas(_),w=i.worldToCanvas(h),b=nV.Ue();nV.$X(b,I,w),nV.Fv(b,b);let S=nV.Ue();nV.bA(S,b,100*f);let D=nV.Ue();nV.bA(D,b,.4*g);let O=nV.Ue();nV.bA(O,b,.2*g);let y=nV.Ue(),M=this.configuration.referenceLinesCenterGapRadius;nV.bA(y,b,2===p.length?M:0);let P=nV.Ue(),A=nV.Ue(),N=nV.Ue(),L=nV.Ue(),x=nV.d9(v);s&&r||(x=nV.d9(w)),nV.IH(P,x,y),nV.IH(A,x,S),nV.$X(N,x,y),nV.$X(L,x,S),iZ(P,A,E),iZ(N,L,E);let Z=nV.Ue();nV.$X(Z,v,D);let U=nV.Ue();nV.IH(U,v,D);let k=nV.d9(v);!s&&d&&(k=nV.d9(w));let R=[...this.toolCenter];!s&&d&&(R=[...h]);let V=[0,0,0];iK.ZP.subtract(_,T,V),iK.ZP.normalize(V);let{viewPlaneNormal:H}=l,{matrix:G}=rI.Z.buildFromDegree().rotate(90,H),W=[0,0,0];th.transformMat4(W,V,G);let B=n.getSlabThickness(),F=[...W];iK.ZP.multiplyScalar(F,B);let $=[0,0,0];iK.ZP.add(R,F,$);let q=i.worldToCanvas($),j=nV.Ue();nV.$X(j,k,q);let z=nV.Ue();nV.$X(z,k,S),nV.IH(z,z,j);let K=nV.Ue();nV.IH(K,k,S),nV.IH(K,K,j),iZ(z,K,E);let Y=nV.Ue();nV.IH(Y,k,S),nV.$X(Y,Y,j);let X=nV.Ue();nV.$X(X,k,S),nV.$X(X,X,j),iZ(Y,X,E);let J=nV.Ue(),Q=nV.Ue(),ee=nV.Ue(),et=nV.Ue();nV.$X(J,k,O),nV.IH(J,J,j),nV.IH(Q,k,O),nV.IH(Q,Q,j),nV.$X(ee,k,O),nV.$X(ee,ee,j),nV.IH(et,k,O),nV.$X(et,et,j),C.push([n,P,A,N,L,z,K,Y,X,Z,U,J,Q,ee,et])});let _=[],T=[],I=this._getReferenceLineColor(i.id),w=void 0!==I?I:"rgb(200, 200, 200)";if(C.forEach((e,n)=>{let a=e[0],o=this._getReferenceLineColor(a.id),r=this._getReferenceLineControllable(a.id),l=this._getReferenceLineDraggableRotatable(a.id)||this.configuration.mobile?.enabled,s=this._getReferenceLineSlabThicknessControlsOn(a.id)||this.configuration.mobile?.enabled,d=m.activeViewportIds.find(e=>e===a.id),c=void 0!==o?o:"rgb(200, 200, 200)",h=1,f=null!==m.handles.activeOperation&&m.handles.activeOperation===rA.DRAG&&d;f&&(h=2.5);let g=`${n}`;if(r&&l?(tL(t,u,g=`${n}One`,e[1],e[2],{color:c,lineWidth:h}),tL(t,u,g=`${n}Two`,e[3],e[4],{color:c,lineWidth:h})):tL(t,u,g,e[2],e[4],{color:c,lineWidth:h}),r){c=void 0!==o?o:"rgb(200, 200, 200)";let r=m.handles.activeOperation===rA.ROTATE,h=[e[9],e[10]],v=[i.canvasToWorld(e[9]),a,e[1],e[2]],p=[i.canvasToWorld(e[10]),a,e[3],e[4]];_.push(v,p);let C=m.handles.activeOperation===rA.SLAB,E=[e[11],e[12],e[13],e[14]],I=[i.canvasToWorld(e[11]),a,e[5],e[6]],w=[i.canvasToWorld(e[12]),a,e[5],e[6]],b=[i.canvasToWorld(e[13]),a,e[7],e[8]],S=[i.canvasToWorld(e[14]),a,e[7],e[8]];if(T.push(I,w,b,S),(f||this.configuration.mobile?.enabled)&&!r&&!C&&l&&s){let e=`${n}One`;tN(t,u,e,h,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),tN(t,u,e=`${n}Two`,E,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(f&&!r&&!C&&l){let e=`${n}`;tN(t,u,e,h,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(d&&!r&&!C&&s){let e=`${n}`;tN(t,u,e,E,{color:c,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(r&&l){let e=`${n}`;tN(t,u,e,h,{color:c,handleRadius:2,fill:c,type:"circle"})}else C&&d&&s&&tN(t,u,g,E,{color:c,handleRadius:2,fill:c,type:"rect"});let D=a.getSlabThickness();D>.5&&s&&(tL(t,u,g=`${n}STOne`,e[5],e[6],{color:c,width:1,lineDash:[2,3]}),tL(t,u,g=`${n}STTwo`,e[7],e[8],{color:c,width:e,lineDash:[2,3]}))}}),n=!0,m.handles.rotationPoints=_,m.handles.slabThicknessPoints=T,this.configuration.viewportIndicators){let e=.01*f;tP(t,u,"0",[.95*c,.05*h],e,{color:w,fill:w})}return n},this._getAnnotations=e=>{let{viewport:t}=e;return(0,tB.getAnnotations)(this.getToolName(),t.element)},this._onNewVolume=e=>{let t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach(e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1}),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{let{viewportId:n,renderingEngine:i,viewport:a}=e,o=t.filter(e=>e.data.viewportId!==n);if(!o||!o.length)return[];let r=a.getCamera(),{viewPlaneNormal:l,position:s}=r,d=o.filter(e=>{let{viewportId:t}=e.data,n=i.getViewport(t),a=n.getCamera();return!(nn.Z(a.viewPlaneNormal,l,.01)&&nn.Z(a.position,s,1))});return d},this._filterViewportWithSameOrientation=(e,t,n)=>{let{renderingEngine:i}=e,{data:a}=t,o=i.getViewport(a.viewportId),r=n.filter(e=>{let{data:t}=e,n=i.getViewport(t.viewportId),a=this._getReferenceLineControllable(n.id);return!0===a});if(!r||!r.length)return[];let l=o.getCamera(),s=l.viewPlaneNormal;iK.ZP.normalize(s);let d=r.filter(e=>{let{viewportId:t}=e.data,n=i.getViewport(t),a=n.getCamera(),o=a.viewPlaneNormal;return iK.ZP.normalize(o),nn.Z(s,o,.01)&&nn.Z(l.viewUp,a.viewUp,.01)});return d},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{let{renderingEngine:n,viewport:i}=e,a=i.getCamera(),o=a.viewPlaneNormal;iK.ZP.normalize(o);let r=t.filter(e=>{let{data:t}=e,a=n.getViewport(t.viewportId),o=this._getReferenceLineControllable(a.id);return i!==a&&!0===o}),l=[];for(let e=0;e<r.length;++e){let t=r[e],{viewportId:i}=t.data,a=n.getViewport(i),s=a.getCamera(),d=s.viewPlaneNormal;if(iK.ZP.normalize(d),nn.Z(o,d,.01)||rS.Z(o,d,.01))continue;let u=!1;for(let e=0;e<l.length;++e){let t=l[e],{viewportId:i}=t.data,a=n.getViewport(i),o=a.getCamera();nn.Z(o.viewPlaneNormal,s.viewPlaneNormal,.01)&&nn.Z(o.position,s.position,1)&&(u=!0)}u||l.push(t)}let s=t.filter(e=>{let{data:t}=e,a=n.getViewport(t.viewportId),o=this._getReferenceLineControllable(a.id);return i!==a&&!0!==o});for(let e=0;e<s.length;++e){let t=s[e],{viewportId:i}=t.data,a=n.getViewport(i),r=a.getCamera(),d=r.viewPlaneNormal;if(iK.ZP.normalize(d),nn.Z(o,d,.01)||rS.Z(o,d,.01))continue;let u=!1;for(let e=0;e<l.length;++e){let t=l[e],{viewportId:i}=t.data,a=n.getViewport(i),o=a.getCamera();nn.Z(o.viewPlaneNormal,r.viewPlaneNormal,.01)&&nn.Z(o.position,r.position,1)&&(u=!0)}u||l.push(t)}let d=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<d.length;++e){let t=d[e];if(l.some(e=>e===t))continue;let{viewportId:i}=t.data,a=n.getViewport(i),r=a.getCamera(),s=r.viewPlaneNormal;if(iK.ZP.normalize(s),nn.Z(o,s,.01)||rS.Z(o,s,.01))continue;let u=!1;for(let e=0;e<l.length;++e){let t=l[e],{viewportId:i}=t.data,a=n.getViewport(i),o=a.getCamera();nn.Z(o.viewPlaneNormal,r.viewPlaneNormal,.01)&&nn.Z(o.position,r.position,1)&&(u=!0)}u||l.push(t)}return l},this._checkIfViewportsRenderingSameScene=(e,t)=>{let n=e.getActors(),i=t.getActors(),a=!0;return n.forEach(e=>{(n.length!==i.length||void 0===i.find(({uid:t})=>t===e.uid))&&(a=!1)}),a},this._jump=(e,t)=>{q.ZP.isInteractingWithTool=!0;let{viewport:n,renderingEngine:i}=e,a=this._getAnnotations(e),o=[0,0,0];iK.ZP.subtract(t,this.toolCenter,o);let r=this._getAnnotationsForViewportsWithDifferentCameras(e,a),l=r.filter(e=>{let{data:t}=e,a=i.getViewport(t.viewportId),o=this._checkIfViewportsRenderingSameScene(n,a);return this._getReferenceLineControllable(a.id)&&this._getReferenceLineDraggableRotatable(a.id)&&o});return 0===l.length?(q.ZP.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,l,o),q.ZP.isInteractingWithTool=!1,!0)},this._activateModify=e=>{q.ZP.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{let t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),eY(n),this.editData=null;let i=(0,Q.ZP)(n),{renderingEngine:a}=i,o=nk(n,this.getToolName(),!1);(0,tQ.Z)(a,o)},this._dragCallback=e=>{let t=e.detail,n=t.deltaPoints.world;if(.001>Math.abs(n[0])&&.001>Math.abs(n[1])&&.001>Math.abs(n[2]))return;let{element:i}=t,a=(0,Q.ZP)(i),{renderingEngine:o,viewport:r}=a,l=this._getAnnotations(a),s=this.filterInteractableAnnotationsForElement(i,l),d=s[0];if(!d)return;let{handles:u}=d.data,{currentPoints:c}=e.detail,h=c.canvas;if(u.activeOperation===rA.DRAG){let e=this._getAnnotationsForViewportsWithDifferentCameras(a,l),t=e.filter(e=>{let{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===a&&d.data.activeViewportIds.find(e=>e===n.id)});this._applyDeltaShiftToSelectedViewportCameras(o,t,n)}else if(u.activeOperation===rA.ROTATE){let e=this._getAnnotationsForViewportsWithDifferentCameras(a,l),n=e.filter(e=>{let{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===a}),i=nV.Ue(),s=nV.Ue(),d=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],u=r.worldToCanvas(d),c=t.currentPoints.canvas,h=nV.Ue();nV.lu(h,c,t.deltaPoints.canvas),nV.lu(i,h,u),nV.lu(s,c,u);let f=nV.EU(i,s);this._isClockWise(u,h,c)&&(f*=-1),f=Math.round(100*f)/100;let g=r.getCamera().viewPlaneNormal,{matrix:m}=rI.Z.buildFromRadian().translate(d[0],d[1],d[2]).rotate(f,g).translate(-d[0],-d[1],-d[2]),v=[];n.forEach(e=>{let{data:t}=e;t.handles.toolCenter=d;let n=o.getViewport(t.viewportId),i=n.getCamera(),{viewUp:a,position:r,focalPoint:l}=i;a[0]+=r[0],a[1]+=r[1],a[2]+=r[2],th.transformMat4(l,l,m),th.transformMat4(r,r,m),th.transformMat4(a,a,m),a[0]-=r[0],a[1]-=r[1],a[2]-=r[2],n.setCamera({position:r,viewUp:a,focalPoint:l}),v.push(n.id)}),o.renderViewports(v)}else if(u.activeOperation===rA.SLAB){let e=this._getAnnotationsForViewportsWithDifferentCameras(a,l),i=e.filter(e=>{let{data:t}=e,n=o.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),a=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===a&&d.data.activeViewportIds.find(e=>e===n.id)});if(0===i.length)return;let s=this._filterViewportWithSameOrientation(a,i[0],l),u=[];u.push(r.id),s.forEach(e=>{let{data:i}=e,a=o.getViewport(i.viewportId),l=a.getCamera(),s=l.viewPlaneNormal,c=iK.ZP.dot(n,s),f=[...s];if(iK.ZP.multiplyScalar(f,c),Math.abs(f[0])>.001||Math.abs(f[1])>.001||Math.abs(f[2])>.001){let e=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),n=t.lastPoints.world,i=[0,0,0],l=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],c=this._getReferenceLineDraggableRotatable(a.id);if(!c){let{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter(e=>e[1].uid===a.id);if(2===t.length){let e=r.canvasToWorld(t[0][3]),n=r.canvasToWorld(t[1][3]);iK.ZP.add(e,n,l),iK.ZP.multiplyScalar(l,.5)}}iK.ZP.subtract(n,l,i);let g=iK.ZP.dot(i,s),m=[...s];iK.ZP.multiplyScalar(m,g);let v=[m[0],m[1],m[2]];th.normalize(v,v);let p=[f[0],f[1],f[2]];th.normalize(p,p);let C=a.getSlabThickness();rS.Z(v,p,.001)?C-=e:C+=e,C=Math.abs(C),C=Math.max(rD.MINIMUM_SLAB_THICKNESS,C);let E=this._pointNearReferenceLine(d,h,6,a);E&&(C=rD.MINIMUM_SLAB_THICKNESS);let _=(0,e7.Z)(a.id,o.id),T=_.getToolInstance(this.getToolName());T.setSlabThickness(a,C),u.push(a.id)}}),o.renderViewports(u)}},this._pointNearReferenceLine=(e,t,n,i)=>{let{data:a}=e,{rotationPoints:o}=a.handles;for(let e=0;e<o.length-1;++e){let a=o[e][1];if(a.id!==i.id)continue;let r=this._getReferenceLineControllable(a.id);if(!r)continue;let l={start:{x:o[e][2][0],y:o[e][2][1]},end:{x:o[e][3][0],y:o[e][3][1]}},s=n7([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]),d={start:{x:o[e+1][2][0],y:o[e+1][2][1]},end:{x:o[e+1][3][0],y:o[e+1][3][1]}},u=n7([d.start.x,d.start.y],[d.end.x,d.end.y],[t[0],t[1]]);if(s<=n||u<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||rO,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||ry,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||rM,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||rP}onSetToolActive(){let e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){let e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){let e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){let e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach(({renderingEngineId:e,viewportId:t})=>{let n=(0,Q.O)(t,e);if(!n)return;let i=this._getAnnotations(n);i?.length&&i.forEach(e=>{(0,tB.removeAnnotation)(e.annotationUID)})})}getHandleNearImagePoint(e,t,n,i){let a=(0,Q.ZP)(e),{viewport:o}=a,r=this._getRotationHandleNearImagePoint(o,t,n,i);if(null!==r||null!==(r=this._getSlabThicknessHandleNearImagePoint(o,t,n,i)))return r}_unsubscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{let{viewport:n}=(0,Q.O)(e,t),{element:i}=n;i.removeEventListener(et.default.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{let{viewport:n}=(0,Q.O)(e,t),{element:i}=n;i.addEventListener(et.default.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_autoPanViewportIfNecessary(e,t){let n=t.getViewport(e),{clientWidth:i,clientHeight:a}=n.canvas,o=n.worldToCanvas(this.toolCenter),r=this.configuration.autoPan.panSize,l=[o[0],o[1]];if(o[0]<0?l[0]=r:o[0]>i&&(l[0]=i-r),o[1]<0?l[1]=r:o[1]>a&&(l[1]=a-r),l[0]===o[0]&&l[1]===o[1])return;let s=n.canvasToWorld(l),d=[s[0]-this.toolCenter[0],s[1]-this.toolCenter[1],s[2]-this.toolCenter[2]],u=n.getCamera(),{focalPoint:c,position:h}=u,f=[h[0]-d[0],h[1]-d[1],h[2]-d[2]],g=[c[0]-d[0],c[1]-d[1],c[2]-d[2]];n.setCamera({focalPoint:g,position:f}),n.render()}setSlabThickness(e,t){let n;let{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let a=this.configuration.slabThicknessBlendMode;t===rD.MINIMUM_SLAB_THICKNESS&&(a=rw.Z.COMPOSITE),e.setBlendMode(a,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach(t=>{this._applyDeltaShiftToViewportCamera(e,t,n)})}_applyDeltaShiftToViewportCamera(e,t,n){let{data:i}=t,a=e.getViewport(i.viewportId),o=a.getCamera(),r=o.viewPlaneNormal,l=iK.ZP.dot(n,r),s=[...r];if(iK.ZP.multiplyScalar(s,l),Math.abs(s[0])>.001||Math.abs(s[1])>.001||Math.abs(s[2])>.001){let e=[0,0,0],t=[0,0,0];iK.ZP.add(o.focalPoint,s,e),iK.ZP.add(o.position,s,t),a.setCamera({focalPoint:e,position:t}),a.render()}}_getRotationHandleNearImagePoint(e,t,n,i){let{data:a}=t,{rotationPoints:o}=a.handles;for(let r=0;r<o.length;r++){let l=o[r][0],s=o[r][1],d=this._getReferenceLineControllable(s.id);if(!d)continue;let u=this._getReferenceLineDraggableRotatable(s.id);if(!u)continue;let c=e.worldToCanvas(l);if(nV.TE(n,c)<i)return a.handles.activeOperation=rA.ROTATE,this.editData={annotation:t},l}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){let{data:a}=t,{slabThicknessPoints:o}=a.handles;for(let r=0;r<o.length;r++){let l=o[r][0],s=o[r][1],d=this._getReferenceLineControllable(s.id);if(!d)continue;let u=this._getReferenceLineSlabThicknessControlsOn(s.id);if(!u)continue;let c=e.worldToCanvas(l);if(nV.TE(n,c)<i)return a.handles.activeOperation=rA.SLAB,a.activeViewportIds=[s.id],this.editData={annotation:t},l}return null}_pointNearTool(e,t,n,i){let a=(0,Q.ZP)(e),{viewport:o}=a,{clientWidth:r,clientHeight:l}=o.canvas,s=Math.sqrt(r*r+l*l),{data:d}=t,{rotationPoints:u}=d.handles,{slabThicknessPoints:c}=d.handles,h=[];for(let e=0;e<u.length-1;++e){let t=u[e][1],a=this._getReferenceLineControllable(t.id),o=this._getReferenceLineDraggableRotatable(t.id);if(!a||!o)continue;let r={start:{x:u[e][2][0],y:u[e][2][1]},end:{x:u[e][3][0],y:u[e][3][1]}},l=n7([r.start.x,r.start.y],[r.end.x,r.end.y],[n[0],n[1]]),s={start:{x:u[e+1][2][0],y:u[e+1][2][1]},end:{x:u[e+1][3][0],y:u[e+1][3][1]}},c=n7([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]);(l<=i||c<=i)&&(h.push(t.id),d.handles.activeOperation=rA.DRAG),e++}for(let e=0;e<c.length-1;++e){let t=c[e][1];if(h.find(e=>e===t.id))continue;let a=this._getReferenceLineControllable(t.id),o=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!o)continue;let r=c[e][2],l=c[e][3],u=nV.Ue();nV.IH(u,r,l),nV.bA(u,u,.5);let f=nV.Ue();nV.$X(f,r,u),nV.Fv(f,f);let g=nV.Ue();nV.bA(g,f,.05*s);let m=nV.Ue(),v=nV.Ue();nV.IH(m,u,g),nV.$X(v,u,g);let p={start:{x:m[0],y:m[1]},end:{x:r[0],y:r[1]}},C=n7([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]]),E={start:{x:v[0],y:v[1]},end:{x:l[0],y:l[1]}},_=n7([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(C<=i||_<=i)&&(h.push(t.id),d.handles.activeOperation=null),e++}return d.activeViewportIds=[...h],this.editData={annotation:t},d.handles.activeOperation===rA.DRAG}}rN.toolName="Crosshairs";var rL=rN,rx=n(43288);let{EPSILON:rZ}=nW;class rU extends nY{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:""}}){super(e,t),this.editData={},this._init=()=>{let e=(0,ee.Uu)()[0];if(!e)return;let t=e.getViewports();t=nZ(t,this.getToolName());let n=e.getViewport(this.configuration.sourceViewportId);if(!n||!n.getImageData())return;let{element:i}=n,{viewUp:a,viewPlaneNormal:o}=n.getCamera(),r=rx.Z(n),l=this.editData.annotation,s=n.getFrameOfReferenceUID();if(l)this.editData.annotation.data.handles.points=r;else{let e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...o],viewUp:[...a],FrameOfReferenceUID:s,referencedImageId:null},data:{handles:{points:r}}};(0,tB.addAnnotation)(e,i),l=e}this.editData={sourceViewport:n,renderingEngine:e,annotation:l},(0,tQ.Z)(e,t.filter(e=>e.id!==n.id).map(e=>e.id))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{let{viewport:n}=e,{annotation:i,sourceViewport:a}=this.editData,o=!1;if(!a||a.id===n.id||!i||!i?.data?.handles?.points)return o;let r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=i.data.handles.points[0],s=i.data.handles.points[1],d=i.data.handles.points[2],u=i.data.handles.points[3],{focalPoint:c,viewPlaneNormal:h}=n.getCamera(),{viewPlaneNormal:f}=a.getCamera();if(this.isParallel(h,f))return o;let g=rb.planeEquation(h,c),m=[l,d,s,u],v=m,p=th.subtract(th.create(),m[0],m[1]);p=th.normalize(th.create(),p);let C=th.subtract(th.create(),m[2],m[0]);C=th.normalize(th.create(),C);let E=th.cross(th.create(),p,C);if(this.isParallel(E,h))return o;this.isPerpendicular(p,h)&&(v=[l,s,d,u]);let _=rb.linePlaneIntersection(v[0],v[1],g),T=rb.linePlaneIntersection(v[2],v[3],g),{annotationUID:I}=i;r.annotationUID=I;let w=this.getStyle("lineWidth",r,i),b=this.getStyle("lineDash",r,i),S=this.getStyle("color",r,i),D=this.getStyle("shadow",r,i),O=[_,T].map(e=>n.worldToCanvas(e)),y=`${I}-line`;return tL(t,I,"1",O[0],O[1],{color:S,width:w,lineDash:b,shadow:D},y),o=!0},this.isPerpendicular=(e,t)=>{let n=th.dot(e,t);return Math.abs(n)<rZ}}isParallel(e,t){return Math.abs(th.dot(e,t))>1-rZ}}rU.toolName="ReferenceLines";var rk=rU;function rR(e,t,n,i){let a=th.create();th.cross(a,t,e);let o=th.fromValues(...n),r=th.fromValues(...i),l=th.create();th.subtract(l,o,r);let s=th.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};let d=th.dot(l,a)/(s*th.length(a));return{worldWidth:Math.sqrt(1-d*d)*s,worldHeight:d*s}}let{transformWorldToIndex:rV}=tK;class rH extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{viewport:l,renderingEngine:s}=r;this.isDrawing=!0;let d=l.getCamera(),{viewPlaneNormal:u,viewUp:c}=d,h=this.getReferencedImageId(l,a,u,c),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...c],FrameOfReferenceUID:f,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},initialRotation:l.getRotation()}};(0,tB.addAnnotation)(g,i);let m=nk(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,centerCanvas:o,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(s,m),g},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,s=l.map(e=>o.worldToCanvas(e)),d=ni(s),[u,c]=d,h={left:Math.min(u[0],c[0])+i/2,top:Math.min(u[1],c[1])+i/2,width:Math.abs(u[0]-c[0])-i,height:Math.abs(u[1]-c[1])-i},f={left:Math.min(u[0],c[0])-i/2,top:Math.min(u[1],c[1])-i/2,width:Math.abs(u[0]-c[0])+i,height:Math.abs(u[1]-c[1])+i},g=this._pointInEllipseCanvas(h,n),m=this._pointInEllipseCanvas(f,n);return!!m&&!g},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},eX(i),this._activateModify(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i,a,o,r,l;let s=e.detail,{element:d}=s,{data:u}=t;t.highlighted=!0;let c=!1;if(n.worldPosition)c=!0;else{let{points:e}=u.handles,t=(0,Q.ZP)(d),{worldToCanvas:s}=t.viewport;i=e.findIndex(e=>e===n);let c=e.map(s);l=c[i],o=Math.abs(c[2][0]-c[3][0]),r=Math.abs(c[0][1]-c[1][1]),a=[(c[2][0]+c[3][0])/2,(c[0][1]+c[1][1])/2]}let h=nk(d,this.getToolName());this.editData={annotation:t,viewportIdsToRender:h,handleIndex:i,canvasWidth:o,canvasHeight:r,centerCanvas:a,originalHandleCanvas:l,movingTextBox:c},this._activateModify(d),eX(d);let f=(0,Q.ZP)(d),{renderingEngine:g}=f;(0,tQ.Z)(g,h),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}},this._dragDrawCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,Q.ZP)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:s}=l,{annotation:d,viewportIdsToRender:u,centerCanvas:c}=this.editData,{data:h}=d,f=Math.abs(a[0]-c[0]),g=Math.abs(a[1]-c[1]),m=[c[0],c[1]-g],v=[c[0],c[1]+g],p=[c[0]-f,c[1]],C=[c[0]+f,c[1]];h.handles.points=[s(m),s(v),s(p),s(C)],d.invalidated=!0,this.editData.hasMoved=!0,(0,tQ.Z)(r,u)},this._dragModifyCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this._dragHandle=e=>{let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{canvasToWorld:a}=i.viewport,{annotation:o,canvasWidth:r,canvasHeight:l,handleIndex:s,centerCanvas:d,originalHandleCanvas:u}=this.editData,{data:c}=o,{points:h}=c.handles,{currentPoints:f}=t,g=f.canvas;if(0===s||1===s){let e=Math.abs(g[1]-d[1]),t=[d[0],d[1]-e],n=[d[0],d[1]+e];h[0]=a(t),h[1]=a(n);let i=g[0]-u[0],o=r/2+i,l=[d[0]-o,d[1]],s=[d[0]+o,d[1]];h[2]=a(l),h[3]=a(s)}else{let e=Math.abs(g[0]-d[0]),t=[d[0]-e,d[1]],n=[d[0]+e,d[1]];h[2]=a(t),h[3]=a(n);let i=g[1]-u[1],o=l/2+i,r=[d[0],d[1]-o],s=[d[0],d[1]+o];h[0]=a(r),h[1]=a(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d,u,c;let h=o[a],{annotationUID:f,data:g}=h,{handles:m}=g,{points:v,activeHandleIndex:p}=m;s.annotationUID=f;let C=this.getStyle("lineWidth",s,h),E=this.getStyle("lineDash",s,h),_=this.getStyle("color",s,h),T=v.map(e=>i.worldToCanvas(e)),I=Math.abs(i.getRotation()-(g.initialRotation||0));d=90==I||270==I?ni([T[2],T[3],T[0],T[1]]):ni(T);let{centerPointRadius:w}=this.configuration,b={isPreScaled:ia(i,r),isSuvScaled:this.isSuvScaled(i,r,h.metadata.referencedImageId)};if(g.cachedStats[r]&&void 0!==g.cachedStats[r].areaUnit){if(h.invalidated&&(this._throttledCalculateCachedStats(h,i,l,e,b),i instanceof tm.Z)){let{referencedImageId:e}=h.metadata;for(let t in g.cachedStats)if(t.startsWith("imageId")){let n=l.getStackViewports(),i=n.find(t=>{let n=nH.Z(e),i=t.hasImageURI(n),a=nH.Z(t.getCurrentImageId());return i&&a!==n});i&&delete g.cachedStats[t]}}}else g.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(h,i,l,e,b);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(f))continue;(0,nP.isAnnotationLocked)(h)||this.editData||null===p||(u=[T[p]]),u&&tN(t,f,"0",u,{color:_});let S=`${f}-ellipse`;if(tA(t,f,"0",d[0],d[1],{color:_,lineDash:E,lineWidth:C},S),w>0){let e=Math.min(Math.abs(d[0][0]-d[1][0])/2,Math.abs(d[0][1]-d[1][1])/2);if(e>3*w){let e=this._getCanvasEllipseCenter(T);tP(t,f,"0-center",e,w,{color:_,lineDash:E,lineWidth:C})}}n=!0;let D=this._getTextLines(g,r);if(!D||0===D.length)continue;g.handles.textBox.hasMoved||(c=ie(d),g.handles.textBox.worldPosition=i.canvasToWorld(c));let O=i.worldToCanvas(g.handles.textBox.worldPosition),y=tH(t,f,"1",D,O,T,{},this.getLinkedTextBoxStyle(s,h)),{x:M,y:P,width:A,height:N}=y;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,P]),topRight:i.canvasToWorld([M+A,P]),bottomLeft:i.canvasToWorld([M,P+N]),bottomRight:i.canvasToWorld([M+A,P+N])}}return n},this._getTextLines=(e,t)=>{let n=e.cachedStats[t],{area:i,mean:a,stdDev:o,max:r,isEmptyArea:l,areaUnit:s,modalityUnit:d}=n,u=[];if(i){let e=l?"Area: Oblique not supported":`Area: ${t4(i)} ${s}`;u.push(e)}return a&&u.push(`Mean: ${t4(a)} ${d}`),r&&u.push(`Max: ${t4(r)} ${d}`),o&&u.push(`Std Dev: ${t4(o)} ${d}`),u},this._calculateCachedStats=(e,t,n,i,a)=>{let o=e.data,{viewportId:r,renderingEngineId:l}=i,{points:s}=o.handles,d=s.map(e=>t.worldToCanvas(e)),{viewPlaneNormal:u,viewUp:c}=t.getCamera(),[h,f]=ni(d),g=t.canvasToWorld(h),m=t.canvasToWorld(f),{cachedStats:v}=o,p=Object.keys(v);for(let t=0;t<p.length;t++){let i=p[t],o=this.getTargetIdImage(i,n);if(!o)continue;let{dimensions:r,imageData:l,metadata:s,hasPixelSpacing:d}=o,h=rV(l,g);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);let f=rV(l,m);if(f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(h,f,r)){let t=Math.min(h[0],f[0]),n=Math.max(h[0],f[0]),r=Math.min(h[1],f[1]),d=Math.max(h[1],f[1]),p=Math.min(h[2],f[2]),C=Math.max(h[2],f[2]),E=[[t,n],[r,d],[p,C]],_=[(g[0]+m[0])/2,(g[1]+m[1])/2,(g[2]+m[2])/2],T={center:_,xRadius:Math.abs(g[0]-m[0])/2,yRadius:Math.abs(g[1]-m[1])/2,zRadius:Math.abs(g[2]-m[2])/2},{worldWidth:I,worldHeight:w}=rR(u,c,g,m),b=0===I&&0===w,S=n3(o),D=Math.abs(Math.PI*(I/2)*(w/2))/S/S,O=0,y=0,M=0,P=-1/0,A=({value:e})=>{e>P&&(P=e),y+=e,O+=1};t1(l,(e,t)=>na(T,e),A,E),y/=O;let N=({value:e})=>{let t=e-y;M+=t*t};t1(l,(e,t)=>na(T,e),N,E),M/=O,M=Math.sqrt(M);let L=ii(s.Modality,e.metadata.referencedImageId,a);v[i]={Modality:s.Modality,area:D,mean:y,max:P,stdDev:M,isEmptyArea:b,areaUnit:n5(null,o),modalityUnit:L}}else this.isHandleOutsideImage=!0,v[i]={Modality:s.Modality}}e.invalidated=!1;let C=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,C,{annotation:e,viewportId:r,renderingEngineId:l}),v},this._isInsideVolume=(e,t,n)=>nQ.Z(e,n)&&nQ.Z(t,n),this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){let n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;let a=[e.left+n,e.top+i],o=[t[0]-a[0],t[1]-a[1]],r=o[0]*o[0]/(n*n)+o[1]*o[1]/(i*i)<=1;return r}_getCanvasEllipseCenter(e){let[t,n,i,a]=e,o=[i[0],n[1]],r=[a[0],t[1]];return[(o[0]+r[0])/2,(o[1]+r[1])/2]}}rH.toolName="EllipticalROI";var rG=rH;function rW(e){let[t,n]=e;return iz(t,n)}function rB(e){let[t,n]=e,i=iz(t,n),a=[t[0]-i,t[1]-i],o=[t[0]+i,t[1]+i];return[a,o]}let{transformWorldToIndex:rF}=tK;class r$ extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world;n.canvas;let o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,s=l.map(e=>o.worldToCanvas(e)),d=rW(s),u=rW([s[0],n]);return Math.abs(u-d)<i/2},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},eX(i),this._activateModify(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i;let a=e.detail,{element:o}=a,{data:r}=t;t.highlighted=!0;let l=!1;if(n.worldPosition)l=!0;else{let{points:e}=r.handles;i=e.findIndex(e=>e===n)}let s=nk(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o),eX(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;i.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}},this._dragDrawCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,Q.ZP)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:s}=l,{annotation:d,viewportIdsToRender:u}=this.editData,{data:c}=d;c.handles.points=[c.handles.points[0],s(a)],d.invalidated=!0,this.editData.hasMoved=!0,(0,tQ.Z)(r,u)},this._dragModifyCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this._dragHandle=e=>{let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{canvasToWorld:a,worldToCanvas:o}=i.viewport,{annotation:r,handleIndex:l}=this.editData,{data:s}=r,{points:d}=s.handles,u=d.map(e=>o(e)),{currentPoints:c}=t,h=c.canvas;if(0===l){let e=h[0]-u[0][0],t=h[1]-u[0][1],n=[u[1][0]+e,u[1][1]+t];d[0]=a(h),d[1]=a(n)}else d[1]=a(h)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d,u;let c=o[a],{annotationUID:h,data:f}=c,{handles:g}=f,{points:m,activeHandleIndex:v}=g;s.annotationUID=h;let p=this.getStyle("lineWidth",s,c),C=this.getStyle("lineDash",s,c),E=this.getStyle("color",s,c),_=m.map(e=>i.worldToCanvas(e)),T=_[0],I=rW(_),w=rB(_),{centerPointRadius:b}=this.configuration,S={isPreScaled:ia(i,r),isSuvScaled:this.isSuvScaled(i,r,c.metadata.referencedImageId)};if(f.cachedStats[r]&&void 0!==f.cachedStats[r].areaUnit){if(c.invalidated&&(this._throttledCalculateCachedStats(c,i,l,e,S),i instanceof tm.Z)){let{referencedImageId:e}=c.metadata;for(let t in f.cachedStats)if(t.startsWith("imageId")){let n=l.getStackViewports(),i=n.find(t=>{let n=nH.Z(e),i=t.hasImageURI(n),a=nH.Z(t.getCurrentImageId());return i&&a!==n});i&&delete f.cachedStats[t]}}}else f.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(c,i,l,e,S);if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(h))continue;(0,nP.isAnnotationLocked)(c)||this.editData||null===v||(d=[_[v]]),d&&tN(t,h,"0",d,{color:E});let D=`${h}-circle`;tP(t,h,"0",T,I,{color:E,lineDash:C,lineWidth:p},D),b>0&&I>3*b&&tP(t,h,"0-center",T,b,{color:E,lineDash:C,lineWidth:p}),n=!0;let O=this._getTextLines(f,r);if(!O||0===O.length)continue;f.handles.textBox.hasMoved||(u=ie(w),f.handles.textBox.worldPosition=i.canvasToWorld(u));let y=i.worldToCanvas(f.handles.textBox.worldPosition),M=tH(t,h,"1",O,y,_,{},this.getLinkedTextBoxStyle(s,c)),{x:P,y:A,width:N,height:L}=M;f.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,A]),topRight:i.canvasToWorld([P+N,A]),bottomLeft:i.canvasToWorld([P,A+L]),bottomRight:i.canvasToWorld([P+N,A+L])}}return n},this._getTextLines=(e,t)=>{let n=e.cachedStats[t],{radius:i,radiusUnit:a,area:o,mean:r,stdDev:l,max:s,isEmptyArea:d,Modality:u,areaUnit:c,modalityUnit:h}=n,f=[];if(i){let e=d?"Radius: Oblique not supported":`Radius: ${t4(i)} ${a}`;f.push(e)}if(o){let e=d?"Area: Oblique not supported":`Area: ${t4(o)} ${c}`;f.push(e)}return r&&f.push(`Mean: ${t4(r)} ${h}`),s&&f.push(`Max: ${t4(s)} ${h}`),l&&f.push(`Std Dev: ${t4(l)} ${h}`),f},this._calculateCachedStats=(e,t,n,i,a)=>{let o=e.data,{viewportId:r,renderingEngineId:l}=i,{points:s}=o.handles,d=s.map(e=>t.worldToCanvas(e)),{viewPlaneNormal:u,viewUp:c}=t.getCamera(),[h,f]=rB(d),g=t.canvasToWorld(h),m=t.canvasToWorld(f),{cachedStats:v}=o,p=Object.keys(v);for(let t=0;t<p.length;t++){let i=p[t],o=this.getTargetIdImage(i,n);if(!o)continue;let{dimensions:r,imageData:l,metadata:s,hasPixelSpacing:d}=o,h=rF(l,g);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);let f=rF(l,m);if(f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(h,f,r)){let t=Math.min(h[0],f[0]),n=Math.max(h[0],f[0]),r=Math.min(h[1],f[1]),d=Math.max(h[1],f[1]),p=Math.min(h[2],f[2]),C=Math.max(h[2],f[2]),E=[[t,n],[r,d],[p,C]],_=[(g[0]+m[0])/2,(g[1]+m[1])/2,(g[2]+m[2])/2],T={center:_,xRadius:Math.abs(g[0]-m[0])/2,yRadius:Math.abs(g[1]-m[1])/2,zRadius:Math.abs(g[2]-m[2])/2},{worldWidth:I,worldHeight:w}=rR(u,c,g,m),b=0===I&&0===w,S=n3(o),D=n4(o),O=Math.abs(Math.PI*(I/S/2)*(w/D/S/2)),y=0,M=0,P=0,A=-1/0,N=({value:e})=>{e>A&&(A=e),M+=e,y+=1};t1(l,(e,t)=>na(T,e),N,E),M/=y;let L=({value:e})=>{let t=e-M;P+=t*t};t1(l,(e,t)=>na(T,e),L,E),P/=y,P=Math.sqrt(P);let x=ii(s.Modality,e.metadata.referencedImageId,a);v[i]={Modality:s.Modality,area:O,mean:M,max:A,stdDev:P,isEmptyArea:b,areaUnit:n5(null,o),radius:I/2/S,radiusUnit:n2(null,o),perimeter:2*Math.PI*(I/2)/S,modalityUnit:x}}else this.isHandleOutsideImage=!0,v[i]={Modality:s.Modality}}e.invalidated=!1;let C=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,C,{annotation:e,viewportId:r,renderingEngineId:l}),v},this._isInsideVolume=(e,t,n)=>nQ.Z(e,n)&&nQ.Z(t,n),this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}}r$.toolName="CircleROI";var rq=r$;let{transformWorldToIndex:rj}=tK;class rz extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,{points:l}=r.handles,s=o.worldToCanvas(l[0]),d=o.worldToCanvas(l[1]),u={start:{x:s[0],y:s[1]},end:{x:d[0],y:d[1]}},c=n7([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]);return c<=i||(s=o.worldToCanvas(l[2]),d=o.worldToCanvas(l[3]),(c=n7([(u={start:{x:s[0],y:s[1]},end:{x:d[0],y:d[1]}}).start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]))<=i)},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),eX(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{let i;let a=e.detail,{element:o}=a,r=t.data;t.highlighted=!0;let l=!1;n.worldPosition?l=!0:i=r.handles.points.findIndex(e=>e===n);let s=nk(o,this.getToolName());eX(o),this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(void 0!==this.editData.handleIndex){let{points:e}=l.handles,t=th.distance(e[0],e[1]),n=th.distance(e[2],e[3]);if(n>t){let t;let n=[[...e[2]],[...e[3]]],i=[...e[0]],a=[...e[1]],o=nV.Ue();nV.t8(o,n[1][0]-n[0][0],n[1][1]-n[1][0]);let r=nV.Ue();nV.t8(r,-o[1],o[0]);let s=nV.Ue();nV.t8(s,a[0]-i[0],a[1]-i[0]),t=nV.AK(s,r)>0?[i,a]:[a,i],l.handles.points=[n[0],n[1],t[0],t[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;let t=e.detail,{currentPoints:n,element:i}=t,a=(0,Q.ZP)(i),{renderingEngine:o,viewport:r}=a,{worldToCanvas:l}=r,{annotation:s,viewportIdsToRender:d,handleIndex:u}=this.editData,{data:c}=s,h=n.world;c.handles.points[u]=[...h];let f=c.handles.points.map(l),g={longLineSegment:{start:{x:f[0][0],y:f[0][1]},end:{x:f[1][0],y:f[1][1]}},shortLineSegment:{start:{x:f[2][0],y:f[2][1]},end:{x:f[3][0],y:f[3][1]}}},m=nV.TE(f[0],f[1]),v=m/3,p=g.longLineSegment.start.x-g.longLineSegment.end.x,C=g.longLineSegment.start.y-g.longLineSegment.end.y,E=Math.sqrt(p*p+C*C),_=p/E,T=C/E,I=(g.longLineSegment.start.x+g.longLineSegment.end.x)/2,w=(g.longLineSegment.start.y+g.longLineSegment.end.y)/2;c.handles.points[2]=r.canvasToWorld([I+v*T,w-v*_]),c.handles.points[3]=r.canvasToWorld([I-v*T,w+v*_]),s.invalidated=!0,(0,tQ.Z)(o,d),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,i=(0,Q.ZP)(n),{renderingEngine:a}=i,{annotation:o,viewportIdsToRender:r,handleIndex:l,movingTextBox:s}=this.editData,{data:d}=o;if(s){let{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===l){let{deltaPoints:e}=t,n=e.world,i=d.handles.points;i.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else this._dragModifyHandle(e),o.invalidated=!0;(0,tQ.Z)(a,r)},this._dragModifyHandle=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=(0,Q.ZP)(i),{viewport:o}=a,{annotation:r,handleIndex:l}=this.editData,{data:s}=r,d=n.world,u=[o.worldToCanvas(s.handles.points[0]),o.worldToCanvas(s.handles.points[1]),o.worldToCanvas(s.handles.points[2]),o.worldToCanvas(s.handles.points[3])],c={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},h={start:{x:u[2][0],y:u[2][1]},end:{x:u[3][0],y:u[3][1]}},f=[...d],g=o.worldToCanvas(f);if(0===l||1===l){let e=u[0===l?1:0],t=nV.t8(nV.Ue(),g[0]-e[0],g[1]-e[1]),n=nV.t8(nV.Ue(),u[l][0]-e[0],u[l][1]-e[1]);nV.Fv(t,t),nV.Fv(n,n);let i={start:{x:e[0],y:e[1]},end:{x:g[0],y:g[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(i,h))return;let a=this._getSignedAngle(n,t),r=u[2][0],d=u[2][1],c=u[3][0],m=u[3][1];r-=e[0],d-=e[1],c-=e[0],m-=e[1];let v=r*Math.cos(a)-d*Math.sin(a),p=r*Math.sin(a)+d*Math.cos(a),C=c*Math.cos(a)-m*Math.sin(a),E=c*Math.sin(a)+m*Math.cos(a);r=v+e[0],d=p+e[1],c=C+e[0],m=E+e[1];let _=o.canvasToWorld([r,d]),T=o.canvasToWorld([c,m]);s.handles.points[l]=f,s.handles.points[2]=_,s.handles.points[3]=T}else{let e=2===l?3:2,t={longLineSegment:{start:c.start,end:c.end},shortLineSegment:{start:h.start,end:h.end}},n=nV.$X(nV.Ue(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),i=nV.Fv(nV.Ue(),n),a=nV.$X(nV.Ue(),[g[0],g[1]],[u[l][0],u[l][1]]),r=nV.kE(a),d=this._getSignedAngle(i,a),m=nV.od(nV.Ue(),[u[e][0],u[e][1]],i,Math.cos(d)*r);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:g[0],y:g[1]},end:{x:m[0],y:m[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;let v=ik([g[0],g[1]],[m[0],m[1]],[c.start.x,c.start.y],[c.end.x,c.end.y]);if(!v)return;s.handles.points[e]=o.canvasToWorld(m),s.handles.points[l]=f}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d,u;let c=o[a],{annotationUID:h,data:f}=c,{points:g,activeHandleIndex:m}=f.handles,v=g.map(e=>i.worldToCanvas(e));s.annotationUID=h;let p=this.getStyle("lineWidth",s,c),C=this.getStyle("lineDash",s,c),E=this.getStyle("color",s,c),_=this.getStyle("shadow",s,c);if(f.cachedStats[r]&&void 0!==f.cachedStats[r].unit?c.invalidated&&this._throttledCalculateCachedStats(c,l,e):(f.cachedStats[r]={length:null,width:null,unit:null},this._calculateCachedStats(c,l,e)),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(h))continue;(0,nP.isAnnotationLocked)(c)||this.editData||null===m||(d=[v[m]]),d&&tN(t,h,"0",d,{color:E});let T=`${h}-line-1`,I=`${h}-line-2`;tL(t,h,"0",v[0],v[1],{color:E,lineDash:C,lineWidth:p,shadow:_},T),tL(t,h,"1",v[2],v[3],{color:E,lineDash:C,lineWidth:p,shadow:_},I),n=!0;let w=this._getTextLines(f,r);if(!w||0===w.length)continue;f.handles.textBox.hasMoved||(u=ie(v),f.handles.textBox.worldPosition=i.canvasToWorld(u));let b=i.worldToCanvas(f.handles.textBox.worldPosition),S=tH(t,h,"1",w,b,v,{},this.getLinkedTextBoxStyle(s,c)),{x:D,y:O,width:y,height:M}=S;f.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,O]),topRight:i.canvasToWorld([D+y,O]),bottomLeft:i.canvasToWorld([D,O+M]),bottomRight:i.canvasToWorld([D+y,O+M])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{let n=nV.Ue();nV.t8(n,t.end.x-t.start.x,t.end.y-t.start.y),nV.Fv(n,n);let i={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}},a=ik([i.start.x,i.start.y],[i.end.x,i.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y]);return!a},this._getTextLines=(e,t)=>{let{cachedStats:n}=e,{length:i,width:a,unit:o}=n[t];if(void 0===i)return;let r=[`L: ${t4(i)} ${o}`,`W: ${t4(a)} ${o}`];return r},this._calculateCachedStats=(e,t,n)=>{let{data:i}=e,{viewportId:a,renderingEngineId:o}=n,r=i.handles.points[0],l=i.handles.points[1],s=i.handles.points[2],d=i.handles.points[3],{cachedStats:u}=i,c=Object.keys(u);for(let e=0;e<c.length;e++){let n=c[e],i=this.getTargetIdImage(n,t);if(!i)continue;let{imageData:a,dimensions:o}=i,h=n3(i),f=this._calculateLength(r,l)/h,g=this._calculateLength(s,d)/h,m=f>g?f:g,v=f>g?g:f,p=rj(a,r),C=rj(a,l),E=rj(a,s),_=rj(a,d);this._isInsideVolume(p,C,E,_,o)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,u[n]={length:m,width:v,unit:n2(null,i)}}e.invalidated=!1;let h=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,h,{annotation:e,viewportId:a,renderingEngineId:o}),u},this._isInsideVolume=(e,t,n,i,a)=>nQ.Z(e,a)&&nQ.Z(t,a)&&nQ.Z(n,a)&&nQ.Z(i,a),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,g),f}_calculateLength(e,t){let n=e[0]-t[0],i=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+i*i+a*a)}}rz.toolName="Bidirectional";var rK=rz;class rY extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:rX,changeTextCallback:rJ,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;eX(i),this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),{arrowFirst:h}=this.configuration,f=r.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:f,referencedImageId:c},data:{text:"",handles:{points:[[...a],[...a]],activeHandleIndex:null,arrowFirst:h,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,tB.addAnnotation)(g,i);let m=nk(i,this.getToolName());return this.editData={annotation:g,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,tQ.Z)(l,m),g},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,[l,s]=r.handles.points,d=o.worldToCanvas(l),u=o.worldToCanvas(s),c={start:{x:d[0],y:d[1]},end:{x:u[0],y:u[1]}},h=n7([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return h<=i},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),eX(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{viewportId:d,renderingEngineId:u,renderingEngine:c}=s;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),o)this.configuration.getTextCallback(e=>{if(!e){(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(c,a),this.editData=null,this.isDrawing=!1;return}i.data.text=e;let t=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,t,{annotation:i}),(0,tQ.Z)(c,a)});else{let e=e_.default.ANNOTATION_MODIFIED;(0,ep.Z)(eC.Z,e,{annotation:i,viewportId:d,renderingEngineId:u})}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{let t=e.detail,{element:n}=t,i=(0,tB.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;let a=i.find(e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6));a&&(this.configuration.changeTextCallback(a,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault())},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){let a;let l=o[e],{annotationUID:s,data:d}=l,{handles:u,text:c}=d,{points:h,activeHandleIndex:f}=u;r.annotationUID=s;let g=this.getStyle("lineWidth",r,l),m=this.getStyle("lineDash",r,l),v=this.getStyle("color",r,l),p=h.map(e=>i.worldToCanvas(e));if((0,nP.isAnnotationLocked)(l)||this.editData||null===f||(a=[p[f]]),a&&tN(t,s,"0",p,{color:v,lineWidth:g}),this.configuration.arrowFirst?tW(t,s,"1",p[1],p[0],{color:v,width:g,lineDash:m}):tW(t,s,"1",p[0],p[1],{color:v,width:g,lineDash:m}),n=!0,!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!c)continue;if(!d.handles.textBox.hasMoved){let e=p[1];d.handles.textBox.worldPosition=i.canvasToWorld(e)}let C=i.worldToCanvas(d.handles.textBox.worldPosition),E=tH(t,s,"1",[c],C,p,{},this.getLinkedTextBoxStyle(r,l)),{x:_,y:T,width:I,height:w}=E;d.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([_,T]),topRight:i.canvasToWorld([_+I,T]),bottomLeft:i.canvasToWorld([_,T+w]),bottomRight:i.canvasToWorld([_+I,T+w])}}return n}}handleSelectedCallback(e,t,n){let i;let a=e.detail,{element:o}=a,{data:r}=t;t.highlighted=!0;let l=!1;n.worldPosition?l=!0:i=r.handles.points.findIndex(e=>e===n);let s=nk(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o),eX(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;let{renderingEngine:i,viewportId:a,renderingEngineId:o}=(0,Q.ZP)(e),r=nk(e,this.getToolName());(0,tQ.Z)(i,r);let l=e_.default.ANNOTATION_MODIFIED;(0,ep.Z)(eC.Z,l,{annotation:t,viewportId:a,renderingEngineId:o})}_isInsideVolume(e,t,n){return nQ.Z(e,n)&&nQ.Z(t,n)}}function rX(e){return e(prompt("Enter your annotation:"))}function rJ(e,t,n){return n(prompt("Enter your annotation:"))}rY.toolName="ArrowAnnotate";var rQ=rY;class r0 extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;eX(i),this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,[l,s,d]=r.handles.points,u=o.worldToCanvas(l),c=o.worldToCanvas(s),h={start:{x:u[0],y:u[1]},end:{x:c[0],y:c[1]}},f=n7([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);if(f<=i)return!0;if(!d)return!1;let g=o.worldToCanvas(d),m={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}},v=n7([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]);return v<=i},this.toolSelectedCallback=(e,t)=>{let n=e.detail,{element:i}=n;t.highlighted=!0;let a=nk(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),eX(i);let o=(0,Q.ZP)(i),{renderingEngine:r}=o;(0,tQ.Z)(r,a),e.preventDefault()},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;if(this.angleStartedNotYetCompleted&&2===l.handles.points.length){this.editData.handleIndex=2;return}this.angleStartedNotYetCompleted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d;let u=o[a],{annotationUID:c,data:h}=u,{points:f,activeHandleIndex:g}=h.handles;s.annotationUID=c;let m=this.getStyle("lineWidth",s,u),v=this.getStyle("lineDash",s,u),p=this.getStyle("color",s,u),C=f.map(e=>i.worldToCanvas(e));if(h.cachedStats[r]?u.invalidated&&this._throttledCalculateCachedStats(u,l,e):(h.cachedStats[r]={angle:null},this._calculateCachedStats(u,l,e)),(0,nP.isAnnotationLocked)(u)||this.editData||null===g||(d=[C[g]]),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}d&&tN(t,c,"0",C,{color:p,lineDash:v,lineWidth:m});let E="1";if(tL(t,c,E,C[0],C[1],{color:p,width:m,lineDash:v}),n=!0,3!==C.length)break;if(tL(t,c,E="2",C[1],C[2],{color:p,width:m,lineDash:v}),!h.cachedStats[r]?.angle)continue;let _=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){let e=C[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}let T=i.worldToCanvas(h.handles.textBox.worldPosition),I=tH(t,c,"1",_,T,C,{},this.getLinkedTextBoxStyle(s,u)),{x:w,y:b,width:S,height:D}=I;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([w,b]),topRight:i.canvasToWorld([w+S,b]),bottomLeft:i.canvasToWorld([w,b+D]),bottomRight:i.canvasToWorld([w+S,b+D])}}return n},this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){let i;let a=e.detail,{element:o}=a,{data:r}=t;t.highlighted=!0;let l=!1;n.worldPosition?l=!0:i=r.handles.points.findIndex(e=>e===n);let s=nk(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},this._activateModify(o),eX(o);let d=(0,Q.ZP)(o),{renderingEngine:u}=d;(0,tQ.Z)(u,s),e.preventDefault()}_getTextLines(e,t){let n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;let a=[`${t4(i)} ${String.fromCharCode(176)}`];return a}_calculateCachedStats(e,t,n){let i=e.data,{viewportId:a,renderingEngineId:o}=n;if(3!==i.handles.points.length)return;let r=i.handles.points[0],l=i.handles.points[1],s=i.handles.points[2],{cachedStats:d}=i,u=Object.keys(d);for(let e=0;e<u.length;e++){let t=u[e],n=rd([r,l],[l,s]);d[t]={angle:n}}e.invalidated=!1;let c=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,c,{annotation:e,viewportId:a,renderingEngineId:o}),d}}r0.toolName="Angle";var r1=r0;let r2=(...e)=>{let t=2===e[0].length?[0,0]:[0,0,0],n=e.length;for(let i of e)t[0]+=i[0]/n,t[1]+=i[1]/n,3===t.length&&(t[2]+=i[2]/n);return t};class r5 extends nJ{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;eX(i),this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.getReferencedImageId(r,a,d,u),h=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:h,referencedImageId:c},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,tB.addAnnotation)(f,i);let g=nk(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,tQ.Z)(l,g),f},this.isPointNearTool=(e,t,n,i)=>{let a=(0,Q.ZP)(e),{viewport:o}=a,{data:r}=t,[l,s,d,u]=r.handles.points,c=o.worldToCanvas(l),h=o.worldToCanvas(s),f=o.worldToCanvas(d),g=o.worldToCanvas(u),m={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}},v={start:{x:f[0],y:f[1]},end:{x:g[0],y:g[1]}},p=n7([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]),C=n7([v.start.x,v.start.y],[v.end.x,v.end.y],[n[0],n[1]]);return p<=i||C<=i},this.toolSelectedCallback=(e,t,n)=>{let i=e.detail,{element:a}=i;t.highlighted=!0;let o=nk(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(a),eX(a);let r=(0,Q.ZP)(a),{renderingEngine:l}=r;(0,tQ.Z)(l,o),e.preventDefault()},this._mouseUpCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:o,hasMoved:r}=this.editData,{data:l}=i;if(o&&!r)return;if(this.angleStartedNotYetCompleted&&l.handles.points.length<4){eY(n),this.editData.handleIndex=l.handles.points.length;return}this.angleStartedNotYetCompleted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),eY(n);let s=(0,Q.ZP)(n),{renderingEngine:d}=s;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,tB.removeAnnotation)(i.annotationUID),(0,tQ.Z)(d,a),o){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:i})}this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{let{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:a,currentPoints:o}=i,r=o.world,{data:l}=t;if(1===n){l.handles.points[1]=r,this.editData.hasMoved=l.handles.points[1][0]!==l.handles.points[0][0]||l.handles.points[1][1]!==l.handles.points[0][0];return}if(3===n){l.handles.points[3]=r,this.editData.hasMoved=l.handles.points[3][0]!==l.handles.points[2][0]||l.handles.points[3][1]!==l.handles.points[2][0],this.angleStartedNotYetCompleted=!1;return}this.editData.hasMoved=!1,eX(a),l.handles.points[2]=l.handles.points[3]=r,this.editData.handleIndex=l.handles.points.length-1},this._mouseDragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:o,movingTextBox:r}=this.editData,{data:l}=i;if(r){let{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:a}=i;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],i.hasMoved=!0}else if(void 0===o){let{deltaPoints:e}=t,n=e.world,a=l.handles.points;a.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{let{currentPoints:e}=t,n=e.world;l.handles.points[o]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;let s=(0,Q.ZP)(n),{renderingEngine:d}=s;(0,tQ.Z)(d,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),eY(e);let{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;let o=(0,Q.ZP)(e),{renderingEngine:r}=o;if((0,tQ.Z)(r,n),i){let e=e_.default.ANNOTATION_COMPLETED;(0,ep.Z)(eC.Z,e,{annotation:t})}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._mouseUpCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._mouseUpCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(e_.default.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(e_.default.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(e_.default.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(e_.default.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i}=e,{element:a}=i,o=(0,tB.getAnnotations)(this.getToolName(),a);if(!o?.length||(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length))return n;let r=this.getTargetId(i),l=i.getRenderingEngine(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<o.length;a++){let d;let u=o[a],{annotationUID:c,data:h}=u,{points:f,activeHandleIndex:g}=h.handles;s.annotationUID=c;let m=this.getStyle("lineWidth",s,u),v=this.getStyle("lineDash",s,u),p=this.getStyle("color",s,u),C=f.map(e=>i.worldToCanvas(e));if(h.cachedStats[r]?u.invalidated&&this._throttledCalculateCachedStats(u,l,e):(h.cachedStats[r]={angle:null},this._calculateCachedStats(u,l,e)),(0,nP.isAnnotationLocked)(u)||this.editData||null===g||(d=[C[g]]),!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}d&&tN(t,c,"0",C,{color:p,lineDash:v,lineWidth:m});let E="1";if(tL(t,c,E,C[0],C[1],{color:p,width:m,lineDash:v}),n=!0,C.length<4)break;tL(t,c,E="2",C[2],C[3],{color:p,width:m,lineDash:v}),E="3";let _=r2(C[0],C[1]),T=r2(C[2],C[3]);if(tL(t,c,E,_,T,{color:p,lineWidth:"1",lineDash:"1,4"}),!h.cachedStats[r]?.angle)continue;let I=this._getTextLines(h,r);if(!h.handles.textBox.hasMoved){let e=ie(C);h.handles.textBox.worldPosition=i.canvasToWorld(e)}let w=i.worldToCanvas(h.handles.textBox.worldPosition),b=tH(t,c,"1",I,w,C,{},this.getLinkedTextBoxStyle(s,u)),{x:S,y:D,width:O,height:y}=b;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([S,D]),topRight:i.canvasToWorld([S+O,D]),bottomLeft:i.canvasToWorld([S,D+y]),bottomRight:i.canvasToWorld([S+O,D+y])}}return n},this._throttledCalculateCachedStats=tz(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n,i="mouse"){let a;let o=e.detail,{element:r}=o,{data:l}=t;t.highlighted=!0;let s=!1;n.worldPosition?s=!0:a=l.handles.points.findIndex(e=>e===n);let d=nk(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:a,movingTextBox:s},this._activateModify(r),eX(r);let u=(0,Q.ZP)(r),{renderingEngine:c}=u;(0,tQ.Z)(c,d),e.preventDefault()}_getTextLines(e,t){let n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;let a=[`${i.toFixed(2)} ${String.fromCharCode(176)}`];return a}_calculateCachedStats(e,t,n){let i=e.data,{viewportId:a,renderingEngineId:o}=n;if(4!==i.handles.points.length)return;let r=[null,null],l=[null,null],s=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){let n=th.distance(i.handles.points[e],i.handles.points[t]);n<s&&(s=n,r[1]=i.handles.points[e],r[0]=i.handles.points[(e+1)%2],l[0]=i.handles.points[t],l[1]=i.handles.points[2+(t-1)%2])}let{cachedStats:d}=i,u=Object.keys(d);for(let e=0;e<u.length;e++){let t=u[e],n=rd(r,l);d[t]={angle:n}}e.invalidated=!1;let c=e_.default.ANNOTATION_MODIFIED;return(0,ep.Z)(eC.Z,c,{annotation:e,viewportId:a,renderingEngineId:o}),d}}r5.toolName="CobbAngle";var r3=r5,r4=n(50687);let r8="magnify-viewport";class r9 extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{element:n,currentPoints:i}=t,a=(0,Q.ZP)(n),{viewport:o,renderingEngine:r}=a;if(!(o instanceof tr.Z))throw Error("MagnifyTool only works on StackViewports");let l=this._getReferencedImageId(o);if(!l)throw Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");let s=nk(n,this.getToolName());return this.editData={referencedImageId:l,viewportIdsToRender:s,enabledElement:a,renderingEngine:r,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),eX(n),e.preventDefault(),(0,tQ.Z)(r,s),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{let e;let{enabledElement:t,referencedImageId:n,viewportIdsToRender:i,renderingEngine:a,currentPoints:o}=this.editData,{viewport:r}=t,{element:l}=r,{voiRange:s}=r.getProperties(),{canvas:d,world:u}=o;if(null===(e=l.querySelector(".magnifyTool"))){let t=document.createElement("div");t.classList.add("magnifyTool"),t.style.display="block",t.style.width=`${this.configuration.magnifyWidth}px`,t.style.height=`${this.configuration.magnifyHeight}px`,t.style.position="absolute",e=t;let n=l.querySelector(".viewport-element");n.appendChild(t);let i={viewportId:r8,type:r4.Z.STACK,element:e};a.enableElement(i)}e.style.top=`${d[1]-this.configuration.magnifyHeight/2}px`,e.style.left=`${d[0]-this.configuration.magnifyWidth/2}px`;let c=a.getViewport(r8);c.setStack([n]).then(()=>{c.setProperties({voiRange:s});let{parallelScale:e}=r.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=c.getCamera(),a=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),o=[u[0],u[1],u[2]],l=[o[0]+a*i[0],o[1]+a*i[1],o[2]+a*i[2]];c.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:o,position:l}),c.render()}),e.style.display="block",(0,tQ.Z)(a,i)},this._dragCallback=e=>{let t=e.detail,{deltaPoints:n,element:i,currentPoints:a}=t,o=n.world,r=a.canvas,l=(0,Q.ZP)(i),{renderingEngine:s}=l,d=s.getViewport(r8),u=i.querySelector(".magnifyTool");if(!u)return;u.style.top=`${r[1]-this.configuration.magnifyHeight/2}px`,u.style.left=`${r[0]-this.configuration.magnifyWidth/2}px`;let{focalPoint:c,position:h}=d.getCamera(),f=[h[0]+o[0],h[1]+o[1],h[2]+o[2]],g=[c[0]+o[0],c[1]+o[1],c[2]+o[2]];d.setCamera({focalPoint:g,position:f}),d.render()},this._dragEndCallback=e=>{let{element:t}=e.detail,n=(0,Q.ZP)(t),{renderingEngine:i}=n;i.disableElement(r8);let a=t.querySelector(".viewport-element"),o=a.querySelector(".magnifyTool");a.removeChild(o),this._deactivateDraw(t),eY(t)},this._activateDraw=e=>{q.ZP.isInteractingWithTool=!0,e.addEventListener(e_.default.MOUSE_UP,this._dragEndCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(e_.default.TOUCH_END,this._dragEndCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{q.ZP.isInteractingWithTool=!1,e.removeEventListener(e_.default.MOUSE_UP,this._dragEndCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(e_.default.TOUCH_END,this._dragEndCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){let t;let n=this.getTargetId(e);return e instanceof tr.Z&&(t=n.split("imageId:")[1]),t}}r9.toolName="Magnify";var r7=r9,r6=n(4684);class le extends nY{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{let{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;let a=this.getActiveAnnotation(n);return null===a?this.createInitialAnnotation(i.world,n):this.updateAnnotationPosition(n,a),!1},this.createInitialAnnotation=(e,t)=>{let n=(0,Q.ZP)(t);if(!n)throw Error("No enabled element found");let{viewport:i,renderingEngine:a}=n;this.isDrawing=!0;let o=i.getCamera(),{viewPlaneNormal:r,viewUp:l}=o;if(!r||!l)throw Error("Camera not found");let s=this.getReferencedImageId(i,e,r,l),d=i.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...l],FrameOfReferenceUID:d,referencedImageId:s},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}},c=(0,tB.getAnnotations)(this.getToolName(),t);if(c.length>0)return null;let h=(0,tB.addAnnotation)(u,t);if(null===h)return;let f=nk(t,this.getToolName(),!1);(0,tQ.Z)(a,f)},this.onCameraModified=e=>{let t=e.detail,{element:n,previousCamera:i,camera:a}=t,o=(0,Q.ZP)(n),r=o.viewport;if(n!==this._elementWithCursor)return;let l=i.focalPoint,s=a.viewPlaneNormal,d=a.focalPoint,u=[0,0,0];if(iK.ZP.subtract(d,l,u),0===u.reduce((e,t)=>e+t,0))return;let c=iK.ZP.dot(u,s);if(.01>Math.abs(c)||!this._currentCanvasPosition)return;let h=r.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=h,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1,{viewport:i,FrameOfReferenceUID:a}=e,o=this._elementWithCursor===i.element;this.configuration.positionSync&&!o&&this.updateViewportImage(i);let{element:r}=i,l=(0,tB.getAnnotations)(this.getToolName(),r);if(!l?.length||(l=this.filterInteractableAnnotationsForElement(r,l),!l?.length))return n;let s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){let a=l[e],{annotationUID:r,data:d}=a,{handles:u}=d,{points:c}=u;if(!r)break;s.annotationUID=r;let h=parseFloat(this.getStyle("lineWidth",s,a)),f=this.getStyle("lineDash",s,a),g=this.getStyle("color",s,a);if(c[0].some(e=>isNaN(e)))break;let m=c.map(e=>i.worldToCanvas(e));if(!i.getRenderingEngine()){console.warn("Rendering Engine has been destroyed");break}if(!(0,nR.isAnnotationVisible)(r))continue;let v={upper:"upper",right:"right",lower:"lower",left:"left"},[p,C]=m[0],E=o?20:7,_=o?5:7;tL(t,r,v.upper,[p,C-(E/2+_)],[p,C-E/2],{color:g,lineDash:f,lineWidth:h}),tL(t,r,v.lower,[p,C+(E/2+_)],[p,C+E/2],{color:g,lineDash:f,lineWidth:h}),tL(t,r,v.right,[p+(E/2+_),C],[p+E/2,C],{color:g,lineDash:f,lineWidth:h}),tL(t,r,v.left,[p-(E/2+_),C],[p-E/2,C],{color:g,lineDash:f,lineWidth:h}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;let e=(0,e9.Z)(this.toolGroupId).viewportsInfo;if(!e)return;let t=e.map(e=>(0,Q.O)(e.viewportId,e.renderingEngineId));t.forEach(e=>{e&&eX(e.viewport.element)})}onSetToolDisabled(){if(!this._disableCursorEnabled)return;let e=(0,e9.Z)(this.toolGroupId).viewportsInfo;if(!e)return;let t=e.map(e=>(0,Q.O)(e.viewportId,e.renderingEngineId));t.forEach(e=>{e&&eY(e.viewport.element)})}getActiveAnnotation(e){let t=(0,tB.getAnnotations)(this.getToolName(),e);if(!t.length)return null;let n=t[0];return n}updateAnnotationPosition(e,t){let n=this._currentCursorWorldPosition;if(!n||!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;let i=nk(e,this.getToolName(),!1),a=(0,Q.ZP)(e);if(!a)return;let{renderingEngine:o}=a;(0,tQ.Z)(o,i)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];let n=t[0],i=Q.ZP(e)?.viewport;if(!i)return[];let a=i.getCamera(),{viewPlaneNormal:o,focalPoint:r}=a;if(!o||!r)return[];let l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];let s=l[0],d=rb.planeEquation(o,r),u=rb.planeDistanceToPoint(d,s);return u<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){let t=this._currentCursorWorldPosition;if(!(!t||t.some(e=>isNaN(e)))){if(e instanceof tr.Z){let n=r6.Z(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof tm.Z){let{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;let a=rb.planeEquation(i,n),o=rb.planeDistanceToPoint(a,t,!0);if(.5>Math.abs(o))return;let r=th.normalize(th.create(),th.fromValues(...i)),l=th.scale(th.create(),r,o),s=th.add(th.create(),th.fromValues(...n),l);{e.setCamera({focalPoint:s});let t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}}le.toolName="ReferenceCursors";var lt=le;let ln=[];class li extends nY{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData={},this._init=()=>{let e=(0,ee.Uu)()[0];if(!e)return;let t=(0,e9.Z)(this.toolGroupId).viewportsInfo;if(!t)return;let n=t.map(e=>(0,Q.O)(e.viewportId,e.renderingEngineId)),{viewport:i}=n[0],{FrameOfReferenceUID:a}=n[0];if(this.configuration.viewportId&&n.forEach(e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)}),!i)return;let{viewUp:o,viewPlaneNormal:r}=i.getCamera(),l=rx.Z(i),s=this.editData.annotation,d=(0,tB.getAnnotations)(this.getToolName(),i.element);if(d.length&&(s=d.filter(e=>e.data.viewportId==i.id)[0]),ln.includes(i.id))this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=l,this.editData.annotation.data.viewportId=i.id);else{let e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...r],viewUp:[...o],FrameOfReferenceUID:a,referencedImageId:null},data:{handles:{points:l},viewportId:i.id}};ln.push(i.id),(0,tB.addAnnotation)(e,i.element),s=e}this.editData={viewport:i,renderingEngine:e,annotation:s}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{let i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];return("top"==n||"bottom"==n?i.filter(t=>t<.6*e&&t>.2*e):i.filter(e=>e<.6*t&&e>.2*t))[0]},this.computeEndScaleTicks=(e,t)=>{let n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]},i=[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],a=[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]];return{endTick1:i,endTick2:a}},this.computeInnerScaleTicks=(e,t,n,i,a)=>{let o;"bottom"==t||"top"==t?o=a[0][0]-i[0][0]:("left"==t||"right"==t)&&(o=a[0][1]-i[0][1]);let r=[],l=[],s=[],d=e;e>=50&&(d=e/10);let u=o/d;for(let e=0;e<d-1;e++){let a={bottom:[[u*(e+1),0],[u*(e+1),5]],top:[[u*(e+1),0],[u*(e+1),-5]],left:[[0,u*(e+1)],[-5,u*(e+1)]],right:[[0,u*(e+1)],[5,u*(e+1)]]};r.push(`${n}-tick${e}`),l.push(`tick${e}`),(e+1)%5==0?s.push([[i[0][0]+a[t][0][0],i[0][1]+a[t][0][1]],[i[1][0]+a[t][0][0],i[1][1]+a[t][0][1]]]):s.push([[i[0][0]+a[t][0][0],i[0][1]+a[t][0][1]],[i[1][0]+a[t][1][0],i[1][1]+a[t][1][1]]])}return{tickIds:r,tickUIDs:l,tickCoordinates:s}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i;let a=th.subtract(th.create(),n[0],n[1]);a=th.normalize(th.create(),a);let o=th.subtract(th.create(),n[2],n[0]);o=th.normalize(th.create(),o);let r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},l=th.add(th.create(),r[t][0],r[t][0]).map(e=>e/2),s=e/2/Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2));return"top"==t||"bottom"==t?i=[th.subtract(th.create(),l,o.map(e=>e*s)),th.add(th.create(),l,o.map(e=>e*s))]:("left"==t||"right"==t)&&(i=[th.add(th.create(),l,a.map(e=>e*s)),th.subtract(th.create(),l,a.map(e=>e*s))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,a)=>{let o;if("top"==a||"bottom"==a){let i=t[0][0]-t[1][0];o=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==a||"right"==a){let n=t[0][1]-t[1][1];o=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return o},this.computeScaleBounds=(e,t,n,i)=>{let a=t*Math.min(1e3,e.width),o=n*Math.min(1e3,e.height),r={bottom:[-o,-a],top:[o,a],left:[o,a],right:[-o,-a]},l={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:l[i][0]+r[i][0],width:l[i][1]+r[i][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;let n=this.configuration.scaleLocation,{viewport:i}=e,a=(0,tB.getAnnotations)(this.getToolName(),i.element),o=a.filter(e=>e.data.viewportId==i.id)[0],r=e.viewport.canvas;if(!i)return!1;let l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},s={width:r.width,height:r.height},d=o.data.handles.points[0],u=o.data.handles.points[1],c=o.data.handles.points[2],h=o.data.handles.points[3],f=[d,c,u,h],g=th.distance(c,h),m=th.distance(d,c),v=this.computeScaleBounds(s,.05,.05,n),p=this.computeScaleBounds(s,.05,.05,n),C=this.computeScaleSize(g,m,n),E=this.computeWorldScaleCoordinates(C,n,f).map(e=>i.worldToCanvas(e)),_=this.computeCanvasScaleCoordinates(s,E,p,v,n),T=this.computeEndScaleTicks(_,n),{annotationUID:I}=o;l.annotationUID=I;let w=this.getStyle("lineWidth",l,o),b=this.getStyle("lineDash",l,o),S=this.getStyle("color",l,o),D=this.getStyle("shadow",l,o),O=`${I}-scaleline`;tL(t,I,"1",_[0],_[1],{color:S,width:w,lineDash:b,shadow:D},O);let y=`${I}-left`;tL(t,I,"2",T.endTick1[0],T.endTick1[1],{color:S,width:w,lineDash:b,shadow:D},y);let M=`${I}-right`;tL(t,I,"3",T.endTick2[0],T.endTick2[1],{color:S,width:w,lineDash:b,shadow:D},M);let P={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},A=[_[0][0]+P[n][0],_[0][1]+P[n][1]],N=this._getTextLines(C),{tickIds:L,tickUIDs:x,tickCoordinates:Z}=this.computeInnerScaleTicks(C,n,I,T.endTick1,T.endTick2);for(let e=0;e<x.length;e++)tL(t,I,x[e],Z[e][0],Z[e][1],{color:S,width:w,lineDash:b,shadow:D},L[e]);return tk(t,I,"text0",N,[A[0],A[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:S}),!1}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");let i=[t.toString().concat(n)];return i}}li.toolName="ScaleOverlay";var la=li;let{transformWorldToIndex:lo}=tK;function lr(e,t){!function(e,t,n=!0){let{volume:i,points:a,segmentsLocked:o,segmentIndex:r,segmentationId:l,constraintFn:s}=t,{imageData:d,dimensions:u}=i,c=i.getScalarData(),h=a.map(e=>lo(d,e));h=h.map(e=>e.map(e=>Math.round(e)));let f=t2(h,u);t1(d,()=>!0,({value:e,index:t,pointIJK:n})=>{if(!o.includes(e)){if(!s){c[t]=r;return}s(n)&&(c[t]=r)}},f),(0,t8.triggerSegmentationDataModified)(l)}(0,t,!0)}let{transformWorldToIndex:ll}=tK;function ls(e,t){!function(e,t,n=!0){let{volume:i,points:a,segmentsLocked:o,segmentationId:r}=t,{imageData:l,dimensions:s}=i,d=i.getScalarData(),u=a.map(e=>ll(l,e)),c=t2(u,s);t1(l,()=>!0,({value:e,index:t})=>{o.includes(e)||(d[t]=0)},c),(0,t8.triggerSegmentationDataModified)(r)}(0,t,!0)}class ld extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:lr,ERASE_INSIDE:ls},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r,renderingEngine:l}=o;this.isDrawing=!0;let s=r.getCamera(),{viewPlaneNormal:d,viewUp:u}=s,c=this.toolGroupId,h=nc(c);if(!h)throw Error("No active segmentation detected, create one before using scissors tool");let{segmentationRepresentationUID:f,segmentationId:g,type:m}=h,v=np(g),p=nm(g),C=n_(c,f,v),{representationData:E}=(0,nu.getSegmentation)(g),{volumeId:_}=E[m],T=t7.ZP.getVolume(_),I={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...u],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:C},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null}}},w=nk(i,this.getToolName());return this.editData={annotation:I,segmentation:T,segmentIndex:v,segmentsLocked:p,segmentColor:C,segmentationId:g,viewportIdsToRender:w,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(l,w),!0},this._dragCallback=e=>{let t,n,i,a,o,r,l,s;this.isDrawing=!0;let d=e.detail,{element:u}=d,{annotation:c,viewportIdsToRender:h,handleIndex:f}=this.editData,{data:g}=c,{currentPoints:m}=d,v=(0,Q.ZP)(u),{worldToCanvas:p,canvasToWorld:C}=v.viewport,E=m.world,{points:_}=g.handles;switch(_[f]=[...E],f){case 0:case 3:t=p(_[0]),n=[(a=p(_[3]))[0],t[1]],i=[t[0],a[1]],r=C(n),l=C(i),_[1]=r,_[2]=l;break;case 1:case 2:n=p(_[1]),t=[(i=p(_[2]))[0],n[1]],a=[n[0],i[1]],o=C(t),s=C(a),_[0]=o,_[3]=s}c.invalidated=!0,this.editData.hasMoved=!0;let{renderingEngine:T}=v;(0,tQ.Z)(T,h)},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o,segmentation:r,segmentationId:l,segmentIndex:s,segmentsLocked:d}=this.editData,{data:u}=i;if(a&&!o)return;u.handles.activeHandleIndex=null,this._deactivateDraw(n),eY(n);let c=(0,Q.ZP)(n),{viewport:h}=c;if(this.editData=null,this.isDrawing=!1,h instanceof tr.Z)throw Error("Not implemented yet");let f={points:u.handles.points,volume:r,segmentationId:l,segmentIndex:s,segmentsLocked:d};this.applyActiveStrategy(c,f)},this._activateDraw=e=>{e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;let{viewport:i}=e,{annotation:a}=this.editData,o=a.metadata,r=a.annotationUID,l=a.data,{points:s}=l.handles,d=s.map(e=>i.worldToCanvas(e)),u=`rgb(${o.segmentColor.slice(0,3)})`;return i.getRenderingEngine()?(tG(t,r,"0",d[0],d[3],{color:u}),n=!0):(console.warn("Rendering Engine has been destroyed"),n)}}}ld.toolName="RectangleScissor";var lu=ld;class lc extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:nl},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{viewport:l,renderingEngine:s}=r;this.isDrawing=!0;let d=l.getCamera(),{viewPlaneNormal:u,viewUp:c}=d,h=this.toolGroupId,f=nc(h);if(!f)throw Error("No active segmentation detected, create one before using scissors tool");let{segmentationRepresentationUID:g,segmentationId:m,type:v}=f,p=np(m),C=nm(m),E=n_(h,g,p),{representationData:_}=(0,nu.getSegmentation)(m),{volumeId:T}=_[v],I=t7.ZP.getVolume(T),w={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...u],viewUp:[...c],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},b=[l.id];return this.editData={annotation:w,segmentation:I,centerCanvas:o,segmentIndex:p,segmentationId:m,segmentsLocked:C,segmentColor:E,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(s,b),!0},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,Q.ZP)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:s}=l,{annotation:d,viewportIdsToRender:u,centerCanvas:c}=this.editData,{data:h}=d,f=Math.abs(a[0]-c[0]),g=Math.abs(a[1]-c[1]),m=Math.sqrt(f*f+g*g),v=[c[0],c[1]+m],p=[c[0],c[1]-m],C=[c[0]-m,c[1]],E=[c[0]+m,c[1]];h.handles.points=[s(v),s(p),s(C),s(E)],d.invalidated=!0,this.editData.hasMoved=!0,(0,tQ.Z)(r,u)},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o,segmentation:r,segmentIndex:l,segmentsLocked:s,segmentationId:d}=this.editData,{data:u}=i,{viewPlaneNormal:c,viewUp:h}=i.metadata;if(a&&!o)return;u.handles.activeHandleIndex=null,this._deactivateDraw(n),eY(n);let f=(0,Q.ZP)(n),{viewport:g}=f;if(this.editData=null,this.isDrawing=!1,g instanceof tr.Z)throw Error("Not implemented yet");let m={points:u.handles.points,volume:r,segmentIndex:l,segmentsLocked:s,viewPlaneNormal:c,segmentationId:d,viewUp:h};this.applyActiveStrategy(f,m)},this._activateDraw=e=>{e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;let{viewport:i}=e,{viewportIdsToRender:a}=this.editData;if(!a.includes(i.id))return n;let{annotation:o}=this.editData,r=o.metadata,l=o.annotationUID,s=o.data,{points:d}=s.handles,u=d.map(e=>i.worldToCanvas(e)),c=u[0],h=u[1],f=[Math.floor((c[0]+h[0])/2),Math.floor((c[1]+h[1])/2)],g=Math.abs(c[1]-Math.floor((c[1]+h[1])/2)),m=`rgb(${r.segmentColor.slice(0,3)})`;return i.getRenderingEngine()?(tP(t,l,"0",f,g,{color:m}),n=!0):(console.warn("Rendering Engine has been destroyed"),n)}}}lc.toolName="CircleScissor";var lh=lc;class lf extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:ne},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=n.canvas,r=(0,Q.ZP)(i),{viewport:l,renderingEngine:s}=r;this.isDrawing=!0;let d=l.getCamera(),{viewPlaneNormal:u,viewUp:c}=d,h=this.toolGroupId,f=nc(h);if(!f)throw Error("No active segmentation detected, create one before using scissors tool");let{segmentationRepresentationUID:g,segmentationId:m,type:v}=f,p=np(m),C=nm(m),E=n_(h,g,p),{representationData:_}=(0,nu.getSegmentation)(m),{volumeId:T}=_[v],I=t7.ZP.getVolume(T);this.isDrawing=!0;let w={metadata:{viewPlaneNormal:[...u],viewUp:[...c],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},b=[l.id];return this.editData={annotation:w,segmentation:I,centerCanvas:o,segmentIndex:p,segmentsLocked:C,segmentColor:E,segmentationId:m,toolGroupId:h,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),eX(i),e.preventDefault(),(0,tQ.Z)(s,b),!0},this._dragCallback=e=>{this.isDrawing=!0;let t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,o=(0,Q.ZP)(n),{renderingEngine:r,viewport:l}=o,{canvasToWorld:s}=l,{annotation:d,viewportIdsToRender:u,centerCanvas:c}=this.editData,{data:h}=d,f=Math.abs(a[0]-c[0]),g=Math.abs(a[1]-c[1]),m=Math.sqrt(f*f+g*g),v=[c[0],c[1]+m],p=[c[0],c[1]-m],C=[c[0]-m,c[1]],E=[c[0]+m,c[1]];h.handles.points=[s(v),s(p),s(C),s(E)],d.invalidated=!0,this.editData.hasMoved=!0,(0,tQ.Z)(r,u)},this._endCallback=e=>{let t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:o,segmentation:r,segmentIndex:l,segmentsLocked:s,segmentationId:d}=this.editData,{data:u}=i,{viewPlaneNormal:c,viewUp:h}=i.metadata;if(a&&!o)return;i.highlighted=!1,u.handles.activeHandleIndex=null,this._deactivateDraw(n),eY(n);let f=(0,Q.ZP)(n),{viewport:g}=f;if(this.editData=null,this.isDrawing=!1,g instanceof tr.Z)throw Error("Not implemented yet");let m={points:u.handles.points,volume:r,segmentIndex:l,segmentsLocked:s,segmentationId:d,viewPlaneNormal:c,viewUp:h};this.applyActiveStrategy(f,m)},this._activateDraw=e=>{e.addEventListener(e_.default.MOUSE_UP,this._endCallback),e.addEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.addEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.addEventListener(e_.default.TOUCH_END,this._endCallback),e.addEventListener(e_.default.TOUCH_TAP,this._endCallback),e.addEventListener(e_.default.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(e_.default.MOUSE_UP,this._endCallback),e.removeEventListener(e_.default.MOUSE_DRAG,this._dragCallback),e.removeEventListener(e_.default.MOUSE_CLICK,this._endCallback),e.removeEventListener(e_.default.TOUCH_END,this._endCallback),e.removeEventListener(e_.default.TOUCH_DRAG,this._dragCallback),e.removeEventListener(e_.default.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;let{viewport:i}=e,{viewportIdsToRender:a}=this.editData;if(!a.includes(i.id))return n;let{annotation:o}=this.editData,r=o.metadata,l=o.annotationUID,s=o.data,{points:d}=s.handles,u=d.map(e=>i.worldToCanvas(e)),c=u[0],h=u[1],f=[Math.floor((c[0]+h[0])/2),Math.floor((c[1]+h[1])/2)],g=Math.abs(c[1]-Math.floor((c[1]+h[1])/2)),m=`rgb(${r.segmentColor.slice(0,3)})`;return i.getRenderingEngine()?(tP(t,l,"0",f,g,{color:m}),n=!0):(console.warn("Rendering Engine has been destroyed"),n)}}}lf.toolName="SphereScissor";var lg=lf;let{transformWorldToIndex:lm,isEqual:lv}=tK;class lp extends t6.Z{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{let t=e.detail,{currentPoints:n,element:i}=t,a=n.world,o=(0,Q.ZP)(i),{viewport:r}=o,l=r.getCamera(),{viewPlaneNormal:s}=l,d=this.toolGroupId,u=nc(d);if(!u)throw Error("No active segmentation detected, create one before using scissors tool");let{segmentationId:c,type:h}=u,f=np(c),g=nm(c),{representationData:m}=(0,nu.getSegmentation)(c),{volumeId:v}=m[h],p=t7.ZP.getVolume(v),{dimensions:C,direction:E}=p,_=p.getScalarData(),T=lm(p.imageData,a),I=this.getFixedDimension(s,E);if(void 0===I){console.warn("Oblique paint fill not yet supported");return}let{floodFillGetter:w,getLabelValue:b,getScalarDataPositionFromPlane:S,inPlaneSeedPoint:D,fixedDimensionValue:O}=this.generateHelpers(_,C,T,I);if(T[0]<0||T[0]>=C[0]||T[1]<0||T[1]>=C[1]||T[2]<0||T[2]>=C[2])return;let y=b(T[0],T[1],T[2]);if(g.includes(y))return;let M=iy(w,D),{flooded:P}=M;P.forEach(e=>{let t=S(e[0],e[1]);_[t]=f});let A=this.getFramesModified(I,O,M);return(0,t8.triggerSegmentationDataModified)(c,A),!0},this.getFramesModified=(e,t,n)=>{let{boundaries:i}=n;if(2===e)return[t];let a=1/0,o=-1/0;for(let e=0;e<i.length;e++){let t=i[e][1];t<a&&(a=t),t>o&&(o=t)}let r=[];for(let e=a;e<=o;e++)r.push(e);return r},this.generateHelpers=(e,t,n,i=2)=>{let a,o;switch(i){case 0:a=n[0],o=[n[1],n[2]];break;case 1:a=n[1],o=[n[0],n[2]];break;case 2:a=n[2],o=[n[0],n[1]];break;default:throw Error(`Invalid fixedDimension: ${i}`)}let r=(e,n,i)=>i*t[1]*t[0]+n*t[0]+e,l=(t,n,i)=>e[r(t,n,i)],s=this.generateFloodFillGetter(t,i,a,l),d=this.generateGetScalarDataPositionFromPlane(r,i,a);return{getScalarDataPositionFromPlane:d,getLabelValue:l,floodFillGetter:s,inPlaneSeedPoint:o,fixedDimensionValue:a}},this.generateFloodFillGetter=(e,t,n,i)=>{let a;switch(t){case 0:a=(t,a)=>{if(!(t>=e[1])&&!(t<0)&&!(a>=e[2])&&!(a<0))return i(n,t,a)};break;case 1:a=(t,a)=>{if(!(t>=e[0])&&!(t<0)&&!(a>=e[2])&&!(a<0))return i(t,n,a)};break;case 2:a=(t,a)=>{if(!(t>=e[0])&&!(t<0)&&!(a>=e[1])&&!(a<0))return i(t,a,n)};break;default:throw Error(`Invalid fixedDimension: ${t}`)}return a},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){let n=t.slice(0,3),i=t.slice(3,6),a=t.slice(6,9),o=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],r=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(lv(o,r))return 0;let l=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(lv(o,l))return 1;let s=[Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2])];if(lv(o,s))return 2}}lp.toolName="PaintFill";var lC=lp,lE=n(7419),l_=n(37062)},54232:function(e,t,n){"use strict";let i,a;n.d(t,{ob:function(){return tJ},S1:function(){return tX}});var o=n(39040),r=n(74880),l=n(53323),s=n(63008),d=n(11130),u=n(28186),c=n(818);function h(e,t){let n=t||e.currentTarget,{viewport:i}=(0,u.ZP)(n),a=[e.clientX,e.clientY],o=[e.pageX,e.pageY],r=function(e,t){let n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o),l=i.canvasToWorld(r);return{page:o,client:a,canvas:r,world:l}}var f=function(e){let t=e.currentTarget,{viewportId:n,renderingEngineId:i}=(0,u.ZP)(t),a=h(e,t),o={event:e,eventName:d.default.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:i,camera:{},element:t,startPoints:a,lastPoints:a,currentPoints:a,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},r=!(0,c.Z)(t,d.default.MOUSE_DOUBLE_CLICK,o);r&&(e.stopImmediatePropagation(),e.preventDefault())};let g=d.default.MOUSE_MOVE;var m=function(e){let t=e.currentTarget,n=(0,u.ZP)(t),{renderingEngineId:i,viewportId:a}=n,o=h(e);(0,c.Z)(t,g,{renderingEngineId:i,viewportId:a,camera:{},element:t,currentPoints:o,eventName:g,event:e})};let{MOUSE_DOWN:v,MOUSE_DOWN_ACTIVATE:p,MOUSE_CLICK:C,MOUSE_UP:E,MOUSE_DRAG:_}=d.default,T={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},I={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},w={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function b(e){let t=h(e,I.element),n=L(I.element,I.lastPoints),i=x(t,n);if(w.doubleClickTimeout){if(!O(i.canvas))return;M()}let a={event:e,eventName:_,mouseButton:I.mouseButton,renderingEngineId:I.renderingEngineId,viewportId:I.viewportId,camera:{},element:I.element,startPoints:N(I.startPoints),lastPoints:N(n),currentPoints:t,deltaPoints:i};(0,c.Z)(I.element,_,a),I.lastPoints=N(t)}function S(e){if(clearTimeout(I.preventClickTimeout),w.doubleClickTimeout)w.mouseUpEvent?A():(w.mouseUpEvent=e,I.element.addEventListener("mousemove",D));else{let t=I.isClickEvent?C:E,n=h(e,I.element),i=x(n,I.lastPoints),a={event:e,eventName:t,mouseButton:I.mouseButton,element:I.element,renderingEngineId:I.renderingEngineId,viewportId:I.viewportId,camera:{},startPoints:N(I.startPoints),lastPoints:N(I.lastPoints),currentPoints:n,deltaPoints:i};(0,c.Z)(a.element,t,a),A()}document.removeEventListener("mousemove",b)}function D(e){let t=h(e,I.element),n=L(I.element,I.lastPoints),i=x(t,n);O(i.canvas)&&(M(),m(e))}function O(e){return Math.abs(e[0])+Math.abs(e[1])>3}function y(){I.isClickEvent=!1}function M(){w.ignoreDoubleClick=!0;let e=w.mouseDownEvent,t=w.mouseUpEvent;P(),function(e){let t=x(I.startPoints,I.startPoints),n={event:e,eventName:v,element:I.element,mouseButton:I.mouseButton,renderingEngineId:I.renderingEngineId,viewportId:I.viewportId,camera:{},startPoints:I.startPoints,lastPoints:I.startPoints,currentPoints:I.startPoints,deltaPoints:t};I.lastPoints=N(n.lastPoints);let i=(0,c.Z)(n.element,v,n);i&&(0,c.Z)(n.element,p,n)}(e),t&&S(t)}function P(){w.doubleClickTimeout&&(clearTimeout(w.doubleClickTimeout),w.doubleClickTimeout=null),w.mouseDownEvent=null,w.mouseUpEvent=null}function A(){document.removeEventListener("mouseup",S),I.element?.removeEventListener("mousemove",D),I.element?.addEventListener("mousemove",m),P(),I=JSON.parse(JSON.stringify(T))}function N(e){return JSON.parse(JSON.stringify(e))}function L(e,t){let{viewport:n}=(0,u.ZP)(e),i=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:i}}function x(e,t){var n,i;return{page:Z(e.page,t.page),client:Z(e.client,t.client),canvas:Z(e.canvas,t.canvas),world:(n=e.world,i=t.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])}}function Z(e,t){return[e[0]-t[0],e[1]-t[1]]}function U(e){w.ignoreDoubleClick?(w.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):A()}var k=function(e){if(w.doubleClickTimeout){if(e.buttons===w.mouseDownEvent.buttons)return;w.mouseDownEvent=e,M();return}w.doubleClickTimeout=setTimeout(M,1===e.buttons?400:150),w.mouseDownEvent=e,w.ignoreDoubleClick=!1,I.element=e.currentTarget,I.mouseButton=e.buttons;let t=(0,u.ZP)(I.element),{renderingEngineId:n,viewportId:i}=t;I.renderingEngineId=n,I.viewportId=i,I.preventClickTimeout=setTimeout(y,I.clickDelay),I.element.removeEventListener("mousemove",m);let a=h(e,I.element);I.startPoints=N(a),I.lastPoints=N(a),document.addEventListener("mouseup",S),document.addEventListener("mousemove",b)};function R(e){e.removeEventListener("dblclick",f),e.removeEventListener("mousedown",k),e.removeEventListener("mousemove",m),e.removeEventListener("dblclick",U,{capture:!0})}var V={enable:function(e){R(e),e.addEventListener("dblclick",f),e.addEventListener("mousedown",k),e.addEventListener("mousemove",m),e.addEventListener("dblclick",U,{capture:!0})},disable:R},H=function(e){let t,n,i,a;let o=e.currentTarget,r=(0,u.ZP)(o),{renderingEngineId:l,viewportId:s}=r;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();let{spinX:f,spinY:g,pixelX:m,pixelY:v}=(t=0,n=0,i=0,a=0,"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),i=10*t,a=10*n,"deltaY"in e&&(a=e.deltaY),"deltaX"in e&&(i=e.deltaX),(i||a)&&e.deltaMode&&(1===e.deltaMode?(i*=40,a*=40):(i*=800,a*=800)),i&&!t&&(t=i<1?-1:1),a&&!n&&(n=a<1?-1:1),{spinX:t,spinY:n,pixelX:i,pixelY:a}),p=g<0?-1:1,C={event:e,eventName:d.default.MOUSE_WHEEL,renderingEngineId:l,viewportId:s,element:o,camera:{},detail:e,wheel:{spinX:f,spinY:g,pixelX:m,pixelY:v,direction:p},points:h(e)};(0,c.Z)(o,d.default.MOUSE_WHEEL,C)};function G(e){e.removeEventListener("wheel",H)}var W={enable:function(e){G(e),e.addEventListener("wheel",H,{passive:!1})},disable:G};let B={mouse:0,touch:1};function F(e,t){let n=Date.now();if(e!==i){if(n-a<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;i=e}a=n}let $=F.bind(null,B.mouse),q=F.bind(null,B.touch);function j(e,t,n){let i=n?$:q;t.forEach(function(t){e.addEventListener(t,i,{passive:!1})})}function z(e,t,n){let i=n?$:q;t.forEach(function(t){e.removeEventListener(t,i)})}let K=["mousedown","mouseup","mousemove"],Y=["touchstart","touchend"];function X(e){z(e,K,B.mouse),z(e,Y,B.touch)}var J={enable:function(e){X(e),j(e,K,B.mouse),j(e,Y,B.touch)},disable:X},Q=n(37062);function ee(e,t){let n=t||e.currentTarget,i="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(i).map(e=>{var t,a;let o=[(t=i[e]).clientX,t.clientY],r=[(a=i[e]).pageX,a.pageY],l=function(e,t){let n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,r),{viewport:s}=(0,u.ZP)(n),d=s.canvasToWorld(l);return{page:r,client:o,canvas:l,world:d,touch:{identifier:e,radiusX:i[e].radiusX,radiusY:i[e].radiusY,force:i[e].force,rotationAngle:i[e].rotationAngle}}})}var et=n(40833),en=n(78530);let ei=en.Z.getRuntimeSettings(),{TOUCH_START:ea,TOUCH_START_ACTIVATE:eo,TOUCH_PRESS:er,TOUCH_DRAG:el,TOUCH_END:es,TOUCH_TAP:ed,TOUCH_SWIPE:eu}=d.default,ec={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},eh={page:0,client:0,canvas:0,world:0},ef={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...ec,touch:null}],lastPointsList:[{...ec,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:eh,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},eg={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...ec,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300},em=JSON.parse(JSON.stringify(ef)),ev=JSON.parse(JSON.stringify(eg));function ep(e,t,n){return ei.get("debug")&&("CORNERSTONE_TOOLS_TOUCH_DRAG"===t?console.debug(t):console.debug(t,n)),(0,c.Z)(e,t,n)}function eC(e){let t=ee(e,em.element),n=e_(em.element,em.lastPointsList),i=t.length===n.length?(0,et.getDeltaPoints)(t,n):ec,a=t.length===n.length?(0,et.getDeltaDistanceBetweenIPoints)(t,n):eh,o=t.length===n.length?(0,et.getDeltaDistance)(t,em.lastPointsList):eh;em.accumulatedDistance={page:em.accumulatedDistance.page+o.page,client:em.accumulatedDistance.client+o.client,canvas:em.accumulatedDistance.canvas+o.canvas,world:em.accumulatedDistance.world+o.world};let r={event:e,eventName:el,renderingEngineId:em.renderingEngineId,viewportId:em.viewportId,camera:{},element:em.element,startPoints:(0,et.getMeanTouchPoints)(em.startPointsList),lastPoints:(0,et.getMeanTouchPoints)(n),currentPoints:(0,et.getMeanTouchPoints)(t),startPointsList:(0,et.copyPointsList)(em.startPointsList),lastPointsList:(0,et.copyPointsList)(n),currentPointsList:t,deltaPoints:i,deltaDistance:a};ep(em.element,el,r),function(e,t){let n=new Date().getTime(),i=em.startTime.getTime();if(em.swiped||n-i>em.swipeToleranceMs)return;let[a,o]=t.canvas,r={event:e,eventName:eu,renderingEngineId:em.renderingEngineId,viewportId:em.viewportId,camera:{},element:em.element,swipe:null};Math.abs(a)>em.swipeDistanceThreshold&&(r.swipe=a>0?Q.o.RIGHT:Q.o.LEFT,ep(r.element,eu,r),em.swiped=!0),Math.abs(o)>em.swipeDistanceThreshold&&(r.swipe=o>0?Q.o.DOWN:Q.o.UP,ep(r.element,eu,r),em.swiped=!0)}(e,i),em.lastPointsList=(0,et.copyPointsList)(t)}function eE(e){clearTimeout(em.pressTimeout);let t=ee(e,em.element),n=e_(em.element,em.lastPointsList),i=t.length===n.length?(0,et.getDeltaPoints)(t,n):(0,et.getDeltaPoints)(t,t),a=t.length===n.length?(0,et.getDeltaDistanceBetweenIPoints)(t,n):(0,et.getDeltaDistanceBetweenIPoints)(t,t),o={event:e,eventName:es,element:em.element,renderingEngineId:em.renderingEngineId,viewportId:em.viewportId,camera:{},startPointsList:(0,et.copyPointsList)(em.startPointsList),lastPointsList:(0,et.copyPointsList)(n),currentPointsList:t,startPoints:(0,et.getMeanTouchPoints)(em.startPointsList),lastPoints:(0,et.getMeanTouchPoints)(n),currentPoints:(0,et.getMeanTouchPoints)(t),deltaPoints:i,deltaDistance:a};ep(o.element,es,o),function(e){let t=new Date().getTime(),n=em.startTime.getTime();if(t-n>ev.tapToleranceMs||(0===ev.taps&&(ev.element=em.element,ev.renderingEngineId=em.renderingEngineId,ev.viewportId=em.viewportId,ev.startPointsList=em.startPointsList),ev.taps>0&&!(ev.element==em.element&&ev.renderingEngineId==em.renderingEngineId&&ev.viewportId==em.viewportId)))return;let i=ee(e,ev.element),a=(0,et.getDeltaDistance)(i,ev.startPointsList).canvas;a>ev.tapMaxDistance||(clearTimeout(ev.tapTimeout),ev.taps+=1,ev.tapTimeout=setTimeout(()=>{let t={event:e,eventName:ed,element:ev.element,renderingEngineId:ev.renderingEngineId,viewportId:ev.viewportId,camera:{},currentPointsList:i,currentPoints:(0,et.getMeanTouchPoints)(i),taps:ev.taps};ep(t.element,ed,t),ev=JSON.parse(JSON.stringify(eg))},ev.tapToleranceMs))}(e),em=JSON.parse(JSON.stringify(ef)),document.removeEventListener("touchmove",eC),document.removeEventListener("touchend",eE)}function e_(e,t){let{viewport:n}=(0,u.ZP)(e);return t.map(e=>{let t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}})}var eT=function(e){em.element=e.currentTarget;let t=(0,u.ZP)(em.element),{renderingEngineId:n,viewportId:i}=t;em.renderingEngineId=n,em.viewportId=i,em.isTouchStart||(clearTimeout(em.pressTimeout),em.pressTimeout=setTimeout(()=>(function(e){let t=em.accumulatedDistance.canvas;if(t>em.pressMaxDistance)return;let n={event:e,eventName:er,renderingEngineId:em.renderingEngineId,viewportId:em.viewportId,camera:{},element:em.element,startPointsList:(0,et.copyPointsList)(em.startPointsList),lastPointsList:(0,et.copyPointsList)(em.lastPointsList),startPoints:(0,et.copyPoints)((0,et.getMeanTouchPoints)(em.startPointsList)),lastPoints:(0,et.copyPoints)((0,et.getMeanTouchPoints)(em.lastPointsList))};ep(n.element,er,n)})(e),em.pressDelay),function(e){em.isTouchStart=!0,em.startTime=new Date;let t=ee(e,em.element),n=(0,et.getMeanTouchPoints)(t),i={event:e,eventName:ea,element:em.element,renderingEngineId:em.renderingEngineId,viewportId:em.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:ec,deltaDistance:eh};em.startPointsList=(0,et.copyPointsList)(i.startPointsList),em.lastPointsList=(0,et.copyPointsList)(i.lastPointsList);let a=ep(i.element,ea,i);a&&ep(i.element,eo,i)}(e),document.addEventListener("touchmove",eC),document.addEventListener("touchend",eE))};function eI(e){J.disable(e),e.removeEventListener("touchstart",eT)}var ew={enable:function(e){eI(e),J.enable(e),e.addEventListener("touchstart",eT,{passive:!1})},disable:eI},eb=n(83465),eS=n.n(eb);let eD={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null},eO={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function ey(e){eO.element=e.currentTarget;let t=(0,u.ZP)(eO.element),{renderingEngineId:n,viewportId:i}=t;eO.renderingEngineId=n,eO.viewportId=i,eO.key=e.key,eO.keyCode=e.keyCode,e.preventDefault();let a={renderingEngineId:eO.renderingEngineId,viewportId:eO.viewportId,element:eO.element,key:eO.key,keyCode:eO.keyCode};(0,c.Z)(a.element,d.default.KEY_DOWN,a),document.addEventListener("keyup",eM),eO.element.removeEventListener("keydown",ey)}function eM(e){let t={renderingEngineId:eO.renderingEngineId,viewportId:eO.viewportId,element:eO.element,key:eO.key,keyCode:eO.keyCode};document.removeEventListener("keyup",eM),eO.element.addEventListener("keydown",ey),eO=eS()(eD),(0,c.Z)(t.element,d.default.KEY_UP,t)}function eP(e){e.removeEventListener("keydown",ey)}var eA={enable:function(e){eP(e),e.addEventListener("keydown",ey)},disable:eP,getModifierKey:function(){return eO.keyCode}},eN=n(94268);let eL=function(e){(0,eN.ZP)(e.detail.element)};var ex={enable:function(e){e.addEventListener(o.default.IMAGE_RENDERED,eL)},disable:function(e){e.removeEventListener(o.default.IMAGE_RENDERED,eL)}},eZ=n(43286),eU=n(3971);function ek(e,t,n){let{renderingEngineId:i,viewportId:a}=e.detail,o=eU.Z(a,i);if(!o)return[];let r=[],l=Object.keys(o.toolOptions);for(let e=0;e<l.length;e++){let i=l[e],a=o.toolOptions[i],s=null!=n&&a.bindings.length&&a.bindings.some(e=>e.mouseButton===n);if(t.includes(a.mode)&&(!n||s)){let e=o.getToolInstance(i);r.push(e)}}return r}let{Active:eR,Passive:eV,Enabled:eH}=eZ.default,eG=function(e){let t=ek(e,[eR,eV,eH]);t.forEach(t=>{t.onCameraModified&&t.onCameraModified(e)})};var eW={enable:function(e){e.addEventListener(o.default.CAMERA_MODIFIED,eG)},disable:function(e){e.removeEventListener(o.default.CAMERA_MODIFIED,eG)}};let{Active:eB,Passive:eF,Enabled:e$}=eZ.default,eq=function(e){let t=ek(e,[eB,eF,e$]);t.forEach(t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)})};var ej={enable:function(e){e.addEventListener(o.default.IMAGE_SPACING_CALIBRATED,eq)},disable:function(e){e.removeEventListener(o.default.IMAGE_SPACING_CALIBRATED,eq)}},ez=n(84725);let{Active:eK}=eZ.default;function eY(e,t,n){let i;if(ez.ZP.isInteractingWithTool)return!1;let{renderingEngineId:a,viewportId:o}=n.detail,r=eU.Z(o,a);if(!r)return!1;let l=Object.keys(r.toolOptions);for(let e=0;e<l.length;e++){let n=l[e],a=r.toolOptions[n],o=r.getToolInstance(n);if(a.mode===eK&&"function"==typeof o[t]){i=r.getToolInstance(n);break}}i&&i[t](n)}let eX=eY.bind(null,"Mouse","mouseClickCallback");var eJ=n(43348),eQ=n(68207),e0=n(60993);function e1(e,t,n,i="mouse"){let a="touch"===i?36:6,o=[];return t.forEach(({tool:t,annotations:i})=>{for(let r of i){if(r.isLocked||!r.isVisible)continue;let i=t.getHandleNearImagePoint(e,r,n,a);if(i){o.push({tool:t,annotation:r,handle:i});break}}}),o}var e2=n(14507);function e5(e,t,n,i="mouse"){let a="touch"===i?36:6,o=[];return t.forEach(({tool:t,annotations:r})=>{for(let l of r){if(l.isLocked||!l.isVisible)continue;let r=t.isPointNearTool(e,l,n,a,i);if(r){o.push({tool:t,annotation:l});break}}}),o}var e3=n(14358),e4=e=>e.shiftKey?e.ctrlKey?e3.y.ShiftCtrl:e.altKey?e3.y.ShiftAlt:e.metaKey?e3.y.ShiftMeta:e3.y.Shift:e.ctrlKey?e.altKey?e3.y.CtrlAlt:e.metaKey?e3.y.CtrlMeta:e3.y.Ctrl:e.altKey?e.metaKey&&e3.y.AltMeta||e3.y.Alt:e.metaKey?e3.y.Meta:void 0;let{Active:e8}=eZ.default;function e9(e){let{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,a=e4(i)||eA.getModifierKey(),o=eU.Z(n,t);if(!o)return null;let r=Object.keys(o.toolOptions),l=o.getDefaultMousePrimary();for(let e=0;e<r.length;e++){let t=r[e],n=o.toolOptions[t],s=n.bindings.length&&n.bindings.some(e=>e.mouseButton===(i?i.buttons:l)&&e.modifierKey===a);if(n.mode===e8&&s)return o.getToolInstance(t)}}let{Active:e7,Passive:e6}=eZ.default;function te(e){if(ez.ZP.isInteractingWithTool)return;let t=e9(e);if(t&&"function"==typeof t.preMouseDownCallback){let n=t.preMouseDownCallback(e);if(n)return}let n=1===e.detail.event.buttons,i=ek(e,[e7],e.detail.event.buttons),a=n?ek(e,[e6]):void 0,o=[...i||[],...a||[]],r=e.detail,{element:l}=r,s=(0,e2.Z)(l,o),d=r.currentPoints.canvas,u=e1(l,s,d,"mouse"),c=!!e.detail.event.shiftKey;if(u.length>0){let{tool:t,annotation:n,handle:i}=tt(u);tn(n.annotationUID,c),t.handleSelectedCallback(e,n,i,"Mouse");return}let h=e5(l,s,d,"mouse");if(h.length>0){let{tool:t,annotation:n}=tt(h);tn(n.annotationUID,c),t.toolSelectedCallback(e,n,"Mouse");return}if(t&&"function"==typeof t.postMouseDownCallback){let n=t.postMouseDownCallback(e);if(n)return}}function tt(e){return e.length>1&&e.find(e=>!(0,eQ.isAnnotationLocked)(e.annotation)&&(0,e0.isAnnotationVisible)(e.annotation.annotationUID))||e[0]}function tn(e,t=!1){t?(0,eJ.isAnnotationSelected)(e)?(0,eJ.setAnnotationSelected)(e,!1):(0,eJ.setAnnotationSelected)(e,!0,!0):(0,eJ.setAnnotationSelected)(e,!0,!1)}function ti(e){if(ez.ZP.isInteractingWithTool)return;let t=e9(e);if(t&&!ez.ZP.isMultiPartToolActive&&t.addNewAnnotation){let n=t.addNewAnnotation(e,"mouse");(0,eJ.setAnnotationSelected)(n.annotationUID)}}let ta=eY.bind(null,"Mouse","doubleClickCallback");function to(e){if(ez.ZP.isInteractingWithTool)return;let t=e9(e),n=!t||"function"!=typeof t.mouseDragCallback;n||t.mouseDragCallback(e)}let{Active:tr,Passive:tl}=eZ.default;function ts(e){if(ez.ZP.isInteractingWithTool||ez.ZP.isMultiPartToolActive)return;let t=ek(e,[tr,tl]),n=e.detail,{element:i}=n,a=(0,e2.Z)(i,t),o=t.filter(e=>{let t=!a.some(t=>t.tool.getToolName()===e.getToolName());return t}),r=!1;for(let{tool:t,annotations:n}of a)"function"==typeof t.mouseMoveCallback&&(r=t.mouseMoveCallback(e,n)||r);o.forEach(t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)}),!0===r&&(0,eN.ZP)(i)}let td=eY.bind(null,"Mouse","mouseUpCallback"),tu=eY.bind(null,"MouseWheel","mouseWheelCallback");var tc={enable:function(e){e.addEventListener(d.default.MOUSE_CLICK,eX),e.addEventListener(d.default.MOUSE_DOWN,te),e.addEventListener(d.default.MOUSE_DOWN_ACTIVATE,ti),e.addEventListener(d.default.MOUSE_DOUBLE_CLICK,ta),e.addEventListener(d.default.MOUSE_DRAG,to),e.addEventListener(d.default.MOUSE_MOVE,ts),e.addEventListener(d.default.MOUSE_UP,td),e.addEventListener(d.default.MOUSE_WHEEL,tu)},disable:function(e){e.removeEventListener(d.default.MOUSE_CLICK,eX),e.removeEventListener(d.default.MOUSE_DOWN,te),e.removeEventListener(d.default.MOUSE_DOWN_ACTIVATE,ti),e.removeEventListener(d.default.MOUSE_DOUBLE_CLICK,ta),e.removeEventListener(d.default.MOUSE_DRAG,to),e.removeEventListener(d.default.MOUSE_MOVE,ts),e.removeEventListener(d.default.MOUSE_UP,td),e.removeEventListener(d.default.MOUSE_WHEEL,tu)}};let{Active:th}=eZ.default;function tf(e){let{renderingEngineId:t,viewportId:n}=e.detail,i=I.mouseButton,a=eA.getModifierKey(),o=eU.Z(n,t);if(!o)return null;let r=Object.keys(o.toolOptions),l=o.getDefaultMousePrimary();for(let e=0;e<r.length;e++){let t=r[e],n=o.toolOptions[t],s=n.bindings.length&&n.bindings.some(e=>e.mouseButton===(i??l)&&e.modifierKey===a);if(n.mode===th&&s)return o.getToolInstance(t)}}function tg(e){let t=tf(e);if(!t)return;let{renderingEngineId:n,viewportId:i}=e.detail,a=eU.Z(i,n),o=t.getToolName();Object.keys(a.toolOptions).includes(o)&&a.setViewportsCursorByToolName(o)}function tm(e){let t=tf(e);if(!t)return;let{renderingEngineId:n,viewportId:i}=e.detail,a=eU.Z(i,n);eO.keyCode=void 0;let o=t.getToolName();Object.keys(a.toolOptions).includes(o)&&a.setViewportsCursorByToolName(o)}var tv={enable:function(e){e.addEventListener(d.default.KEY_DOWN,tg),e.addEventListener(d.default.KEY_UP,tm)},disable:function(e){e.removeEventListener(d.default.KEY_DOWN,tg),e.removeEventListener(d.default.KEY_UP,tm)}};let{Active:tp}=eZ.default;function tC(e){let{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,a=eU.Z(n,t);if(!a)return null;let o=Object.keys(a.toolOptions),r=Object.keys(i.touches).length,l=e4(i)||eA.getModifierKey(),s=a.getDefaultMousePrimary();for(let e=0;e<o.length;e++){let t=o[e],n=a.toolOptions[t],i=n.bindings.length&&n.bindings.some(e=>(e.numTouchPoints===r||1===r&&e.mouseButton===s)&&e.modifierKey===l);if(n.mode===tp&&i)return a.getToolInstance(t)}}function tE(e,t,n){let{renderingEngineId:i,viewportId:a}=e.detail,o=eU.Z(a,i);if(!o)return[];let r=[],l=Object.keys(o.toolOptions);for(let e=0;e<l.length;e++){let i=l[e],a=o.toolOptions[i],s=null!=n&&a.bindings.length&&a.bindings.some(e=>e.numTouchPoints===n);if(t.includes(a.mode)&&(!n||s)){let e=o.getToolInstance(i);r.push(e)}}return r}let{Active:t_,Passive:tT}=eZ.default;function tI(e){if(ez.ZP.isInteractingWithTool)return;let t=tC(e);if(t&&"function"==typeof t.preTouchStartCallback){let n=t.preTouchStartCallback(e);if(n)return}let n=1===Object.keys(e.detail.event.touches).length,i=tE(e,[t_],Object.keys(e.detail.event.touches).length),a=n?tE(e,[tT]):void 0,o=[...i||[],...a||[],t],r=e.detail,{element:l}=r,s=(0,e2.Z)(l,o),d=r.currentPoints.canvas,u=e1(l,s,d,"touch");if(u.length>0){let{tool:t,annotation:n,handle:i}=tw(u);tb(n.annotationUID,!1),t.handleSelectedCallback(e,n,i,"Touch");return}let c=e5(l,s,d,"touch");if(c.length>0){let{tool:t,annotation:n}=tw(c);tb(n.annotationUID,!1),t.toolSelectedCallback(e,n,"Touch");return}if(t&&"function"==typeof t.postTouchStartCallback){let n=t.postTouchStartCallback(e);if(n)return}}function tw(e){return e.length>1&&e.find(e=>!(0,eQ.isAnnotationLocked)(e.annotation)&&(0,e0.isAnnotationVisible)(e.annotation.annotationUID))||e[0]}function tb(e,t=!1){t?(0,eJ.isAnnotationSelected)(e)?(0,eJ.setAnnotationSelected)(e,!1):(0,eJ.setAnnotationSelected)(e,!0,!0):(0,eJ.setAnnotationSelected)(e,!0,!1)}function tS(e){if(ez.ZP.isInteractingWithTool)return;let t=tC(e);if(t&&!ez.ZP.isMultiPartToolActive&&t.addNewAnnotation){let n=t.addNewAnnotation(e,"touch");(0,eJ.setAnnotationSelected)(n.annotationUID)}}function tD(e){if(ez.ZP.isInteractingWithTool)return;let t=tC(e),n=!t||"function"!=typeof t.touchDragCallback;n||t.touchDragCallback(e)}let tO=eY.bind(null,"Touch","touchEndCallback"),ty=eY.bind(null,"Touch","touchTapCallback"),tM=eY.bind(null,"Touch","touchPressCallback");var tP={enable:function(e){e.addEventListener(d.default.TOUCH_START,tI),e.addEventListener(d.default.TOUCH_START_ACTIVATE,tS),e.addEventListener(d.default.TOUCH_DRAG,tD),e.addEventListener(d.default.TOUCH_END,tO),e.addEventListener(d.default.TOUCH_TAP,ty),e.addEventListener(d.default.TOUCH_PRESS,tM)},disable:function(e){e.removeEventListener(d.default.TOUCH_START,tI),e.removeEventListener(d.default.TOUCH_START_ACTIVATE,tS),e.removeEventListener(d.default.TOUCH_DRAG,tD),e.removeEventListener(d.default.TOUCH_END,tO),e.removeEventListener(d.default.TOUCH_PRESS,tM)}};function tA(e){let{element:t,viewportId:n}=e.detail,i=function(e){let t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";let a=document.createElementNS(t,"defs"),o=document.createElementNS(t,"filter"),r=document.createElementNS(t,"feOffset"),l=document.createElementNS(t,"feColorMatrix"),s=document.createElementNS(t,"feBlend");return o.setAttribute("id",`shadow-${i}`),o.setAttribute("filterUnits","userSpaceOnUse"),r.setAttribute("result","offOut"),r.setAttribute("in","SourceGraphic"),r.setAttribute("dx","0.5"),r.setAttribute("dy","0.5"),l.setAttribute("result","matrixOut"),l.setAttribute("in","offOut"),l.setAttribute("in2","matrix"),l.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),s.setAttribute("in","SourceGraphic"),s.setAttribute("in2","matrixOut"),s.setAttribute("mode","normal"),o.appendChild(r),o.appendChild(l),o.appendChild(s),a.appendChild(o),n.appendChild(a),n}(n);(function(e){let{viewportUid:t,renderingEngineUid:n}=e.dataset,i=`${t}:${n}`;ez.SB.svgNodeCache[i]={}})(t),function(e,t){t.querySelector("div.viewport-element").appendChild(e)}(i,t),eN.Ar.addViewportElement(n,t),V.enable(t),W.enable(t),ew.enable(t),eA.enable(t),ex.enable(t),eW.enable(t),ej.enable(t),tc.enable(t),tv.enable(t),tP.enable(t),ez.SB.enabledElements.push(t)}var tN=n(6645);let tL=e=>{let t=(0,u.ZP)(e),n=(0,tN.Z)(t.viewportId,t.renderingEngineId);n.forEach(e=>{e.remove(t)})},tx=e=>{let{renderingEngineId:t,viewportId:n}=(0,u.ZP)(e),i=(0,eU.Z)(n,t);i&&i.removeViewports(t,n)},tZ=function(e){let t=ez.SB.enabledElements.findIndex(t=>t===e);t>-1&&ez.SB.enabledElements.splice(t,1)};var tU=function(e){let{element:t,viewportId:n}=e.detail;(function(e){let{viewportUid:t,renderingEngineUid:n}=e.dataset,i=`${t}:${n}`;delete ez.SB.svgNodeCache[i]})(t),function(e){let t=e.querySelector("div.viewport-element"),n=t.querySelector("svg");n&&t.removeChild(n)}(t),eN.Ar.removeViewportElement(n,t),V.disable(t),W.disable(t),ew.disable(t),eA.disable(t),ex.disable(t),eW.disable(t),ej.disable(t),tc.disable(t),tv.disable(t),tP.disable(t),tL(t),tx(t),tZ(t)},tk=n(6606),tR=n(76056),tV=function(e){let{viewportId:t,renderingEngineId:n}=e.detail,i=(0,tk.Pr)(n);(0,tR.Z)(i,[t])},tH=function(e){let t=e.detail.removed;if(!t.length)return;let n=(0,tk.Uu)();n.forEach(e=>{let t=e.getViewports(),n=t.map(e=>e.id);(0,tR.Z)(e,n)})},tG=n(49936),tW=function(e){let{segmentationId:t}=e.detail,n=(0,s.getToolGroupIdsWithSegmentation)(t);n.forEach(e=>{let n=(0,s.getSegmentationRepresentations)(e);n.forEach(n=>{n.segmentationId===t&&(0,tG.triggerSegmentationRepresentationModified)(e,n.segmentationRepresentationUID)})})},tB=n(82864),tF=n(30946),t$=n(20579),tq=function(e){let t;let{segmentationId:n,modifiedSlicesToUse:i}=e.detail,{representationData:a,type:o}=s.getSegmentation(n);if(o===t$.Z.Labelmap){let e;let r=tB.ZP.getVolume(a[o].volumeId);if(!r){console.warn("segmentation not found in cache");return}let{imageData:l,vtkOpenGLTexture:d}=r;if(i&&Array.isArray(i))e=i;else{let t=l.getDimensions()[2];e=[...Array(t).keys()]}e.forEach(e=>{d.setUpdatedFrame(e)}),l.modified(),t=s.getToolGroupIdsWithSegmentation(n)}else throw Error(`onSegmentationDataModified: representationType ${o} not supported yet`);t.forEach(e=>{(0,tF.ZP)(e)})},tj=function(e){let{toolGroupId:t}=e.detail;(0,tF.ZP)(t)},tz=function(e){let{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;(0,tF.ZP)(t)},tK=n(21465);let tY=!1;function tX(e={}){tY||(function(){tQ();let e=o.default.ELEMENT_ENABLED,t=o.default.ELEMENT_DISABLED;r.Z.addEventListener(e,tA),r.Z.addEventListener(t,tU)}(),t0(),r.Z.addEventListener(d.default.ANNOTATION_MODIFIED,tV),r.Z.addEventListener(d.default.ANNOTATION_SELECTION_CHANGE,tH),r.Z.addEventListener(d.default.ANNOTATION_SELECTION_CHANGE,tH),r.Z.addEventListener(d.default.SEGMENTATION_MODIFIED,tW),r.Z.addEventListener(d.default.SEGMENTATION_DATA_MODIFIED,tq),r.Z.addEventListener(d.default.SEGMENTATION_REPRESENTATION_MODIFIED,tj),r.Z.addEventListener(d.default.SEGMENTATION_REPRESENTATION_REMOVED,tz),tY=!0)}function tJ(){tQ(),t0(),tK.Z(),(0,ez.zV)();let e=(0,l.getAnnotationManager)(),t=(0,s.getDefaultSegmentationStateManager)();e.restoreAnnotations({}),t.resetState(),tY=!1}function tQ(){let e=o.default.ELEMENT_ENABLED,t=o.default.ELEMENT_DISABLED;r.Z.removeEventListener(e,tA),r.Z.removeEventListener(t,tU)}function t0(){r.Z.removeEventListener(d.default.ANNOTATION_MODIFIED,tV),r.Z.removeEventListener(d.default.ANNOTATION_SELECTION_CHANGE,tH),r.Z.removeEventListener(d.default.ANNOTATION_SELECTION_CHANGE,tH),r.Z.removeEventListener(d.default.SEGMENTATION_MODIFIED,tW),r.Z.removeEventListener(d.default.SEGMENTATION_DATA_MODIFIED,tq),r.Z.removeEventListener(d.default.SEGMENTATION_REPRESENTATION_MODIFIED,tj),r.Z.removeEventListener(d.default.SEGMENTATION_REPRESENTATION_REMOVED,tz)}},87885:function(e,t,n){"use strict";n.d(t,{o:function(){return h}});var i=n(83465),a=n.n(i),o=n(28186),r=n(57024),l=n(74880),s=n(39040),d=n(68207),u=n(60993);class c{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;let t=(0,o.ZP)(e);if(!t)throw Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return t.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{let t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach(e=>{let t=i[e];t.forEach(e=>{let t=e.invalidated;void 0!==t&&(e.invalidated=!0)})})},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{let n=this.annotations;return n[e]?t?n[e][t]:n[e]:[]},this.getAnnotation=e=>{let t=this.annotations;for(let n in t){let i=t[n];for(let t in i){let n=i[t];for(let t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{let n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(let e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{let{metadata:n}=e,{FrameOfReferenceUID:i,toolName:a}=n;t=t||i;let o=this.annotations,r=o[t];r||(o[t]={},r=o[t]);let l=r[a];l||(r[a]=[],l=r[a]),l.push(e),(0,d.checkAndDefineIsLockedProperty)(e),(0,u.checkAndDefineIsVisibleProperty)(e)},this.removeAnnotation=e=>{let{annotations:t}=this;for(let n in t){let i=t[n];for(let t in i){let n=i[t],a=n.findIndex(t=>t.annotationUID===e);-1!==a&&(n.splice(a,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{let n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{let n=this.annotations;if(e&&t){let i=n[e];if(!i)return;let o=i[t];return a()(o)}if(e){let t=n[e];return a()(t)}return a()(n)},this.restoreAnnotations=(e,t,n)=>{let i=this.annotations;if(t&&n){let a=i[t];a||(i[t]={},a=i[t]),a[n]=e}else t?i[t]=e:this.annotations=a()(e)},this.getNumberOfAllAnnotations=()=>{let e=0,t=this.annotations;for(let n in t){let i=t[n];for(let t in i){let n=i[t];e+=n.length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=r.Z()),this.annotations={},this.uid=e,l.Z.addEventListener(s.default.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}let h=new c("DEFAULT");t.Z=c},68207:function(e,t,n){"use strict";n.r(t),n.d(t,{checkAndDefineIsLockedProperty:function(){return h},getAnnotationsLocked:function(){return d},getAnnotationsLockedCount:function(){return c},isAnnotationLocked:function(){return u},setAnnotationLocked:function(){return l},unlockAllAnnotations:function(){return s}});var i=n(818),a=n(74880),o=n(11130);let r=new Set;function l(e,t=!0){let n=f();e&&(t?r.has(e)||(r.add(e),n.added.push(e)):g(e,r,n)),m(n,r)}function s(){let e=f();(function(e,t){e.forEach(n=>{g(n,e,t)})})(r,e),m(e,r)}function d(){return Array.from(r)}function u(e){return r.has(e)}function c(){return r.size}function h(e){if(e){let t=!!e.isLocked;(function(e){let t=Object.getOwnPropertyDescriptor(e,"isLocked");return t?t.configurable&&(t.set!==v||t.get!==p):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:v,get:p}),l(e,t)}}function f(){return Object.freeze({added:[],removed:[],locked:[]})}function g(e,t,n){t.delete(e)&&n.removed.push(e)}function m(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>void e.locked.push(t)),(0,i.Z)(a.Z,o.default.ANNOTATION_LOCK_CHANGE,e))}function v(e){l(this,e)}function p(){return u(this)}},43348:function(e,t,n){"use strict";n.r(t),n.d(t,{deselectAnnotation:function(){return d},getAnnotationsSelected:function(){return u},getAnnotationsSelectedByToolName:function(){return c},getAnnotationsSelectedCount:function(){return f},isAnnotationSelected:function(){return h},setAnnotationSelected:function(){return s}});var i=n(818),a=n(74880),o=n(11130),r=n(53323);let l=new Set;function s(e,t=!0,n=!1){t?function(e,t=!1){let n=g();t||m(l,n),e&&!l.has(e)&&(l.add(e),n.added.push(e)),v(n,l)}(e,n):d(e)}function d(e){let t=g();e?l.delete(e)&&t.removed.push(e):m(l,t),v(t,l)}function u(){return Array.from(l)}function c(e){return u().filter(t=>{let n=(0,r.getAnnotation)(t);return n.metadata.toolName===e})}function h(e){return l.has(e)}function f(){return l.size}function g(){return Object.freeze({added:[],removed:[],selection:[]})}function m(e,t){e.forEach(n=>{e.delete(n)&&t.removed.push(n)})}function v(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>void e.selection.push(t)),(0,i.Z)(a.Z,o.default.ANNOTATION_SELECTION_CHANGE,e))}},53323:function(e,t,n){"use strict";n.r(t),n.d(t,{addAnnotation:function(){return m},getAnnotation:function(){return C},getAnnotationManager:function(){return c},getAnnotations:function(){return g},getNumberOfAnnotations:function(){return v},removeAllAnnotations:function(){return E},removeAnnotation:function(){return p},resetAnnotationManager:function(){return f},setAnnotationManager:function(){return h}});var i=n(57024),a=n(818),o=n(74880),r=n(11130),l=n(87885),s=n(28186),d=n(96502);let u=l.o;function c(){return u}function h(e){u=e}function f(){u=l.o}function g(e,t){let n=u,i=n.getGroupKey(t);return n.getAnnotations(i,e)}function m(e,t){void 0===e.annotationUID&&(e.annotationUID=i.Z());let n=u,l=n.getGroupKey(t);return n.addAnnotation(e,l),t instanceof HTMLDivElement?function(e,t){let n=(0,s.ZP)(t),{renderingEngine:i,viewportId:l}=n,d=r.default.ANNOTATION_ADDED,u={annotation:e,viewportId:l,renderingEngineId:i.id};(0,a.Z)(o.Z,d,u)}(e,t):function(e){let{toolName:t}=e.metadata,n=(0,d.Z)(t);if(!n.length)return;let i=[];if(n.forEach(t=>{t.viewportsInfo.forEach(t=>{let{renderingEngineId:n,viewportId:a}=t,{FrameOfReferenceUID:o}=(0,s.O)(a,n);e.metadata.FrameOfReferenceUID===o&&i.push(t)})}),!i.length)return;let l=r.default.ANNOTATION_ADDED;i.forEach(({renderingEngineId:t,viewportId:n})=>{(0,a.Z)(o.Z,l,{annotation:e,viewportId:n,renderingEngineId:t})})}(e),e.annotationUID}function v(e,t){let n=u,i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function p(e){let t=u,n=t.getAnnotation(e);if(!n)return;t.removeAnnotation(e);let i=r.default.ANNOTATION_REMOVED,l={annotation:n,annotationManagerUID:t.uid};(0,a.Z)(o.Z,i,l)}function C(e){let t=u,n=t.getAnnotation(e);return n}function E(){let e=u;e.removeAllAnnotations()}},60993:function(e,t,n){"use strict";n.r(t),n.d(t,{checkAndDefineIsVisibleProperty:function(){return h},isAnnotationVisible:function(){return c},setAnnotationVisibility:function(){return d},showAllAnnotations:function(){return u}});var i=n(818),a=n(74880),o=n(53323),r=n(11130),l=n(43348);let s=new Set;function d(e,t=!0){let n=f();e&&(t?g(e,s,n):s.has(e)||(s.add(e),(0,l.isAnnotationSelected)(e)&&(0,l.deselectAnnotation)(e),n.lastHidden.push(e))),m(n)}function u(){let e=f();s.forEach(t=>{g(t,s,e)}),m(e)}function c(e){let t=(0,o.getAnnotation)(e);if(t)return!s.has(e)}function h(e){if(e){let t=e.isVisible??!0;(function(e){let t=Object.getOwnPropertyDescriptor(e,"isVisible");return t?t.configurable&&(t.set!==v||t.get!==p):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:v,get:p}),d(e.annotationUID,t)}}function f(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function g(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function m(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(s.forEach(t=>void e.hidden.push(t)),(0,i.Z)(a.Z,r.default.ANNOTATION_VISIBILITY_CHANGE,e))}function v(e){d(this.annotationUID,e)}function p(){return c(this.annotationUID)}},46990:function(e,t,n){"use strict";n.d(t,{Hi:function(){return a},K0:function(){return d},Pv:function(){return f},Qb:function(){return o},Wx:function(){return c},bH:function(){return h},eu:function(){return l},gN:function(){return r},gi:function(){return u},i:function(){return s}});var i=n(63008);function a(){return i.getGlobalConfig()}function o(e){i.setGlobalConfig(e)}function r(e){let t=a();return t.representations[e]}function l(e,t){let n=a();o({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function s(e){return i.getToolGroupSpecificConfig(e)}function d(e,t){i.setToolGroupSpecificConfig(e,t)}function u(e,t){return i.getSegmentationRepresentationSpecificConfig(e,t)}function c(e,t,n){i.setSegmentationRepresentationSpecificConfig(e,t,n)}function h(e,t,n){return i.getSegmentSpecificRepresentationConfig(e,t,n)}function f(e,t,n){i.setSegmentSpecificRepresentationConfig(e,t,n)}},70359:function(e,t,n){"use strict";n.r(t),n.d(t,{getSegmentationVisibility:function(){return s},setSegmentVisibility:function(){return u},setSegmentationVisibility:function(){return l},setSegmentsVisibility:function(){return d}});var i=n(82864),a=n(63008),o=n(49936),r=n(20579);function l(e,t,n){let l=(0,a.getSegmentationRepresentations)(e);if(!l)return;let s=l.find(e=>e.segmentationRepresentationUID===t);if(!s)return;let{segmentsHidden:d,segmentationId:u}=s,c=function(e){let t=a.getSegmentation(e);if(t.type===r.Z.Labelmap){let t=i.ZP.getVolume(e),n=t.getScalarData(),a={};for(let e=0;e<n.length;e++){let t=n[e];0===t||a[t]||(a[t]=!0)}return Object.keys(a).map(e=>parseInt(e,10))}if(t.type===r.Z.Contour){let n=t.representationData.CONTOUR?.geometryIds;if(!n)throw Error(`No geometryIds found for segmentationId ${e}`);return n.map(e=>{let t=i.ZP.getGeometry(e);return t.data.getSegmentIndex()})}}(u);n?d.clear():c.forEach(e=>{d.add(e)}),(0,o.triggerSegmentationRepresentationModified)(e,s.segmentationRepresentationUID)}function s(e,t){let n=(0,a.getSegmentationRepresentations)(e),i=n.find(e=>e.segmentationRepresentationUID===t);if(!i)return;let{segmentsHidden:o}=i;return 0===o.size}function d(e,t,n,i){let r=a.getSegmentationRepresentationByUID(e,t);r&&(n.forEach(e=>{i?r.segmentsHidden.delete(e):r.segmentsHidden.add(e)}),(0,o.triggerSegmentationRepresentationModified)(e,t))}function u(e,t,n,i){let r=a.getSegmentationRepresentationByUID(e,t);r&&(i?r.segmentsHidden.delete(n):r.segmentsHidden.add(n),(0,o.triggerSegmentationRepresentationModified)(e,t))}},15340:function(e,t,n){"use strict";var i=n(20579),a=n(32884),o=n(23165),r=n(63008);t.Z=function(e,t,n){let l=(0,r.getSegmentationRepresentations)(e);if(!l||0===l.length)return;let s=l.map(e=>e.segmentationRepresentationUID),d=t;if(d){let e=t.filter(e=>!s.includes(e));if(e.length>0)throw Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else d=s;d.forEach(t=>{!function(e,t,n){let l=(0,r.getSegmentationRepresentationByUID)(e,t),{type:s}=l;if(s===i.Z.Labelmap)a.Z.removeSegmentationRepresentation(e,t,n);else if(s===i.Z.Contour)o.Z.removeSegmentationRepresentation(e,t,n);else throw Error(`The representation ${s} is not supported yet`)}(e,t,n)})}},63008:function(e,t,n){"use strict";n.r(t),n.d(t,{addColorLUT:function(){return U},addSegmentation:function(){return C},addSegmentationRepresentation:function(){return y},getAllSegmentationRepresentations:function(){return _},getColorLUT:function(){return Z},getDefaultSegmentationStateManager:function(){return m},getGlobalConfig:function(){return M},getSegmentSpecificRepresentationConfig:function(){return D},getSegmentation:function(){return v},getSegmentationRepresentationByUID:function(){return A},getSegmentationRepresentationSpecificConfig:function(){return S},getSegmentationRepresentations:function(){return E},getSegmentations:function(){return p},getToolGroupIdsWithSegmentation:function(){return T},getToolGroupSpecificConfig:function(){return I},removeColorLUT:function(){return x},removeSegmentation:function(){return N},removeSegmentationRepresentation:function(){return L},setGlobalConfig:function(){return P},setSegmentSpecificRepresentationConfig:function(){return O},setSegmentationRepresentationSpecificConfig:function(){return b},setToolGroupSpecificConfig:function(){return w}});var i=n(57024),a=n(83465),o=n.n(a),r=n(88984),l=n(20579),s=n(14859);let d=(0,s.Z)(),u={renderInactiveSegmentations:!0,representations:{[l.Z.Labelmap]:d,[l.Z.Contour]:{renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0}}},c={colorLUT:[],segmentations:[],globalConfig:u,toolGroups:{}},h=new class{constructor(e){e||(e=i.Z()),this.state=o()(c),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}resetState(){this.state=o()(c)}getSegmentation(e){return this.state.segmentations.find(t=>t.segmentationId===e)}addSegmentation(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){let t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){let e={};return Object.entries(this.state.toolGroups).forEach(([t,n])=>{e[t]=n.segmentationRepresentations}),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){let n=this.getSegmentationRepresentations(e),i=n.find(e=>e.segmentationRepresentationUID===t);return i}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter(t=>t.segmentationId!==e)}removeSegmentationRepresentation(e,t){let n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw Error(`No viewport specific segmentation state found for viewport ${e}`);let i=n.findIndex(e=>e.segmentationRepresentationUID===t);-1===i&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);let a=n[i];n.splice(i,1),this._handleActiveSegmentation(e,a)}setActiveSegmentationRepresentation(e,t){let n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw Error(`No segmentation data found for toolGroupId: ${e}`);let i=n.find(e=>e.segmentationRepresentationUID===t);if(!i)throw Error(`No segmentation data found for segmentation data UID ${t}`);i.active=!0,this._handleActiveSegmentation(e,i)}getToolGroupSpecificConfig(e){let t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){let n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){let i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){let i=this.getSegmentationRepresentationByUID(e,t);if(i)return i.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n){let i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentSpecificConfig=n)}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){let n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length){n[0].active=!0;return}let i=n.filter(e=>e.active);if(0===i.length){n[0].active=!0;return}t.active&&n.forEach(e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})}_initDefaultColorLUTIfNecessary(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(r.Z,0)}}("DEFAULT");var f=n(49936),g=function(e){let{segmentationId:t,representation:n}=e;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...n.data}}}};function m(){return h}function v(e){return h.getSegmentation(e)}function p(){let e=h.getState();return e.segmentations}function C(e,t){let n=g(e);h.addSegmentation(n),t||(0,f.triggerSegmentationModified)(n.segmentationId)}function E(e){return h.getSegmentationRepresentations(e)}function _(){return h.getAllSegmentationRepresentations()}function T(e){if(!e)throw Error("getToolGroupIdsWithSegmentation: segmentationId is empty");let t=h.getState(),n=Object.keys(t.toolGroups),i=[];return n.forEach(t=>{let n=h.getSegmentationRepresentations(t);n.forEach(n=>{n.segmentationId===e&&i.push(t)})}),i}function I(e){return h.getToolGroupSpecificConfig(e)}function w(e,t,n){h.setSegmentationRepresentationConfig(e,t),n||(0,f.triggerSegmentationRepresentationModified)(e)}function b(e,t,n,i=!1){h.setSegmentationRepresentationSpecificConfig(e,t,n),i||(0,f.triggerSegmentationRepresentationModified)(e,t)}function S(e,t){return h.getSegmentationRepresentationSpecificConfig(e,t)}function D(e,t,n){return h.getSegmentSpecificConfig(e,t,n)}function O(e,t,n,i=!1){h.setSegmentSpecificConfig(e,t,n),i||(0,f.triggerSegmentationRepresentationModified)(e,t)}function y(e,t,n){h.addSegmentationRepresentation(e,t),n||(0,f.triggerSegmentationRepresentationModified)(e,t.segmentationRepresentationUID)}function M(){return h.getGlobalConfig()}function P(e,t){h.setGlobalConfig(e),t||(0,f.triggerSegmentationModified)()}function A(e,t){return h.getSegmentationRepresentationByUID(e,t)}function N(e){h.removeSegmentation(e),(0,f.triggerSegmentationRemoved)(e)}function L(e,t){h.removeSegmentationRepresentation(e,t),(0,f.triggerSegmentationRepresentationRemoved)(e,t)}function x(e){h.removeColorLUT(e)}function Z(e){return h.getColorLUT(e)}function U(e,t){h.addColorLUT(e,t)}},49936:function(e,t,n){"use strict";n.r(t),n.d(t,{triggerSegmentationDataModified:function(){return c},triggerSegmentationModified:function(){return u},triggerSegmentationRemoved:function(){return l},triggerSegmentationRepresentationModified:function(){return d},triggerSegmentationRepresentationRemoved:function(){return s}});var i=n(818),a=n(74880),o=n(11130),r=n(63008);function l(e){(0,i.Z)(a.Z,o.default.SEGMENTATION_REMOVED,{segmentationId:e})}function s(e,t){(0,i.Z)(a.Z,o.default.SEGMENTATION_REPRESENTATION_REMOVED,{toolGroupId:e,segmentationRepresentationUID:t})}function d(e,t){if(t){(0,i.Z)(a.Z,o.default.SEGMENTATION_REPRESENTATION_MODIFIED,{toolGroupId:e,segmentationRepresentationUID:t});return}let n=(0,r.getSegmentationRepresentations)(e)||[];n.forEach(t=>{let{segmentationRepresentationUID:n}=t;(0,i.Z)(a.Z,o.default.SEGMENTATION_REPRESENTATION_MODIFIED,{toolGroupId:e,segmentationRepresentationUID:n})})}function u(e){(e?[e]:(0,r.getSegmentations)().map(({segmentationId:e})=>e)).forEach(e=>{(0,i.Z)(a.Z,o.default.SEGMENTATION_MODIFIED,{segmentationId:e})})}function c(e,t){(0,i.Z)(a.Z,o.default.SEGMENTATION_DATA_MODIFIED,{segmentationId:e,modifiedSlicesToUse:t})}},6645:function(e,t,n){"use strict";var i=n(84725);t.Z=function(e,t){let n=[];if(!t&&!e)throw Error("At least one of renderingEngineId or viewportId should be given");for(let a=0;a<i.ZP.synchronizers.length;a++){let o=i.ZP.synchronizers[a],r=!o.isDisabled(),l=o.hasSourceViewport(t,e),s=o.hasTargetViewport(t,e);r&&(l||s)&&n.push(o)}return n}},21465:function(e,t,n){"use strict";var i=n(84725),a=n(38673);t.Z=function(){let e=[...i.ZP.toolGroups];for(let t of e)(0,a.Z)(t.id);i.ZP.toolGroups=[]}},38673:function(e,t,n){"use strict";var i=n(84725),a=n(15340),o=n(30946);t.Z=function(e){let t=i.ZP.toolGroups.findIndex(t=>t.id===e);t>-1&&(o.ZW.removeToolGroup(e),(0,a.Z)(e),i.ZP.toolGroups.splice(t,1))}},51324:function(e,t,n){"use strict";var i=n(84725);t.Z=function(e){return i.ZP.toolGroups.find(t=>t.id===e)}},3971:function(e,t,n){"use strict";var i=n(84725);t.Z=function(e,t){let n=i.ZP.toolGroups.filter(n=>n.viewportsInfo.some(n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)));if(n.length){if(n.length>1)throw Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only
      have one tool group per viewport in a renderingEngine.`);return n[0]}}},96502:function(e,t,n){"use strict";var i=n(84725),a=n(43286);let o=[a.default.Active,a.default.Passive,a.default.Enabled];t.Z=function(e){return i.ZP.toolGroups.filter(({toolOptions:t})=>{let n=Object.keys(t);for(let i=0;i<n.length;i++)if(e===n[i]){if(!t[e])continue;if(o.includes(t[e].mode))return!0}return!1})}},14507:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var i=n(53323);function a(e,t){let n=[];for(let a=0;a<t.length;a++){let o=t[a];if(!o){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let r=(0,i.getAnnotations)(o.constructor.toolName,e);r?.length&&("function"==typeof o.filterInteractableAnnotationsForElement&&(r=o.filterInteractableAnnotationsForElement(e,r)),r.length>0&&n.push({tool:o,annotations:r}))}return n}},84725:function(e,t,n){"use strict";n.d(t,{ZP:function(){return s},zV:function(){return d},SB:function(){return s}});var i=n(83465),a=n.n(i);let o={};var r=o;let l={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:r,enabledElements:[],handleRadius:6},s={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:r,enabledElements:[],handleRadius:6};function d(){o={},s=a()(l)}},3573:function(e,t,n){"use strict";var i=n(89985),a=n(68287),o=n(53609),r=n(42519),l=n(16502),s=n(1771),d=n(43286);class u{constructor(e,t){let n=i.Z(t,e),{configuration:a={},supportedInteractionTypes:o,toolGroupId:r}=n;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=r,this.supportedInteractionTypes=o||[],this.configuration=Object.assign({},a),this.mode=d.default.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){let{strategies:n,activeStrategy:i}=this.configuration;return n[i].call(this,e,t)}setConfiguration(e){this.configuration=i.Z(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;let t=e.getActors();if(t)return t.find(e=>"vtkVolume"===e.actor.getClassName())?.uid}getTargetIdImage(e,t){if(e.startsWith("imageId:")){let n=e.split("imageId:")[1],i=a.Z(n),r=o.Z(i,t.id);if(!r||!r.length||!(r=r.filter(e=>e.getCurrentImageId()===n))||!r.length)return;return r[0].getImageData()}if(e.startsWith("volumeId:")){let n=e.split("volumeId:")[1],i=r.Z(n,t.id);if(!i||!i.length)return;return i[0].getImageData()}throw Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){if(e instanceof l.Z)return`imageId:${e.getCurrentImageId()}`;if(e instanceof s.Z)return`volumeId:${this.getTargetVolumeId(e)}`;throw Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}u.toolName="BaseTool",t.Z=u},23165:function(e,t,n){"use strict";n.d(t,{Z:function(){return P}});var i=n(57024),a=n(89985),o=n(28186),r=n(20579),l=n(46990),s=n(63008),d=n(51324),u=n(82864),c=n(67241),h=n(4487),f=n(62362),g=n(97908),m=n(48492),v=n(70724),p=h.default.vtkErrorMacro;function C(e,t,n,i){var a;e.set((a=0,t.map(function(e,t){return t===a?(a+=e+1,e):e+n})),i)}var E={outputPointsPrecision:m.XJ.DEFAULT};function _(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object.assign(t,E,n),h.default.setGet(e,t,["outputPointsPrecision"]),h.default.obj(e,t),h.default.algo(e,t,1,1),t.classHierarchy.push("vtkAppendPolyData"),e.requestData=function(n,i){var a=e.getNumberOfInputPorts();if(!a){p("No input specified.");return}if(1===a){i[0]=n[0];return}for(var o=g.ZP.newInstance(),r=0,l=0,s=1,d=1,u=0,h=0,E=0,_=0,T=!0,I=!0,w=!0,b=0;b<a;b++){var S=n[b];if(S){var D=S.getPoints().getNumberOfPoints();r+=D,u+=S.getVerts().getNumberOfValues(),h+=S.getLines().getNumberOfValues(),E+=S.getStrips().getNumberOfValues(),_+=S.getPolys().getNumberOfValues(),D&&(d&&(d=0,l=S.getPoints().getDataType()),l=l>(s=S.getPoints().getDataType())?l:s);var O=S.getPointData();O?(T=T&&null!==O.getNormals(),I=I&&null!==O.getTCoords(),w=w&&null!==O.getScalars()):(T=!1,I=!1,w=!1)}}t.outputPointsPrecision===m.XJ.SINGLE?l=v.Tu.FLOAT:t.outputPointsPrecision===m.XJ.DOUBLE&&(l=v.Tu.DOUBLE);var y=f.ZP.newInstance({dataType:l});y.setNumberOfPoints(r);var M=y.getData(),P=new Uint32Array(u),A=new Uint32Array(h),N=new Uint32Array(E),L=new Uint32Array(_),x=null,Z=null,U=null,k=n[a-1];if(T){var R=k.getPointData().getNormals();x=c.ZP.newInstance({numberOfComponents:3,numberOfTuples:r,size:3*r,dataType:R.getDataType(),name:R.getName()})}if(I){var V=k.getPointData().getTCoords();Z=c.ZP.newInstance({numberOfComponents:2,numberOfTuples:r,size:2*r,dataType:V.getDataType(),name:V.getName()})}if(w){var H=k.getPointData().getScalars();U=c.ZP.newInstance({numberOfComponents:H.getNumberOfComponents(),numberOfTuples:r,size:r*H.getNumberOfComponents(),dataType:H.getDataType(),name:H.getName()})}r=0,u=0,h=0,E=0,_=0;for(var G=0;G<a;G++){var W=n[G];M.set(W.getPoints().getData(),3*r),C(P,W.getVerts().getData(),r,u),u+=W.getVerts().getNumberOfValues(),C(A,W.getLines().getData(),r,h),h+=W.getLines().getNumberOfValues(),C(N,W.getStrips().getData(),r,E),E+=W.getStrips().getNumberOfValues(),C(L,W.getPolys().getData(),r,_),_+=W.getPolys().getNumberOfValues();var B=W.getPointData();if(T){var F=B.getNormals();x.getData().set(F.getData(),3*r)}if(I){var $=B.getTCoords();Z.getData().set($.getData(),2*r)}if(w){var q=B.getScalars();U.getData().set(q.getData(),r*U.getNumberOfComponents())}r+=W.getPoints().getNumberOfPoints()}o.setPoints(y),o.getVerts().setData(P),o.getLines().setData(A),o.getStrips().setData(N),o.getPolys().setData(L),x&&o.getPointData().setNormals(x),Z&&o.getPointData().setTCoords(Z),U&&o.getPointData().setScalars(U),i[0]=o}}var T={newInstance:h.default.newInstance(_,"vtkAppendPolyData"),extend:_},I=n(11905),w=n(91411),b=n(57451),S=n(99750),D=n(13815);function O(e,t,n){let i=e.segmentSpecificConfig?.[t];return(i||(i=e.segmentSpecificConfig?.[n]),i)?i.CONTOUR:null}let y=new Map;var M=function(e,t,n=!1){let i=(0,o.ZP)(e),{viewport:a}=i,r=a.getActors(),l=r.map(({uid:e})=>e.includes(t)?e:void 0).filter(Boolean);a.removeActors(l)},P={render:async function(e,t,n){let{segmentationId:i}=t,a=s.getSegmentation(i),o=a.representationData[r.Z.Contour],{geometryIds:l}=o;l?.length||console.warn(`No contours found for segmentationId ${i}. Skipping render.`),function(e,t,n,i){let{segmentationRepresentationUID:a}=n,o=`CONTOUR_${a}`,r=e.getActor(o);(r?function(e,t,n,i,a){var o,r;let{segmentationRepresentationUID:l,segmentsHidden:s}=n,d=i.representations.CONTOUR,c=y.get(l),h=e.getActor(a);if(!h){console.warn(`No contour actor found for actorUID ${a}. Skipping render.`);return}let{actor:f}=h,g=d.outlineWidthActive;c?.outlineWidthActive!==g&&(f.getProperty().setLineWidth(g),o=Object.assign({},c,{outlineWidthActive:g}),y.set(l,o));let m=f.getMapper(),v=m.getLookupTable(),p=[],C=[];for(let e of s)c.segmentsHidden.has(e)||p.push(e);for(let e of c.segmentsHidden)s.has(e)||C.push(e);let E=Array.from(c.segmentsHidden).filter(e=>!C.includes(e)).concat(p),{contourSets:_,segmentSpecificConfigs:T}=t.reduce((e,t)=>{let i=u.ZP.getGeometry(t),{data:a}=i,o=a.getSegmentIndex(),r=O(n,t,o);return e.contourSets.push(a),e.segmentSpecificConfigs[o]=r??{},e},{contourSets:[],segmentSpecificConfigs:{}}),I=[...E,...C],w=Object.values(T).some(e=>Object.keys(e).length>0),b=!1;if(I.length||w){let e=m.getInputData(),t=e.getPointData().getScalars(),n=t.getData(),i=0;_.forEach(e=>{let t=e.getSegmentIndex(),a=e.getTotalNumberOfPoints();if(I.includes(t)||T[t]?.fillAlpha){let o=e.getColor(),r=E.includes(t)?0:255,l=T[t];void 0!==l.fillAlpha&&(r=255*l.fillAlpha);for(let e=0;e<a;++e)n[i+4*e]=o[0],n[i+4*e+1]=o[1],n[i+4*e+2]=o[2],n[i+4*e+3]=r;b=!0}i+=4*a}),b&&e.modified(),r=Object.assign({},c,{segmentsHidden:new Set(s)}),y.set(l,r),m.setLookupTable(v)}e.render()}:function(e,t,n,i,a){var o;let{segmentationRepresentationUID:r,segmentsHidden:l}=n,s=T.newInstance(),d=new Map,h=new Map;t.forEach(e=>{let t=u.ZP.getGeometry(e);if(!t){console.warn(`No geometry found for geometryId ${e}. Skipping render.`);return}let i=t.data.getSegmentIndex();!function(e){if(!e)throw Error(`No contours found for geometryId ${e.id}`);let t=e.id;if(e.type!==b.Z.CONTOUR)throw Error(`Geometry type ${e.type} not supported for rendering.`);e.data||console.warn(`No contours found for geometryId ${t}. Skipping render.`)}(t);let a=O(n,e,i),o=t.data,r=function(e){let t=[],n=f.ZP.newInstance(),i=D.ZP.newInstance(),a=0;e.getContours().forEach(e=>{let n=e.getPoints(),o=e.getFlatPointsArray(),r=e.getType(),l=n.map((e,t)=>t+a);r===S.Z.CLOSED_PLANAR&&l.push(l[0]);let s=Float32Array.from(o);t.push(...s),i.insertNextCell([...l]),a+=n.length}),n.setData(t,3);let o=g.ZP.newInstance();return o.setPoints(n),o.setLines(i),o}(o),m=o.getColor(),v=r.getPoints().getNumberOfPoints(),p=c.ZP.newInstance({size:4*v,numberOfComponents:4,dataType:"Uint8Array"});for(let e=0;e<v;++e)p.setTuple(e,[...m,255]);r.getPointData().setScalars(p),a&&h.set(i,a),d.set(i,[...m,l.has(i)?0:255]),0===i?s.setInputData(r):s.addInputData(r)});let m=s.getOutputData(),v=i.representations.CONTOUR.outlineWidthActive,p=w.ZP.newInstance();p.setInputData(m);let C=I.ZP.newInstance();C.setMapper(p),C.getProperty().setLineWidth(v),o=Object.assign({},y.get(r),{segmentsHidden:new Set(l),segmentSpecificMap:h,outlineWidthActive:v}),y.set(r,o),C.setForceOpaque(!0),e.addActor({uid:a,actor:C}),e.resetCamera(),e.render()})(e,t,n,i,o)}(e,l,t,n)},addSegmentationRepresentation:async function(e,t,n){let{segmentationId:o}=t,d=i.Z(),u=new Set,c={segmentationId:o,segmentationRepresentationUID:d,type:r.Z.Contour,segmentsHidden:u,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}};if(n){let t=l.i(e),i=a.Z(t,n);l.K0(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return s.addSegmentationRepresentation(e,c),d},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){let n=(0,d.Z)(e);if(void 0===n)throw Error(`ToolGroup with ToolGroupId ${e} does not exist`);let{viewportsInfo:i}=n;for(let e of i){let{viewportId:n,renderingEngineId:i}=e,a=(0,o.O)(n,i);M(a.viewport.element,t)}}(e,t),s.removeSegmentationRepresentation(e,t),y.delete(t),n){let t=(0,d.Z)(e).getViewportsInfo();t.forEach(({viewportId:e,renderingEngineId:t})=>{let n=(0,o.O)(e,t);n.viewport.render()})}}}},14859:function(e,t,n){"use strict";n.d(t,{R:function(){return a}});let i={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85};function a(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}t.Z=function(){return i}},32884:function(e,t,n){"use strict";n.d(t,{Z:function(){return _}});var i=n(37433),a=n(71126),o=n(57024),r=n(89985),l=n(28186),s=n(82864),d=n(20579),u=n(46990),c=n(63008),h=n(51324),f=n(35703),g=n(31270);async function m(e,t,n){let i=(0,l.ZP)(e),{renderingEngine:a,viewport:o}=i,{id:r}=o,s=[{volumeId:t,actorUID:n,visibility:!0,blendMode:f.Z.MAXIMUM_INTENSITY_BLEND}];await (0,g.Z)(a,s,[r],!1,!0)}var v=function(e,t,n=!1){let i=(0,l.ZP)(e),{viewport:a}=i;a.removeVolumeActors([t])};let p=new Map;function C(e,t,n,i){let a={...e,...t,...i||{}},o=n?a.fillAlpha:a.fillAlphaInactive,r=n?a.outlineWidthActive:a.outlineWidthInactive,l=n?a.renderFill:a.renderFillInactive,s=a.renderOutline,d=n?a.outlineOpacity:a.outlineOpacityInactive;return{fillAlpha:o,outlineWidth:r,renderFill:l,renderOutline:s,outlineOpacity:d}}async function E(e,t,n){await m(e.element,t,n)}var _={render:async function(e,t,n){let{colorLUTIndex:i,active:a,segmentationId:o,segmentationRepresentationUID:r,segmentsHidden:l,config:u}=t,h=c.getSegmentation(o),f=h.representationData[d.Z.Labelmap],{volumeId:g}=f,m=s.ZP.getVolume(g);if(!m)throw Error(`No Labelmap found for volumeId: ${g}`);if(!function(e,t){if(!t)return!0;let n=e.getDefaultActor();if(!n)return!1;let{uid:i}=n,a=s.ZP.getVolume(i);if(a){let e=s.ZP.getVolume(t);if(e&&a.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,f?.referencedVolumeId))return;let v=e.getActor(r);if(!v){let t=c.getSegmentation(o),{volumeId:n}=t.representationData[d.Z.Labelmap];await E(e,n,r),v=e.getActor(r)}if(!v)return;let{cfun:_,ofun:T}=u,I=n.renderInactiveSegmentations;!function(e,t,n,i,a,o,r,l,s,u){let{segmentSpecificConfig:h,segmentationRepresentationSpecificConfig:f}=r,g=f[d.Z.Labelmap],m=c.getColorLUT(a),v=Math.min(256,m.length),E=t.actor,{uid:_}=t,{outlineWidth:T,renderOutline:I,outlineOpacity:w}=C(o,g,l);for(let t=0;t<v;t++){let a=t,r=m[a],s=h[a]?.[d.Z.Labelmap],{fillAlpha:c,outlineWidth:f,renderFill:v,renderOutline:E}=C(o,g,l,s),{forceOpacityUpdate:T,forceColorUpdate:I}=function(e,t,n,{fillAlpha:i,renderFill:a,renderOutline:o,segmentColor:r,outlineWidth:l,segmentsHidden:s}){let d=`${e}-${t}-${n}`,u=p.get(d);if(!u)return p.set(d,{fillAlpha:i,renderFill:a,renderOutline:o,outlineWidth:l,segmentColor:r,segmentsHidden:new Set(s)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};let{fillAlpha:c,renderFill:h,renderOutline:f,outlineWidth:g,segmentColor:m,segmentsHidden:v}=u,C=m[0]!==r[0]||m[1]!==r[1]||m[2]!==r[2],E=m[3]!==r[3]||c!==i||h!==a||f!==o||g!==l||v.has(n)!==s.has(n);return p.set(d,{fillAlpha:i,renderFill:a,renderOutline:o,outlineWidth:l,segmentColor:r.slice(),segmentsHidden:new Set(s)}),{forceOpacityUpdate:E,forceColorUpdate:C}}(e,_,a,{fillAlpha:c,renderFill:v,renderOutline:E,segmentColor:r,outlineWidth:f,segmentsHidden:u});if(I&&n.addRGBPoint(a,r[0]/255,r[1]/255,r[2]/255),T){if(v){let e=u.has(a)?0:r[3]/255*c;i.removePoint(a),i.addPointLong(a,e,.5,1)}else i.addPointLong(a,.01,.5,1)}}E.getProperty().setRGBTransferFunction(0,n),i.setClamping(!1),E.getProperty().setScalarOpacity(0,i),E.getProperty().setInterpolationTypeToNearest(),E.getProperty().setUseLabelOutline(I),E.getProperty().setLabelOutlineOpacity(w),E.getProperty().setLabelOutlineThickness(T);let b=l||s;E.setVisibility(b)}(e.id,v,_,T,i,n.representations[d.Z.Labelmap],t,a,I,l)},addSegmentationRepresentation:async function(e,t,n){let{segmentationId:l}=t,s=o.Z(),h=new Set,f=a.ZP.newInstance(),g=i.ZP.newInstance();g.addPoint(0,0);let m={segmentationId:l,segmentationRepresentationUID:s,type:d.Z.Labelmap,segmentsHidden:h,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:f,ofun:g}};if(n){let t=u.i(e),i=r.Z(t,n);u.K0(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return c.addSegmentationRepresentation(e,m),s},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){let n=(0,h.Z)(e);if(void 0===n)throw Error(`ToolGroup with ToolGroupId ${e} does not exist`);let{viewportsInfo:i}=n;for(let e of i){let{viewportId:n,renderingEngineId:i}=e,a=(0,l.O)(n,i);v(a.viewport.element,t)}}(e,t),c.removeSegmentationRepresentation(e,t),n){let t=(0,h.Z)(e).getViewportsInfo();t.forEach(({viewportId:e,renderingEngineId:t})=>{let n=(0,l.O)(e,t);n.viewport.render()})}}}},7419:function(e,t,n){"use strict";var i=n(28186),a=n(89985),o=n(20579),r=n(46990),l=n(70359),s=n(63008),d=n(51324),u=n(3573),c=n(23165),h=n(32884);class f extends u.Z{constructor(e={},t={configuration:{}}){super(e,t),this.renderSegmentation=e=>{let t=(0,d.Z)(e);if(!t)return;let n=(0,s.getSegmentationRepresentations)(e);if(!n||0===n.length)return;let a=t.viewportsInfo.map(({renderingEngineId:e,viewportId:t})=>{let n=(0,i.O)(t,e);if(n)return n.viewport}),r=n.map(t=>{let n=this._getMergedRepresentationsConfig(e),i=[];for(let e of a)t.type==o.Z.Labelmap?i.push(h.Z.render(e,t,n)):t.type==o.Z.Contour&&i.push(c.Z.render(e,t,n));return i});Promise.allSettled(r).then(()=>{a.forEach(e=>{e.render()})})}}onSetToolEnabled(){let e=this.toolGroupId,t=(0,s.getSegmentationRepresentations)(e);t&&0!==t.length&&t.forEach(t=>{(0,l.setSegmentationVisibility)(e,t.segmentationRepresentationUID,!0)})}onSetToolDisabled(){let e=this.toolGroupId,t=(0,s.getSegmentationRepresentations)(e);t&&0!==t.length&&t.forEach(t=>{(0,l.setSegmentationVisibility)(e,t.segmentationRepresentationUID,!1)})}_getMergedRepresentationsConfig(e){let t=r.i(e),n=r.Hi(),i=a.Z(n,t);return i}}f.toolName="SegmentationDisplay",t.Z=f},76007:function(e,t,n){"use strict";n.d(t,{Z:function(){return o}});var i=n(3971),a=n(28186);function o(e,t){let n=(0,a.ZP)(e),{renderingEngineId:o,viewportId:r}=n,l=i.Z(r,o);if(!l)return[];let s=[],d=Object.keys(l.toolOptions);for(let e=0;e<d.length;e++){let n=d[e],i=l.toolOptions[n];if(i&&t.includes(i.mode)){let e=l.getToolInstance(n);s.push(e)}}return s}},30946:function(e,t,n){"use strict";n.d(t,{ZW:function(){return c},ih:function(){return h}});var i=n(6606),a=n(39040),o=n(818),r=n(74880),l=n(11130),s=n(51324),d=n(3971),u=n(7419);let c=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();let e=Array.from(this._needsRender.values());for(let t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size){this._animationFrameSet=!1,this._animationFrameHandle=null;return}}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach(e=>{this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){let t=(0,s.Z)(e);if(!t){console.warn(`No tool group found with toolGroupId: ${e}`);return}let{viewportsInfo:n}=t,c=[];n.forEach(({viewportId:e,renderingEngineId:t})=>{let n=(0,i.Pr)(t);if(!n){console.warn("rendering Engine has been destroyed");return}c.push(n.getViewport(e))});let h=t.getToolInstance(u.Z.toolName);if(!h){console.warn("No segmentation tool found inside",e);return}function f(e){let{element:t,viewportId:n,renderingEngineId:i}=e.detail;t.removeEventListener(a.default.IMAGE_RENDERED,f);let s=(0,d.Z)(n,i);if(!s){console.warn("toolGroup has been destroyed");return}let u={toolGroupId:s.id,viewportId:n};(0,o.Z)(r.Z,l.default.SEGMENTATION_RENDERED,{...u})}c.forEach(({element:e})=>{e.addEventListener(a.default.IMAGE_RENDERED,f)}),h.renderSegmentation(e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function h(e){c.renderToolGroupSegmentations(e)}t.ZP=h},40833:function(e,t,n){"use strict";function i(e,t){var n,i;let a=d(e),o=d(t);return{page:c(a.page,o.page),client:c(a.client,o.client),canvas:c(a.canvas,o.canvas),world:(n=a.world,i=o.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])}}function a(e,t){let n=d(e),i=d(t);return{page:f(n.page,i.page),client:f(n.client,i.client),canvas:f(n.canvas,i.canvas),world:g(n.world,i.world)}}function o(e,t){}function r(e,t){let n=h(e),i=h(t),a={page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world};return a}function l(e){return JSON.parse(JSON.stringify(e))}function s(e){return JSON.parse(JSON.stringify(e))}function d(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function u(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function c(e,t){return[e[0]-t[0],e[1]-t[1]]}function h(e){let t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:f(e[n].page,e[i].page),client:f(e[n].client,e[i].client),canvas:f(e[n].canvas,e[i].canvas),world:g(e[n].world,e[i].world)});return t.reduce((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}),{page:0,client:0,canvas:0,world:0})}function f(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function g(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}n.r(t),n.d(t,{copyPoints:function(){return s},copyPointsList:function(){return l},getDeltaDistance:function(){return a},getDeltaDistanceBetweenIPoints:function(){return r},getDeltaPoints:function(){return i},getDeltaRotation:function(){return o},getMeanPoints:function(){return d},getMeanTouchPoints:function(){return u}})},94268:function(e,t,n){"use strict";n.d(t,{Ar:function(){return f}});var i=n(28186),a=n(6606),o=n(818),r=n(43286),l=n(11130),s=n(56532),d=n(76007);let{Active:u,Passive:c,Enabled:h}=r.default,f=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();let e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){let n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size)){this._animationFrameSet=!1,this._animationFrameHandle=null;return}}},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){let e=[...this._viewportElements.values()];e.forEach(e=>{this._needsRender.add(e)}),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){let t=[...this._viewportElements.values()];e.forEach(e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){let t=(0,i.ZP)(e);if(!t){console.warn("Element has been disabled");return}let n=(0,a.Pr)(t.renderingEngineId);if(!n){console.warn("rendering Engine has been destroyed");return}let r=(0,d.Z)(e,[u,c,h]),{renderingEngineId:f,viewportId:g}=t,m={element:e,renderingEngineId:f,viewportId:g};(0,s.Z)(e,n=>{let i=!1;r.forEach(e=>{if(e.renderAnnotation){let a=e.renderAnnotation(t,n);i=i||a}}),i&&(0,o.Z)(e,l.default.ANNOTATION_RENDERED,{...m})})}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};t.ZP=function(e){f.renderViewport(e)}},76056:function(e,t,n){"use strict";var i=n(94268);t.Z=function(e,t){t.length&&t.forEach(t=>{let{element:n}=e.getViewport(t);(0,i.ZP)(n)})}},29208:function(e,t,n){var i,a="__lodash_hash_undefined__",o=1/0,r=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,l=/^\w*$/,s=/^\./,d=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,u=/\\(\\)?/g,c=/^\[object .+?Constructor\]$/,h="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,f="object"==typeof self&&self&&self.Object===Object&&self,g=h||f||Function("return this")(),m=Array.prototype,v=Function.prototype,p=Object.prototype,C=g["__core-js_shared__"],E=(i=/[^.]+$/.exec(C&&C.keys&&C.keys.IE_PROTO||""))?"Symbol(src)_1."+i:"",_=v.toString,T=p.hasOwnProperty,I=p.toString,w=RegExp("^"+_.call(T).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=g.Symbol,S=m.splice,D=Z(g,"Map"),O=Z(Object,"create"),y=b?b.prototype:void 0,M=y?y.toString:void 0;function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function A(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function N(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}function L(e,t){for(var n,i=e.length;i--;)if((n=e[i][0])===t||n!=n&&t!=t)return i;return -1}function x(e,t){var n,i=e.__data__;return("string"==(n=typeof t)||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==t:null===t)?i["string"==typeof t?"string":"hash"]:i.map}function Z(e,t){var n,i=null==e?void 0:e[t];return!(!V(i)||E&&E in i)&&("[object Function]"==(n=V(i)?I.call(i):"")||"[object GeneratorFunction]"==n||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(i)?w:c).test(function(e){if(null!=e){try{return _.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(i))?i:void 0}P.prototype.clear=function(){this.__data__=O?O(null):{}},P.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},P.prototype.get=function(e){var t=this.__data__;if(O){var n=t[e];return n===a?void 0:n}return T.call(t,e)?t[e]:void 0},P.prototype.has=function(e){var t=this.__data__;return O?void 0!==t[e]:T.call(t,e)},P.prototype.set=function(e,t){return this.__data__[e]=O&&void 0===t?a:t,this},A.prototype.clear=function(){this.__data__=[]},A.prototype.delete=function(e){var t=this.__data__,n=L(t,e);return!(n<0)&&(n==t.length-1?t.pop():S.call(t,n,1),!0)},A.prototype.get=function(e){var t=this.__data__,n=L(t,e);return n<0?void 0:t[n][1]},A.prototype.has=function(e){return L(this.__data__,e)>-1},A.prototype.set=function(e,t){var n=this.__data__,i=L(n,e);return i<0?n.push([e,t]):n[i][1]=t,this},N.prototype.clear=function(){this.__data__={hash:new P,map:new(D||A),string:new P}},N.prototype.delete=function(e){return x(this,e).delete(e)},N.prototype.get=function(e){return x(this,e).get(e)},N.prototype.has=function(e){return x(this,e).has(e)},N.prototype.set=function(e,t){return x(this,e).set(e,t),this};var U=k(function(e){e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(H(e))return M?M.call(e):"";var t=e+"";return"0"==t&&1/e==-o?"-0":t}(t);var t,n=[];return s.test(e)&&n.push(""),e.replace(d,function(e,t,i,a){n.push(i?a.replace(u,"$1"):t||e)}),n});function k(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw TypeError("Expected a function");var n=function(){var i=arguments,a=t?t.apply(this,i):i[0],o=n.cache;if(o.has(a))return o.get(a);var r=e.apply(this,i);return n.cache=o.set(a,r),r};return n.cache=new(k.Cache||N),n}k.Cache=N;var R=Array.isArray;function V(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function H(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==I.call(e)}e.exports=function(e,t,n){var i=null==e?void 0:function(e,t){var n;t=!function(e,t){if(R(e))return!1;var n=typeof e;return!!("number"==n||"symbol"==n||"boolean"==n||null==e||H(e))||l.test(e)||!r.test(e)||null!=t&&e in Object(t)}(t,e)?R(n=t)?n:U(n):[t];for(var i=0,a=t.length;null!=e&&i<a;)e=e[function(e){if("string"==typeof e||H(e))return e;var t=e+"";return"0"==t&&1/e==-o?"-0":t}(t[i++])];return i&&i==a?e:void 0}(e,t);return void 0===i?n:i}}}]);